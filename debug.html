<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ã‚²ãƒ¤ãƒã‚¯ãƒ©ãƒ–(DEBUG)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <style>
    /* --- CSS (index.htmlã¨å®Œå…¨ã«åŒä¸€) --- */
    :root { --primary: #06c755; --bg: #f2f4f8; --card: #ffffff; --text: #333; --danger: #e53935; --gray: #888; --accent: #ff9800; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; }
    .container { max-width: 600px; margin: 0 auto; padding: 15px; }
    .view-section { display: none; }
    .view-active { display: block; animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .card { background: var(--card); padding: 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-bottom: 16px; }
    h2 { font-size: 1.1rem; margin: 0 0 10px; border-bottom: 2px solid var(--primary); padding-bottom: 5px; display: inline-block; }
    h3 { font-size: 1rem; margin: 15px 0 8px; font-weight: bold; color: #444; }
    .muted { color: var(--gray); font-size: 0.85rem; line-height: 1.4; }
    .small { font-size: 0.8rem; }
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .shuttle-img { width: 80px; height: auto; animation: bounce 1s infinite alternate ease-in-out; }
    @keyframes bounce { 0% { transform: translateY(0); } 100% { transform: translateY(-30px); } }
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
    .nav-item { flex: 1; text-align: center; padding: 8px 0; font-size: 0.65rem; color: var(--gray); cursor: pointer; }
    .nav-item.active { color: var(--primary); font-weight: bold; }
    .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 2px; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; font-size: 1rem; background: #fff; }
    button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 8px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 8px 12px; font-size: 0.9rem; }
    .btn-copy { padding: 6px 10px; font-size: 0.8rem; width: auto; margin: 0 0 0 8px; display: inline-block; }
    .btn-sm { width: auto; padding: 6px 12px; font-size: 0.8rem; margin: 0; border-radius: 4px; }
    .admin-list-item { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; padding: 12px 0; }
    .admin-item-left { flex: 1; display: flex; align-items: center; overflow: hidden; margin-right: 10px; min-width: 0; }
    .admin-item-left label { display: flex; align-items: center; width: 100%; cursor: pointer; }
    .admin-item-left input { width: 24px; height: 24px; margin: 0 10px 0 0; flex-shrink: 0; }
    .admin-name { font-weight: bold; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; flex: 1; }
    .admin-item-right { flex: 0 0 auto; display: flex; align-items: center; justify-content: flex-end; }
    .status-select { padding: 4px 8px; margin: 0; font-size: 0.85rem; width: auto; height: 32px; background: #fff; }
    .pay-icon { font-size: 0.65rem; padding: 3px 6px; border-radius: 3px; margin-right: 6px; font-weight: bold; cursor: pointer; user-select: none; border: 1px solid rgba(0,0,0,0.1); }
    .pay-icon.pp { background: #ffeb3b; color: #333; }
    .pay-icon.cash { background: #e0e0e0; color: #555; }
    .pay-status { font-size: 0.8rem; color: #666; white-space: nowrap; width: 30px; text-align: right; }
    .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
    .admin-menu-btn { background: #fff; border: 1px solid #eee; padding: 20px; text-align: center; border-radius: 12px; cursor: pointer; user-select: none; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: background 0.1s; }
    .admin-menu-btn:active { background: #f0f0f0; transform: scale(0.98); }
    .admin-icon { font-size: 2rem; display: block; margin-bottom: 8px; }
    .admin-label { font-weight: bold; color: #555; }
    .guest-row { display: flex; gap: 5px; margin-bottom: 5px; }
    .guest-row input { flex: 2; }
    .guest-row select { flex: 1; font-size: 0.85rem; padding: 8px 4px; }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
    .bg-green { background: #e8f5e9; color: #2e7d32; }
    .bg-gray { background: #eee; color: #666; }
    .paypay-box { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; border: 1px solid #eee; }
    .step-list { padding-left: 20px; margin: 5px 0 10px; font-size: 0.85rem; color: #444; line-height: 1.6; }
    .member-list-chip { display: inline-block; background: #e0f2f1; color: #00695c; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; margin: 2px; }
    .paid-row { opacity: 0.5; }
    input[type="checkbox"], input[type="radio"] { width: 22px; height: 22px; margin: 0 8px 0 0; vertical-align: middle; }
    .inline-label { display: flex; align-items: center; width: 100%; cursor: pointer; margin-bottom: 12px; padding: 5px 0; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: left; }
    .rank-1 { color: #d4af37; font-weight: bold; }
    .court-box { background: #e8f5e9; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #c8e6c9; text-align: center; }
    .court-name { font-weight: bold; color: var(--primary); font-size: 1.1rem; margin-bottom: 8px; display: block; }
    .match-pair { font-size: 1.2rem; font-weight: bold; color: #333; margin: 5px 0; }
    .past-item { background: #f9f9f9; padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.1s; }
    .past-item:active { background: #e0e0e0; transform: scale(0.98); }
    .past-arrow { font-weight: bold; color: #ccc; }
    #restrictedMsg { text-align: center; padding: 40px 0; color: #888; }
    #demoRibbon { position:fixed; top:0; left:0; right:0; background:#d9534f; color:white; font-size:0.75rem; text-align:center; padding:4px; z-index:10000; font-weight:bold; }
    .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1500; display:none; justify-content:center; align-items:center; }
    .modal { background:#fff; padding:20px; border-radius:12px; width:90%; max-width:400px; max-height:85%; overflow-y:auto; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div id="loading">
    <img src="fig/shuttle.png" class="shuttle-img" onerror="this.style.display='none';">
    <div style="margin-top:15px; font-weight:bold; color:#06c755;">Debug Loading...</div>
  </div>

  <div id="infoModal" class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><h3 id="modalTitle">è©³ç´°</h3><div id="modalContent"></div><button class="btn-outline" onclick="closeModal()" style="margin-top:15px; width:100%;">é–‰ã˜ã‚‹</button></div></div>

  <div id="app" style="display:none;">
    <div class="container">
      <div id="view-register" class="view-section">
        <div class="card">
          <h2>ä»Šé€±ã®ç·´ç¿’</h2>
          <div id="thisWeekInfo"></div>
          <div id="regFormArea" style="display:none; margin-top:15px;">
            <div id="regStatusBadge" class="badge bg-gray" style="display:inline-block; margin-bottom:10px;">æœªç™»éŒ²</div>
            <div style="margin-bottom:15px; font-size:0.9rem;">
              <span class="muted">ç¾åœ¨ã®å‚åŠ è€…:</span> <span id="currentParticipantsCount">2</span>å<br>
              <div id="regMembersList" style="margin-top:5px; font-size:0.8rem;">
                <span class="member-list-chip">ã¯ã‚Šã</span><span class="member-list-chip">ãƒ¡ãƒ³ãƒãƒ¼A</span>
              </div>
            </div>
            <form id="regForm">
              <label class="inline-label"><input type="checkbox" id="friendToggle" onchange="toggleGuests()"><span>å‹é”ã‚’é€£ã‚Œã¦ã„ã</span></label>
              
              <div id="guestSection" style="display:none; background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:10px;">
                <label>äººæ•°: <input type="number" id="guestCount" min="0" max="5" value="0" onchange="renderGuestInputs()"></label>
                <div id="guestInputs"></div> <div class="small muted" style="margin-top:10px; color:#c62828;"><strong>ã€å‹é”åˆ†ã®æ”¯æ‰•ã„ã€‘</strong> å‹é”ã®åˆ†ã¯ã€Œå½“æ—¥ ç¾é‡‘ã€ã¾ãŸã¯ã€Œå½“æ—¥ PayPayã€ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚</div>
              </div>

              <div id="feeDisplay" style="text-align:center; font-weight:bold; color:var(--primary); margin:15px 0;">æ”¯æ‰•é‡‘é¡: - å††</div>
              
              <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px;">
                <h3 style="margin-top:0;">ãŠæ”¯æ‰•ã„æ–¹æ³• (æœ¬äººåˆ†)</h3>
                <p class="small muted" style="margin-top:0; color:#06c755; font-weight:bold;">â€»é‹å–¶ã®è² æ‹…è»½æ¸›ã®ãŸã‚ã€PayPayäº‹å‰æ±ºæ¸ˆã«ã”å”åŠ›ãã ã•ã„ğŸ™‡â€â™‚ï¸</p>
                <label class="inline-label"><input type="radio" name="payMethod" value="advance" onchange="togglePayMethod()"><span>äº‹å‰PayPayæ±ºæ¸ˆ</span></label>
                <div id="payDetail-advance" style="display:none; margin-left:10px; margin-bottom:15px;">
                   <div class="paypay-box">
                     <strong>&lt;æ‰‹é †&gt;</strong><ol class="step-list"><li>ä¸‹è¨˜ <strong>ID</strong> ã‚’ã‚³ãƒ”ãƒ¼</li><li>PayPayã‚¢ãƒ—ãƒª > é€ã‚‹ > IDã§é€ã‚‹</li><li>IDè²¼ã‚Šä»˜ã‘ > æ¤œç´¢</li><li>åç¾©ãŒ <strong class="ppNameTarget">-</strong> ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª</li><li>é‡‘é¡å…¥åŠ›</li><li>ä¸‹è¨˜ã®ãƒ¡ãƒ¢ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è²¼ã‚Šä»˜ã‘ã¦é€é‡‘</li><li>é€é‡‘å¾Œã€ä¸‹ã®ã€Œé€é‡‘ã—ã¾ã—ãŸã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹</li></ol>
                     <div>ID: <span class="ppId" style="font-weight:bold;">-</span> <button type="button" class="btn-outline btn-copy" onclick="copyText('ppId')">ã‚³ãƒ”ãƒ¼</button></div>
                     <div style="margin-top:8px; display:flex;"><input type="text" id="ppMsg" readonly style="margin:0; font-size:0.8rem; background:#fff; flex:1;"><button type="button" class="btn-outline btn-copy" onclick="copyText('ppMsg')">ãƒ¡ãƒ¢ã‚³ãƒ”ãƒ¼</button></div>
                   </div>
                   <label class="inline-label" style="margin-top:10px; color:var(--primary); font-weight:bold;"><input type="checkbox" id="chkPaidAdvance"> é€é‡‘ã—ã¾ã—ãŸ</label>
                </div>
                <label class="inline-label"><input type="radio" name="payMethod" value="day_paypay" onchange="togglePayMethod()"><span>å½“æ—¥PayPayæ”¯æ‰•ã„</span></label>
                <label class="inline-label"><input type="radio" name="payMethod" value="day_cash" onchange="togglePayMethod()"><span>å½“æ—¥ç¾é‡‘æ”¯æ‰•ã„</span></label>
              </div>
              <button type="button" id="btnRegister" class="btn-primary" onclick="submitRegistration()">å‚åŠ ç™»éŒ²ã™ã‚‹</button>
              <button type="button" id="btnCancel" class="btn-danger" style="display:none;" onclick="cancelRegistration()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </form>
          </div>
        </div>
      </div>

      <div id="view-day" class="view-section">
        <div id="dayContent" style="display:block;">
          <div id="subAdminArea" style="display:block;">
            <div class="card" style="border-left: 5px solid var(--danger);">
              <h3 style="color:var(--danger); margin:0 0 10px;">é‹å–¶: æŠ½é¸</h3>
              <div id="adminLotteryList"></div>
              <div style="margin-top:15px; display:flex; gap:10px;">
                <button class="btn-outline btn-sm" onclick="alert('ãƒ‡ãƒãƒƒã‚°ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ')">+ è¿½åŠ </button>
                <button class="btn-danger" style="flex:1; margin:0;" onclick="executeLottery()">æŠ½é¸å®Ÿè¡Œ</button>
              </div>
            </div>
          </div>
          <div class="card"><h2>æœ¬æ—¥ã®ç·´ç¿’</h2><div id="dayLotteryResult"><p>æŠ½é¸çµæœã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p></div></div>
        </div>
      </div>

      <div id="view-mypage" class="view-section">
        <div class="card">
          <h2>è¨­å®š</h2>
          <label>è¡¨ç¤ºå</label><input type="text" id="myName" value="ã¯ã‚Šã">
          <label>åŒºåˆ†</label><select id="myCat"><option value="adult" selected>ç¤¾ä¼šäºº</option><option value="college">å¤§å­¦ç”Ÿ</option></select>
          <button class="btn-primary" onclick="alert('ãƒ‡ãƒãƒƒã‚°ï¼šä¿å­˜å®Œäº†')">ä¿å­˜ã™ã‚‹</button>
        </div>
      </div>
    </div>

    <div class="bottom-nav">
      <div class="nav-item active" onclick="navigateTo('register')" id="nav-register"><span class="nav-icon">ğŸ“…</span>ç™»éŒ²</div>
      <div class="nav-item" onclick="navigateTo('day')" id="nav-day"><span class="nav-icon">ğŸ¸</span>å½“æ—¥</div>
      <div class="nav-item" onclick="navigateTo('mypage')" id="nav-mypage"><span class="nav-icon">ğŸ‘¤</span>ãƒã‚¤ãƒšãƒ¼ã‚¸</div>
    </div>
  </div>

  <script>
    const LIFF_ID = '2008652596-Gew4K44V';
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæœ¬ç•ªã¨åŒã˜æ§‹é€ ï¼‰
    let state = {
      me: { member_id: 'm1', display_name: 'ã¯ã‚Šã', category: 'adult', role: 'admin' },
      paypay: { id: 'geyama_hariku', receiver: 'ã‚²ãƒ¤ãƒã‚¯ãƒ©ãƒ–(æ©‹æœ¬é™¸)' },
      event: { event_id: 'e1', date_str: '2026-01-11 (æ—¥)', start_time: '18:30', end_time: '21:00' },
      reg: null,
      feeConfig: { adult: 800, college: 600, student: 500 }
    };

    // â˜…ã€Œãƒ‹ãƒ§ã‚­ãƒƒã€ã‚’å†ç¾ã™ã‚‹é–¢æ•° 
    window.toggleGuests = function() {
      const on = document.getElementById('friendToggle').checked;
      document.getElementById('guestSection').style.display = on ? 'block' : 'none';
      if (on && document.getElementById('guestCount').value == 0) {
        document.getElementById('guestCount').value = 1;
        renderGuestInputs();
      }
      calcTotal();
    };

    window.renderGuestInputs = function() {
      const cnt = document.getElementById('guestCount').value;
      const box = document.getElementById('guestInputs');
      box.innerHTML = '';
      for (let i = 0; i < cnt; i++) {
        box.innerHTML += `
          <div class="guest-row" style="margin-top:10px;">
            <input type="text" class="g-name" placeholder="å‹é”ã®åå‰" required>
            <select class="g-cat" onchange="calcTotal()">
              <option value="adult">ç¤¾ä¼šäºº</option>
              <option value="college">å¤§å­¦ç”Ÿ</option>
              <option value="student">é«˜æ ¡ç”Ÿ</option>
            </select>
          </div>`;
      }
      calcTotal();
    };

    // é‡‘é¡è¨ˆç®—ï¼ˆæœ¬äºº + å‹é”å…¨å“¡åˆ†ï¼‰
    window.calcTotal = function() {
      let total = state.feeConfig[state.me.category] || 800;
      // å‹é”åˆ†ã®è¨ˆç®—
      if (document.getElementById('friendToggle').checked) {
        const guestCats = document.querySelectorAll('.g-cat');
        guestCats.forEach(sel => {
          total += (state.feeConfig[sel.value] || 800);
        });
      }
      document.getElementById('feeDisplay').innerText = `æ”¯æ‰•é‡‘é¡(åˆè¨ˆ): ${total} å††`;
    };

    // ç™»éŒ²ãƒœã‚¿ãƒ³ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
    window.submitRegistration = function() {
      const method = document.querySelector('input[name="payMethod"]:checked')?.value;
      if (!method) return alert('æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„');
      
      const guests = [];
      if(document.getElementById('friendToggle').checked) {
        document.querySelectorAll('.g-name').forEach((el, i) => {
          guests.push(el.value || `å‹é”${i+1}`);
        });
      }

      if (confirm(`ã€ãƒ‡ãƒãƒƒã‚°ã€‘ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\næœ¬äººï¼šã¯ã‚Šã\nå‹é”ï¼š${guests.join(', ') || 'ãªã—'}\næ”¯æ‰•ï¼š${method}`)) {
        document.getElementById('loading').style.display = 'flex';
        setTimeout(() => {
          alert('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼(æ’®å½±ç”¨)');
          state.reg = { status: 'reserved', payment_method: method };
          renderRegStatus();
          document.getElementById('loading').style.display = 'none';
        }, 800);
      }
    };

    // UIçŠ¶æ…‹ã®æ›´æ–°
    function renderRegStatus() {
      const badge = document.getElementById('regStatusBadge');
      const btnReg = document.getElementById('btnRegister');
      const btnCancel = document.getElementById('btnCancel');
      if (state.reg && state.reg.status === 'reserved') {
        badge.innerText = 'å‚åŠ ç™»éŒ²æ¸ˆ'; badge.className = 'badge bg-green';
        btnReg.innerText = 'ç™»éŒ²æ›´æ–°'; btnCancel.style.display = 'inline-block';
      } else {
        badge.innerText = 'æœªç™»éŒ²'; badge.className = 'badge bg-gray';
        btnReg.innerText = 'å‚åŠ ç™»éŒ²'; btnCancel.style.display = 'none';
      }
    }

    // å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    function navigateTo(viewId) {
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('view-active'));
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      document.getElementById('view-' + viewId).classList.add('view-active');
      const navId = 'nav-' + viewId;
      if(document.getElementById(navId)) document.getElementById(navId).classList.add('active');
    }

    window.togglePayMethod = function() {
      const val = document.querySelector('input[name="payMethod"]:checked')?.value;
      document.getElementById('payDetail-advance').style.display = (val === 'advance') ? 'block' : 'none';
    };

    window.copyText = function(id) {
      const el = document.querySelector('.'+id) || document.getElementById(id);
      const t = el.tagName === 'INPUT' ? el.value : el.innerText;
      alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: ' + t);
    };

    window.executeLottery = function() {
      alert('æŠ½é¸ã‚’å®Ÿè¡Œã—ã¾ã™...');
      document.getElementById('dayLotteryResult').innerHTML = `
        <div class="court-box"><span class="court-name">ç¬¬1ã‚³ãƒ¼ãƒˆ</span>
          <div class="match-pair">ã¯ã‚Šã / ãƒ¡ãƒ³ãƒãƒ¼A</div>
          <div class="match-pair" style="font-size:0.9rem;">vs</div>
          <div class="match-pair">å‹é”1 / ãƒ¡ãƒ³ãƒãƒ¼B</div>
        </div>`;
    };

    // åˆæœŸåŒ–
    window.onload = async function() {
      try { await liff.init({ liffId: LIFF_ID }); } catch(e) {}
      
      // PayPayæƒ…å ±åæ˜ 
      document.querySelectorAll('.ppId').forEach(e => e.innerText = state.paypay.id);
      document.querySelectorAll('.ppNameTarget').forEach(e => e.innerText = state.paypay.receiver);
      document.getElementById('ppMsg').value = `${state.event.date_str} ã¯ã‚Šã`;
      
      // ç·´ç¿’æƒ…å ±åæ˜ 
      document.getElementById('thisWeekInfo').innerHTML = `<div>${state.event.date_str} ${state.event.start_time}-${state.event.end_time}</div>`;
      document.getElementById('regFormArea').style.display = 'block';
      
      calcTotal();
      document.getElementById('loading').style.display = 'none';
      document.getElementById('app').style.display = 'block';
    };
  </script>
</body>
</html>


