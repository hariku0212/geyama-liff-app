<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ã‚²ãƒ¤ãƒã‚¯ãƒ©ãƒ–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta property="og:title" content="ã‚²ãƒ¤ãƒã‚¯ãƒ©ãƒ–ã‚¢ãƒ—ãƒª">
  <meta property="og:description" content="ç·´ç¿’ã®å‚åŠ ç™»éŒ²ã€PayPayæ”¯æ‰•ã„ã€ã‚³ãƒ¼ãƒˆæŠ½é¸ãªã©ãŒã§ãã‚‹ã‚¢ãƒ—ãƒªã§ã™ã€‚">
  <meta property="og:type" content="website">
  <style>
    /* --- CSS (index.htmlã¨å®Œå…¨ã«åŒä¸€) --- */
    :root { --primary: #06c755; --bg: #f2f4f8; --card: #ffffff; --text: #333; --danger: #e53935; --gray: #888; --accent: #ff9800; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; }
    .container { max-width: 600px; margin: 0 auto; padding: 15px; }
    .view-section { display: none; }
    .view-active { display: block; animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .card { background: var(--card); padding: 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-bottom: 16px; }
    h2 { font-size: 1.1rem; margin: 0 0 10px; border-bottom: 2px solid var(--primary); padding-bottom: 5px; display: inline-block; }
    h3 { font-size: 1rem; margin: 15px 0 8px; font-weight: bold; color: #444; }
    .muted { color: var(--gray); font-size: 0.85rem; line-height: 1.4; }
    .small { font-size: 0.8rem; }
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .shuttle-img { width: 80px; height: auto; animation: bounce 1s infinite alternate ease-in-out; }
    @keyframes bounce { 0% { transform: translateY(0); } 100% { transform: translateY(-30px); } }
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
    .nav-item { flex: 1; text-align: center; padding: 8px 0; font-size: 0.65rem; color: var(--gray); cursor: pointer; }
    .nav-item.active { color: var(--primary); font-weight: bold; }
    .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 2px; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; font-size: 1rem; background: #fff; }
    button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 8px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 8px 12px; font-size: 0.9rem; }
    .btn-copy { padding: 6px 10px; font-size: 0.8rem; width: auto; margin: 0 0 0 8px; display: inline-block; }
    .btn-sm { width: auto; padding: 6px 12px; font-size: 0.8rem; margin: 0; border-radius: 4px; }
    .admin-list-item { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; padding: 12px 0; }
    .admin-item-left { flex: 1; display: flex; align-items: center; overflow: hidden; margin-right: 10px; min-width: 0; }
    .admin-item-left label { display: flex; align-items: center; width: 100%; cursor: pointer; }
    .admin-item-left input { width: 24px; height: 24px; margin: 0 10px 0 0; flex-shrink: 0; }
    .admin-name { font-weight: bold; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; flex: 1; }
    .admin-item-right { flex: 0 0 auto; display: flex; align-items: center; justify-content: flex-end; }
    .status-select { padding: 4px 8px; margin: 0; font-size: 0.85rem; width: auto; height: 32px; background: #fff; }
    .pay-icon { font-size: 0.65rem; padding: 3px 6px; border-radius: 3px; margin-right: 6px; font-weight: bold; cursor: pointer; user-select: none; border: 1px solid rgba(0,0,0,0.1); }
    .pay-icon.pp { background: #ffeb3b; color: #333; }
    .pay-icon.cash { background: #e0e0e0; color: #555; }
    .pay-status { font-size: 0.8rem; color: #666; white-space: nowrap; width: 30px; text-align: right; }
    .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
    .admin-menu-btn { background: #fff; border: 1px solid #eee; padding: 20px; text-align: center; border-radius: 12px; cursor: pointer; user-select: none; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: background 0.1s; }
    .admin-menu-btn:active { background: #f0f0f0; transform: scale(0.98); }
    .admin-icon { font-size: 2rem; display: block; margin-bottom: 8px; }
    .admin-label { font-weight: bold; color: #555; }
    .guest-row { display: flex; gap: 5px; margin-bottom: 5px; }
    .guest-row input { flex: 2; }
    .guest-row select { flex: 1; font-size: 0.85rem; padding: 8px 4px; }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
    .bg-green { background: #e8f5e9; color: #2e7d32; }
    .bg-gray { background: #eee; color: #666; }
    .paypay-box { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; border: 1px solid #eee; }
    .step-list { padding-left: 20px; margin: 5px 0 10px; font-size: 0.85rem; color: #444; line-height: 1.6; }
    .member-list-chip { display: inline-block; background: #e0f2f1; color: #00695c; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; margin: 2px; }
    .paid-row { opacity: 0.5; }
    input[type="checkbox"], input[type="radio"] { width: 22px; height: 22px; margin: 0 8px 0 0; vertical-align: middle; }
    .inline-label { display: flex; align-items: center; width: 100%; cursor: pointer; margin-bottom: 12px; padding: 5px 0; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: left; }
    .rank-1 { color: #d4af37; font-weight: bold; }
    .court-box { background: #e8f5e9; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #c8e6c9; text-align: center; }
    .court-name { font-weight: bold; color: var(--primary); font-size: 1.1rem; margin-bottom: 8px; display: block; }
    .match-pair { font-size: 1.2rem; font-weight: bold; color: #333; margin: 5px 0; }
    .past-item { background: #f9f9f9; padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.1s; }
    .past-item:active { background: #e0e0e0; transform: scale(0.98); }
    .past-arrow { font-weight: bold; color: #ccc; }
    #restrictedMsg { text-align: center; padding: 40px 0; color: #888; }
    #debugLog { background: #333; color: #0f0; padding: 10px; font-family: monospace; font-size: 0.8rem; margin-bottom: 20px; border-radius: 8px; display: none; }
    #demoRibbon { position:fixed; top:0; right:0; background:#f0ad4e; color:white; font-size:0.7rem; padding:3px 15px; z-index:10000; display:none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1500; display:none; justify-content:center; align-items:center; }
    .modal { background:#fff; padding:20px; border-radius:12px; width:90%; max-width:400px; max-height:85%; overflow-y:auto; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div id="loading">
    <img src="fig/shuttle.png" class="shuttle-img" onerror="this.style.display='none';">
    <div style="margin-top:15px; font-weight:bold; color:#06c755;">Loading...</div>
  </div>
  <div id="debugLog"></div>
  <div id="demoRibbon" style="display:block; background:#d9534f;">DEBUG MODE (NO SAVE)</div>

  <div id="infoModal" class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><h3 id="modalTitle">è©³ç´°</h3><div id="modalContent"></div><button class="btn-outline" onclick="closeModal()" style="margin-top:15px; width:100%;">é–‰ã˜ã‚‹</button></div></div>

  <div id="app" style="display:none;">
    <div class="container">
      <div id="view-register" class="view-section">
        <div class="card">
          <h2>ä»Šé€±ã®ç·´ç¿’</h2>
          <div id="thisWeekInfo"><p class="muted">å‹Ÿé›†ä¸­ã®ç·´ç¿’ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p></div>
          <div id="regFormArea" style="display:none; margin-top:15px;">
            <div id="regStatusBadge" class="badge bg-gray" style="display:inline-block; margin-bottom:10px;">æœªç™»éŒ²</div>
            <div style="margin-bottom:15px; font-size:0.9rem;">
              <span class="muted">ç¾åœ¨ã®å‚åŠ è€…:</span> <span id="currentParticipantsCount">0</span>å<br>
              <div id="regMembersList" style="margin-top:5px; font-size:0.8rem;"></div>
            </div>
            <form id="regForm">
              <label class="inline-label"><input type="checkbox" id="friendToggle" onchange="toggleGuests()"><span>å‹é”ã‚’é€£ã‚Œã¦ã„ã</span></label>
              <div id="guestSection" style="display:none; background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:10px;">
                <label>äººæ•°: <input type="number" id="guestCount" min="0" max="5" value="0" onchange="renderGuestInputs()"></label>
                <div id="guestInputs"></div>
                <div class="small muted" style="margin-top:10px; color:#c62828;"><strong>ã€å‹é”åˆ†ã®æ”¯æ‰•ã„ã€‘</strong> å‹é”ã®åˆ†ã¯ã€Œå½“æ—¥ ç¾é‡‘ã€ã¾ãŸã¯ã€Œå½“æ—¥ PayPayã€ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚</div>
              </div>
              <div id="feeDisplay" style="text-align:center; font-weight:bold; color:var(--primary); margin:15px 0;">æ”¯æ‰•é‡‘é¡: - å††</div>
              <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px;">
                <h3 style="margin-top:0;">ãŠæ”¯æ‰•ã„æ–¹æ³• (æœ¬äººåˆ†)</h3>
                <p class="small muted" style="margin-top:0; color:#06c755; font-weight:bold;">â€»é‹å–¶ã®è² æ‹…è»½æ¸›ã®ãŸã‚ã€PayPayäº‹å‰æ±ºæ¸ˆã«ã”å”åŠ›ãã ã•ã„ğŸ™‡â€â™‚ï¸</p>
                <label class="inline-label"><input type="radio" name="payMethod" value="advance" onchange="togglePayMethod()"><span>äº‹å‰PayPayæ±ºæ¸ˆ</span></label>
                <div id="payDetail-advance" style="display:none; margin-left:10px; margin-bottom:15px;">
                   <div class="paypay-box">
                     <strong>&lt;æ‰‹é †&gt;</strong><ol class="step-list"><li>ä¸‹è¨˜ <strong>ID</strong> ã‚’ã‚³ãƒ”ãƒ¼</li><li>PayPayã‚¢ãƒ—ãƒª > é€ã‚‹ > IDã§é€ã‚‹</li><li>IDè²¼ã‚Šä»˜ã‘ > æ¤œç´¢</li><li>åç¾©ãŒ <strong class="ppNameTarget">-</strong> ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª</li><li>é‡‘é¡å…¥åŠ›</li><li>ä¸‹è¨˜ã®ãƒ¡ãƒ¢(ç·´ç¿’æ—¥ç¨‹ã¨åå‰)ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è²¼ã‚Šä»˜ã‘ã¦é€é‡‘</li><li>é€é‡‘å¾Œã€ä¸‹ã®ã€Œé€é‡‘ã—ã¾ã—ãŸã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹</li></ol>
                     <div>ID: <span class="ppId" style="font-weight:bold;">-</span> <button type="button" class="btn-outline btn-copy" onclick="copyText('ppId')">ã‚³ãƒ”ãƒ¼</button></div>
                     <div style="margin-top:8px; display:flex;"><input type="text" id="ppMsg" readonly style="margin:0; font-size:0.8rem; background:#fff; flex:1;"><button type="button" class="btn-outline btn-copy" onclick="copyText('ppMsg')">ãƒ¡ãƒ¢ã‚³ãƒ”ãƒ¼</button></div>
                   </div>
                   <label class="inline-label" style="margin-top:10px; color:var(--primary); font-weight:bold;"><input type="checkbox" id="chkPaidAdvance"> é€é‡‘ã—ã¾ã—ãŸ</label>
                </div>
                <label class="inline-label"><input type="radio" name="payMethod" value="day_paypay" onchange="togglePayMethod()"><span>å½“æ—¥PayPayæ”¯æ‰•ã„</span></label>
                <label class="inline-label"><input type="radio" name="payMethod" value="day_cash" onchange="togglePayMethod()"><span>å½“æ—¥ç¾é‡‘æ”¯æ‰•ã„</span></label>
              </div>
              <button type="button" id="btnRegister" class="btn-primary" onclick="submitRegistration()">å‚åŠ ç™»éŒ²ã™ã‚‹</button>
              <button type="button" id="btnCancel" class="btn-danger" style="display:none;" onclick="cancelRegistration()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </form>
          </div>
          <div id="cancelEventArea" style="display:none; margin-top:20px; text-align:right;">
            <button class="btn-outline btn-sm" style="color:var(--danger); border-color:var(--danger);" onclick="cancelEvent()">ç·´ç¿’ã‚’ä¸­æ­¢ã«ã™ã‚‹</button>
          </div>
        </div>
        <div id="lazyRegister" style="display:none;">
          <div class="card"><h2>ä»Šå¾Œã®äºˆå®š</h2><div id="futureList" class="small">èª­ã¿è¾¼ã¿ä¸­...</div></div>
          <div class="card"><h2>éå»ã®ç·´ç¿’</h2><div id="pastList" class="small">èª­ã¿è¾¼ã¿ä¸­...</div></div>
        </div>
      </div>

      <div id="view-day" class="view-section">
        <div id="dayContent" style="display:none;">
          <div id="subAdminArea" style="display:none;">
            <div class="card" style="border-left: 5px solid var(--danger);">
              <h3 style="color:var(--danger); margin:0 0 10px;">é‹å–¶: æŠ½é¸</h3>
              <div id="adminLotteryList"></div>
              <div style="margin-top:15px; display:flex; gap:10px;">
                <button class="btn-outline btn-sm" onclick="manualAddUser()">+ è¿½åŠ </button>
                <button class="btn-danger" style="flex:1; margin:0;" onclick="executeLottery()">æŠ½é¸å®Ÿè¡Œ</button>
              </div>
              <div style="text-align:right; margin-top:10px;"><button class="btn-outline btn-sm" style="color:#888; border-color:#ccc;" onclick="deleteLastRound()">ç›´å‰å–æ¶ˆ</button></div>
            </div>
          </div>
          <div class="card"><h2>æœ¬æ—¥ã®ç·´ç¿’</h2><div id="dayLotteryResult"><p>æŠ½é¸çµæœã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p></div></div>
          <div id="subAdminCollection" style="display:none;">
            <div class="card" style="border-left: 5px solid var(--accent);">
              <h3 style="color:var(--accent);">é‹å–¶: é›†é‡‘</h3>
              <p class="small muted">å—å–æ¸ˆã¿ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ä¿å­˜ã€‚<br>ã‚¢ã‚¤ã‚³ãƒ³(P/ç¾)ã‚¿ãƒƒãƒ—ã§æ–¹æ³•å¤‰æ›´ã€‚</p>
              <div id="adminCollectionList"></div>
              <div style="border-top:1px solid #eee; margin-top:10px; padding-top:10px; font-weight:bold; font-size:0.9rem;">
                  å›åæ¸ˆã¿è¨ˆ(å††): <span style="color:#e0e0e0; background:#555; padding:2px 5px; border-radius:4px;">ç¾</span> <span id="sumCash">0</span> / 
                  <span style="color:#333; background:#ffeb3b; padding:2px 5px; border-radius:4px;">P</span> <span id="sumPayPay">0</span>
              </div>
              <button class="btn-accent" style="margin-top:10px;" onclick="saveCollection()">é›†é‡‘çŠ¶æ³ã‚’ä¿å­˜</button>
            </div>
          </div>
          <div class="card" id="dayPayInfo" style="display:none;">
            <h2>å½“æ—¥PayPayæ”¯æ‰•ã„</h2>
            <div class="paypay-box">
              <strong>&lt;æ‰‹é †&gt;</strong><ol class="step-list"><li>ID <strong class="ppId">-</strong> ã‚³ãƒ”ãƒ¼</li><li>PayPayã§é€é‡‘</li><li>åç¾© <strong class="ppNameTarget">-</strong> ç¢ºèª</li><li>é‡‘é¡å…¥åŠ› (<strong>ãƒ¡ãƒ¢ã«åå‰</strong>)</li><li><span style="color:red;font-weight:bold;">å®Œäº†ç”»é¢ã‚’æ‹…å½“è€…ã«è¦‹ã›ã‚‹</span></li></ol>
              <div>ID: <span class="ppId" style="font-weight:bold;">-</span> <button class="btn-outline btn-copy" onclick="copyText('ppId')">ã‚³ãƒ”ãƒ¼</button></div>
            </div>
          </div>
        </div>
        <div id="restrictedMsg" style="text-align:center; padding:50px 0;"><h3>æ™‚é–“å¤–ã§ã™</h3><p class="muted">å½“æ—¥ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ç·´ç¿’æ—¥ã®<br>17:30ã€œ22:00ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚</p></div>
      </div>

      <div id="view-mypage" class="view-section">
        <div class="card">
          <h2>è¨­å®š</h2>
          <div style="margin-bottom:15px;">
            <label>è¡¨ç¤ºå</label><input type="text" id="myName">
            <label>åŒºåˆ†</label><select id="myCat"><option value="adult">ç¤¾ä¼šäºº</option><option value="college">å¤§å­¦ç”Ÿ</option><option value="student">é«˜æ ¡ç”Ÿä»¥ä¸‹</option></select>
            <button class="btn-primary" onclick="saveProfile()">ä¿å­˜ã™ã‚‹</button>
          </div>
          <div id="demoRoleSwitcher" style="display:none; margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
            <p class="small" style="font-weight:bold; color:#f0ad4e;">ã€ãƒ‡ãƒ¢ã€‘æ¨©é™åˆ‡ã‚Šæ›¿ãˆ</p>
            <div style="display:flex; gap:5px;">
              <button class="btn-outline btn-sm" onclick="setDemoRole('member')">ä¸€èˆ¬</button>
              <button class="btn-outline btn-sm" onclick="setDemoRole('sub_admin')">æº–ç®¡ç†</button>
              <button class="btn-outline btn-sm" onclick="setDemoRole('admin')">ç®¡ç†</button>
            </div>
          </div>
          <div id="demoDataGen" style="display:none; margin-top:10px;">
             <button class="btn-danger btn-sm" onclick="genDebugData()">[Demo] ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</button>
          </div>
        </div>
        <div class="card"><h2>ä»Šæœˆã®å‚åŠ æ•° <span id="periodMonth" class="small muted" style="font-weight:normal;"></span></h2><table id="rankMonth"><tr><td>Loading...</td></tr></table></div>
        <div class="card"><h2>ä»Šå¹´ã®å‚åŠ æ•° <span id="periodYear" class="small muted" style="font-weight:normal;"></span></h2><table id="rankYear"><tr><td>Loading...</td></tr></table></div>
      </div>

      <div id="view-admin-menu" class="view-section">
        <div class="admin-grid">
          <div class="admin-menu-btn" onclick="navigateTo('admin-acc')"><span class="admin-icon">ğŸ’°</span><br><span class="admin-label">å¸³ç°¿</span></div>
          <div class="admin-menu-btn" onclick="navigateTo('admin-sched')"><span class="admin-icon">ğŸ“…</span><br><span class="admin-label">æ—¥ç¨‹ç™»éŒ²</span></div>
          <div class="admin-menu-btn" onclick="navigateTo('admin-fees')"><span class="admin-icon">ğŸ·ï¸</span><br><span class="admin-label">ä¼šè²»ãƒ»å®šå“¡</span></div>
          <div class="admin-menu-btn" onclick="navigateTo('admin-roles')"><span class="admin-icon">ğŸ”‘</span><br><span class="admin-label">æ¨©é™è¨­å®š</span></div>
        </div>
      </div>
      <div id="view-admin-acc" class="view-section">
        <button class="btn-outline btn-sm" onclick="navigateTo('admin-menu')">â† æˆ»ã‚‹</button>
        <div class="card" style="margin-top:10px;">
          <h2>å¸³ç°¿</h2>
          <div id="accSummary" style="margin-bottom:15px; font-weight:bold; background:#e3f2fd; padding:10px; border-radius:8px;">Loading...</div>
          <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="btn-outline" style="flex:1;" onclick="document.getElementById('accListArea').style.display='block';document.getElementById('accEntryArea').style.display='none';">å±¥æ­´ç¢ºèª</button>
            <button class="btn-outline" style="flex:1;" id="btnAccEntry" onclick="document.getElementById('accListArea').style.display='none';document.getElementById('accEntryArea').style.display='block';">è¨˜å¸³ãƒ»ç§»å‹•</button>
          </div>
          <div id="accListArea"><div id="adminAccList" class="small"></div></div>
          <div id="accEntryArea" style="display:none;">
            <h3>åæ”¯å…¥åŠ›</h3>
            <select id="accType"><option value="expense">æ”¯å‡º</option><option value="income">åå…¥</option></select>
            <input type="number" id="accAmount" placeholder="é‡‘é¡">
            <button class="btn-primary" onclick="saveAccounting()">ä¿å­˜(ãƒ¢ãƒƒã‚¯)</button>
          </div>
        </div>
      </div>
      </div>

    <div class="bottom-nav">
      <div class="nav-item active" onclick="navigateTo('register')" id="nav-register"><span class="nav-icon">ğŸ“…</span>ç™»éŒ²</div>
      <div class="nav-item" onclick="navigateTo('day')" id="nav-day"><span class="nav-icon">ğŸ¸</span>å½“æ—¥</div>
      <div class="nav-item" onclick="navigateTo('mypage')" id="nav-mypage"><span class="nav-icon">ğŸ‘¤</span>ãƒã‚¤ãƒšãƒ¼ã‚¸</div>
      <div class="nav-item" onclick="navigateTo('admin-menu')" id="nav-admin" style="display:none;"><span class="nav-icon">âš™ï¸</span>ç®¡ç†</div>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbx3QQMnnjQl-3bb77-HO9SVztNzaBpl8sXTHNBm7ydsLZMK50dlNqau-qHXU16HufrEBQ/exec';
    const LIFF_ID = '2008652596-Gew4K44V';
    const params = new URLSearchParams(window.location.search);
    const INIT_PAGE = params.get('page') || 'register';

    // stateã‚‚index.htmlã¨åŒã˜æ§‹é€ ã‚’ç¶­æŒã€‚åˆæœŸå€¤ã‚’ãƒ€ãƒŸãƒ¼æ’®å½±ç”¨ã«ã‚»ãƒƒãƒˆã€‚
    let state = { me: null, paypay: null, event: null, reg: null, participants: [], isDemo: true, feeConfig: {adult:800, college:600, student:500}, realRole: 'admin' };
    let loadedData = { future: false, ranking: false, admin: false };
    let rawAccountingList = [];
    let registeredDates = [];

    function setBusy(isBusy) { document.getElementById('loading').style.display = isBusy ? 'flex' : 'none'; }

    // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: callApiã§POSTã‚’é®æ–­ã—ã€ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
    async function callApi(action, data, isPost=false) {
      console.log(`[Debug API] ${action}`, data);
      
      // æ›¸ãè¾¼ã¿ç³»ã¯ã™ã¹ã¦æ“¬ä¼¼æˆåŠŸ
      if(isPost) {
        return new Promise(res => setTimeout(() => res({ ok: true, is_demo_mock: true }), 500));
      }

      // èª­ã¿è¾¼ã¿ç³»ï¼šæ’®å½±ã«å¿…è¦ãªæœ€ä½é™ã®ãƒ€ãƒŸãƒ¼æƒ…å ±ã‚’è¿”ã™
      if(action === 'get_me') {
        return { exists: true, member: { line_user_id: 'debug_id', display_name: 'ã¯ã‚Šã', category: 'adult', role: 'admin' }, paypay_config: { id: 'debug_pay_id', receiver: 'ãƒã‚·ãƒ¢ãƒˆ ãƒªã‚¯' }, is_demo: true };
      }
      if(action === 'get_this_week') {
        return { event: { event_id: 'e1', date_str: '2026-01-11 (æ—¥)', start_time: '18:00', end_time: '21:00' }, registrations: [{name:'æ©‹æœ¬', guests:0}, {name:'ãƒ¡ãƒ³ãƒãƒ¼A', guests:1}] };
      }
      if(action === 'get_participants_detail') {
        return { data: { participants: [{participant_id:'p1', name:'æ©‹æœ¬', status:'participating', play_count:0, category:'adult'}], allRounds: [] } };
      }

      // ãã®ä»–ã¯ç©ºé…åˆ—ã‚’è¿”ã™ï¼ˆã‚¨ãƒ©ãƒ¼é˜²æ­¢ï¼‰
      return { ok: true, data: {month:[], year:[]}, list: [], events: [], summary: {total:15000, cash:5000, paypay:10000, bank:0}, fees: {adult:800, college:600, student:500} };
    }

    // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: navigateToã¯ãã®ã¾ã¾
    function navigateTo(viewId) {
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('view-active'));
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      let navId = '';
      if(viewId === 'register') navId = 'nav-register';
      else if(viewId === 'day') navId = 'nav-day';
      else if(viewId === 'mypage') navId = 'nav-mypage';
      else if(viewId.startsWith('admin')) navId = 'nav-admin';
      
      if(navId && document.getElementById(navId)) document.getElementById(navId).classList.add('active');
      const targetView = document.getElementById('view-' + viewId);
      if(targetView) targetView.classList.add('view-active');

      if(viewId === 'day') checkDayAccess();
    }

    // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: checkDayAccessã¯å¸¸ã«è¨±å¯
    function checkDayAccess() {
      document.getElementById('dayContent').style.display = 'block';
      document.getElementById('restrictedMsg').style.display = 'none';
      loadDayData();
    }

    // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: onloadã§æ’®å½±ç”¨ã®åˆæœŸçŠ¶æ…‹ã‚’å¼·åˆ¶çš„ã«ä½œã‚‹
    window.onload = async function() {
      try {
        await liff.init({ liffId: LIFF_ID });
        // ãƒ‡ãƒãƒƒã‚°æ™‚ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ãƒ«ãƒ¼ï¼ˆLIFFãƒ–ãƒ©ã‚¦ã‚¶ä»¥å¤–ã§ã‚‚å‹•ãã‚ˆã†ã«ã™ã‚‹ãŸã‚ï¼‰
        
        // ç‰¹æ¨©ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã¯ã‚Šãï¼‰ã¨ã—ã¦åˆæœŸåŒ–
        const userRes = await callApi('get_me');
        state.me = userRes.member;
        state.paypay = userRes.paypay_config;
        state.isDemo = true;

        // UIåˆæœŸåŒ– (index.htmlã®ãƒ­ã‚¸ãƒƒã‚¯æº–æ‹ )
        initUI(false);

        // ãƒ€ãƒŸãƒ¼ç·´ç¿’ã‚’ã‚»ãƒƒãƒˆ
        const weekRes = await callApi('get_this_week');
        state.event = weekRes.event;
        document.getElementById('thisWeekInfo').innerHTML = `<div>${state.event.date_str} ${state.event.start_time}-${state.event.end_time}</div>`;
        document.getElementById('regFormArea').style.display = 'block';
        document.getElementById('ppMsg').value = `${state.event.date_str} ${state.me.display_name}`;
        
        const mems = weekRes.registrations || [];
        document.getElementById('currentParticipantsCount').innerText = mems.reduce((a,b)=>a+1+b.guests, 0);
        document.getElementById('regMembersList').innerHTML = mems.map(m => `<span class="member-list-chip">${m.name}${m.guests>0?'+'+m.guests:''}</span>`).join('');
        
        // ç™»éŒ²çŠ¶æ³ï¼ˆæœªç™»éŒ²çŠ¶æ…‹ã«ã—ã¦ãŠãï¼‰
        state.reg = null;
        renderRegStatus();

      } catch (err) { console.error(err); }
      setBusy(false);
    };

    // --- ä»¥é™ã€index.htmlã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’100%ã‚³ãƒ”ãƒšï¼ˆå†…éƒ¨å¤‰æ•°ã¯å…±é€šãªã®ã§ãã®ã¾ã¾å‹•ãã¾ã™ï¼‰ ---
    function initUI(isFirst) {
      if(state.me) {
        document.getElementById('myName').value = state.me.display_name;
        document.getElementById('myCat').value = state.me.category;
        const r = state.me.role;
        const isAdmin = (r==='admin'||r==='sub_admin');
        if(isAdmin) {
          document.getElementById('subAdminArea').style.display = 'block';
          document.getElementById('subAdminCollection').style.display = 'block';
          document.getElementById('nav-admin').style.display = 'block';
        }
      }
      if(state.paypay) {
        const setT = (s,t) => document.querySelectorAll(s).forEach(e => e.innerText=t);
        setT('.ppId', state.paypay.id); setT('.ppNameTarget', state.paypay.receiver);
      }
      document.getElementById('app').style.display = 'block';
      navigateTo(INIT_PAGE);
    }

    window.submitRegistration = async function() {
      const method = document.querySelector('input[name="payMethod"]:checked')?.value;
      if(!method) return alert('æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„');
      if(method === 'advance' && !document.getElementById('chkPaidAdvance').checked) return alert('ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„');
      
      if(confirm('ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ‡ãƒãƒƒã‚°é€ä¿¡ï¼‰')) {
        setBusy(true);
        await callApi('register', {}, true);
        alert('ç™»éŒ²ã—ã¾ã—ãŸï¼ˆæ’®å½±ç”¨ãƒ€ãƒŸãƒ¼å®Œäº†ï¼‰');
        // ç™»éŒ²æ¸ˆã¿ã®è¦‹ãŸç›®ã«å¤‰ãˆã‚‹
        state.reg = { status: 'reserved', payment_method: method };
        renderRegStatus();
        setBusy(false);
      }
    }

    function renderRegStatus() {
      const badge = document.getElementById('regStatusBadge');
      const btnReg = document.getElementById('btnRegister');
      const btnCancel = document.getElementById('btnCancel');
      if(state.reg && state.reg.status === 'reserved') {
        badge.innerText = 'å‚åŠ ç™»éŒ²æ¸ˆ'; badge.className = 'badge bg-green';
        btnReg.innerText = 'ç™»éŒ²æ›´æ–°'; btnCancel.style.display = 'inline-block';
      } else {
        badge.innerText = 'æœªç™»éŒ²'; badge.className = 'badge bg-gray';
        btnReg.innerText = 'å‚åŠ ç™»éŒ²'; btnCancel.style.display = 'none';
      }
      togglePayMethod(); calcTotal();
    }

    // index.htmlã®è£œåŠ©é–¢æ•°ç¾¤ï¼ˆä¸è¶³ã—ã¦ã„ã‚‹ã‚‚ã®ã‚’è£œå®Œï¼‰
    window.togglePayMethod = function() { const val=document.querySelector('input[name="payMethod"]:checked')?.value; document.getElementById('payDetail-advance').style.display=(val==='advance')?'block':'none'; }
    window.calcTotal = function() { if(!state.me) return; document.getElementById('feeDisplay').innerText = `æ”¯æ‰•é‡‘é¡(æœ¬äººåˆ†): 800 å††`; }
    window.toggleGuests = function() { const on = document.getElementById('friendToggle').checked; document.getElementById('guestSection').style.display = on?'block':'none'; }
    window.copyText = function(id) { const el = document.querySelector('.'+id) || document.getElementById(id); const t = el.tagName==='INPUT' ? el.value : el.innerText; alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: ' + t); }
    window.closeModal = function() { document.getElementById('infoModal').style.display = 'none'; }
    async function loadDayData() { 
      const res = await callApi('get_participants_detail');
      state.participants = res.data.participants;
      renderAdminLists(); 
    }
    function renderAdminLists() {
      document.getElementById('adminLotteryList').innerHTML = state.participants.map(p => `<div class="admin-list-item"><span class="admin-name">${p.name}</span><select class="status-select"><option>å‚åŠ </option></select></div>`).join('');
      document.getElementById('adminCollectionList').innerHTML = state.participants.map(p => `<div class="admin-list-item"><span class="admin-name">${p.name}</span><span class="pay-icon cash">ç¾</span></div>`).join('');
    }
  </script>
</body>
</html>