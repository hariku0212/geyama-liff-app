<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>ゲヤマクラブ 参加ページ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
        color: #222;
        background: #f5f5f5;
      }
      body {
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 720px;
        margin: 0 auto;
        padding: 16px;
      }
      h1,
      h2,
      h3 {
        margin: 0 0 8px;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        align-items: baseline;
        margin-bottom: 8px;
      }
      .small {
        font-size: 0.85rem;
        color: #666;
      }
      label {
        display: block;
        margin: 6px 0;
        font-size: 0.9rem;
      }
      input[type='text'],
      input[type='number'],
      input[type='date'],
      select {
        width: 100%;
        box-sizing: border-box;
        padding: 6px 8px;
        font-size: 0.95rem;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      button {
        border: none;
        border-radius: 999px;
        padding: 8px 14px;
        font-size: 0.9rem;
        cursor: pointer;
        background: #06c755;
        color: #fff;
      }
      button.secondary {
        background: #e0e0e0;
        color: #222;
        margin-left: 8px;
      }
      button.danger {
        background: #e53935;
        color: #fff;
        margin-left: 8px;
      }
      button:disabled {
        opacity: 0.6;
        cursor: default;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .row > div {
        flex: 1 1 120px;
      }
      .muted {
        color: #777;
        font-size: 0.9rem;
      }
      .status-text {
        margin: 6px 0 10px;
        font-size: 0.9rem;
      }
      .status-ok {
        color: #06c755;
      }
      .status-warn {
        color: #d35400;
      }
      .status-error {
        color: #e53935;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }
      th,
      td {
        padding: 6px 4px;
        border-bottom: 1px solid #eee;
        text-align: left;
      }
      th {
        font-weight: 600;
        white-space: nowrap;
      }
      tr:last-child td {
        border-bottom: none;
      }
      .pay-cell {
        white-space: nowrap;
      }
      .tag {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 999px;
        font-size: 0.75rem;
        border: 1px solid #ddd;
        color: #555;
      }
      .me-row {
        background: #e8f5e9;
      }

      /* タブ */
      .tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 12px;
        border-bottom: 1px solid #ddd;
      }
      .tab {
        flex: 1 1 auto;
        text-align: center;
        padding: 8px 4px;
        border-radius: 10px 10px 0 0;
        border: 1px solid transparent;
        border-bottom: none;
        background: #f0f0f0;
        font-size: 0.9rem;
        cursor: pointer;
      }
      .tab.active {
        background: #ffffff;
        border-color: #ddd;
        border-bottom-color: #ffffff;
        font-weight: 600;
      }

      /* initial loading overlay */
      #loading {
        position: fixed;
        inset: 0;
        background: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      #loading-inner {
        text-align: center;
        padding: 24px;
      }
      #loading-spinner {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 3px solid #ccc;
        border-top-color: #06c755;
        margin: 0 auto 12px;
        animation: spin 0.8s linear infinite;
      }
      /* busy overlay for user actions */
      #busyOverlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 998;
      }
      #busy-inner {
        background: #fff;
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        text-align: center;
        font-size: 0.9rem;
      }
      #busy-spinner {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 3px solid #ccc;
        border-top-color: #06c755;
        margin: 0 auto 8px;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      #app {
        display: none;
      }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  </head>
  <body>
    <!-- 初期ロード用 -->
    <div id="loading">
      <div id="loading-inner">
        <div id="loading-spinner"></div>
        <div id="loading-message">読み込み中です…</div>
      </div>
    </div>

    <!-- 操作中オーバーレイ -->
    <div id="busyOverlay">
      <div id="busy-inner">
        <div id="busy-spinner"></div>
        <div id="busy-message">処理中です…</div>
      </div>
    </div>

    <div id="app">
      <div class="container">
        <!-- ユーザー情報 -->
        <section class="card">
          <div class="card-header">
            <h1 style="font-size: 1.3rem">ゲヤマクラブ</h1>
            <div class="small" id="meInfo"></div>
          </div>
          <div class="muted" style="font-size: 0.85rem">
            LINE アカウントでログイン済みです。<br />
            ※UI は仮版です。機能が整ったら少しずつ見た目を整えます。
          </div>
        </section>

        <!-- タブ -->
        <div class="tabs" id="tabBar">
          <button class="tab active" data-tab="attendance">参加</button>
          <button class="tab" data-tab="participants">参加者</button>
          <button class="tab" data-tab="history">履歴</button>
          <button class="tab" data-tab="admin" id="adminTabButton">
            管理
          </button>
        </div>

        <!-- 参加タブ -->
        <section class="card" id="attendanceCard">
          <div class="card-header">
            <h2 style="font-size: 1.15rem">明日の練習</h2>
            <div class="small" id="eventSummary"></div>
          </div>
          <div id="eventBody"></div>
        </section>

        <!-- 参加者タブ -->
        <section class="card" id="participantsCard" style="display: none">
          <div class="card-header">
            <h2 style="font-size: 1.05rem">参加者一覧</h2>
            <div class="small" id="participantsSummary"></div>
          </div>
          <div id="participantsBody"></div>
        </section>

        <!-- 履歴タブ -->
        <section class="card" id="historyCard" style="display: none">
          <div class="card-header">
            <h2 style="font-size: 1.05rem">参加履歴・ランキング</h2>
          </div>
          <div id="historyBody"></div>
        </section>

        <!-- 管理タブ -->
        <section class="card" id="adminCard" style="display: none">
          <div class="card-header">
            <h2 style="font-size: 1.05rem">管理メニュー</h2>
          </div>
          <div id="adminBody"></div>
        </section>
      </div>
    </div>

    <script>
      // ===== 設定 =====
      const LIFF_ID = '2008652596-Gew4K44V';
      const GAS_BASE_URL =
        'https://script.google.com/macros/s/AKfycbx3QQMnnjQl-3bb77-HO9SVztNzaBpl8sXTHNBm7ydsLZMK50dlNqau-qHXU16HufrEBQ/exec';

      const state = {
        me: null,
        upcomingEvent: null,
        myRegistration: null,
        participants: [],
        partStats: null,
        myHistory: [],
        ranking30: [],
        ranking365: [],
        accountingSummary: null,
        accountingEntries: [],
        editingTxId: null,
        currentTab: 'attendance',
      };

      // ===== 共通 API ヘルパー =====
      async function callApi(action, params = {}, options = {}) {
        const method = options.method || 'GET';
        const allowError = !!options.allowError;

        const url = new URL(GAS_BASE_URL);
        url.searchParams.set('action', action);

        const fetchOptions = {};
        if (method === 'GET') {
          Object.entries(params).forEach(([k, v]) => {
            if (v !== undefined && v !== null) {
              url.searchParams.set(k, v);
            }
          });
        } else {
          const body = new URLSearchParams();
          Object.entries(params).forEach(([k, v]) => {
            if (v !== undefined && v !== null) {
              body.append(k, v);
            }
          });
          fetchOptions.method = 'POST';
          fetchOptions.headers = {
            'Content-Type': 'application/x-www-form-urlencoded',
          };
          fetchOptions.body = body.toString();
        }

        const res = await fetch(url.toString(), fetchOptions);
        if (!res.ok) {
          throw new Error('API HTTP error: ' + res.status);
        }
        const data = await res.json();
        if (!allowError && !data.ok) {
          throw new Error(data.error || 'API responded with error');
        }
        return data;
      }

      function setLoading(message) {
        const loading = document.getElementById('loading');
        const msgEl = document.getElementById('loading-message');
        if (loading) loading.style.display = 'flex';
        if (msgEl && message) msgEl.textContent = message;
        const app = document.getElementById('app');
        if (app) app.style.display = 'none';
      }

      function showApp() {
        const loading = document.getElementById('loading');
        if (loading) loading.style.display = 'none';
        const app = document.getElementById('app');
        if (app) app.style.display = 'block';
      }

      function setBusy(active, message) {
        const overlay = document.getElementById('busyOverlay');
        const msgEl = document.getElementById('busy-message');
        if (!overlay) return;
        if (active) {
          overlay.style.display = 'flex';
          if (msgEl && message) msgEl.textContent = message;
        } else {
          overlay.style.display = 'none';
        }
      }

      function formatDateLabel(dateStr) {
        if (!dateStr) return '';
        const [y, m, d] = dateStr.split('-').map((v) => parseInt(v, 10));
        if (!y || !m || !d) return dateStr;
        const dt = new Date(y, m - 1, d);
        const w = ['日', '月', '火', '水', '木', '金', '土'][dt.getDay()];
        return `${y}年${m}月${d}日(${w})`;
      }

      function formatCategoryLabel(cat) {
        switch (cat) {
          case 'adult':
            return '社会人';
          case 'univ':
          case 'college':
            return '大学生';
          case 'high':
            return '高校生';
          case 'junior':
            return '中学生';
          case 'elem':
            return '小学生';
          default:
            return cat || '';
        }
      }

      function isManager() {
        return (
          state.me &&
          (state.me.role === 'admin' || state.me.role === 'sub_admin')
        );
      }

      // ===== 初期化 =====
      async function initApp() {
        try {
          setLoading('LINE と連携中です…');

          await liff.init({ liffId: LIFF_ID });

          const profile = await liff.getProfile();
          const lineUserId = profile.userId;

          // メンバー情報取得 or 初回登録
          setLoading('メンバー情報を確認中です…');
          let meRes = await callApi('get_me', { lineUserId });
          if (!meRes.exists) {
            await callApi(
              'upsert_member',
              {
                line_user_id: lineUserId,
                display_name: profile.displayName || '',
                category: 'adult',
                paypay_display_name: '',
              },
              { method: 'POST' }
            );
            meRes = await callApi('get_me', { lineUserId });
          }
          state.me = meRes.member;

          renderMe();
          setupTabs();
          showApp();

          // デフォルトで「参加」タブを読み込み
          switchTab('attendance');
        } catch (err) {
          console.error(err);
          setLoading('エラーが発生しました: ' + err.message);
        }
      }

      function renderMe() {
        const el = document.getElementById('meInfo');
        if (!el) return;
        if (!state.me) {
          el.textContent = 'ログイン情報の取得に失敗しました';
          return;
        }
        const catLabel = formatCategoryLabel(state.me.category);
        el.textContent = `${state.me.display_name || ''}${
          catLabel ? '（' + catLabel + '）' : ''
        }`;
      }

      // ===== タブ =====
      function setupTabs() {
        const tabBar = document.getElementById('tabBar');
        if (!tabBar) return;

        const adminBtn = document.getElementById('adminTabButton');
        if (adminBtn) {
          if (!isManager()) {
            adminBtn.style.display = 'none';
          } else {
            adminBtn.style.display = '';
          }
        }

        tabBar.querySelectorAll('.tab').forEach((btn) => {
          btn.addEventListener('click', () => {
            const tabId = btn.dataset.tab;
            if (!tabId) return;
            switchTab(tabId);
          });
        });
      }

      function updateTabActive(tabId) {
        const tabBar = document.getElementById('tabBar');
        if (!tabBar) return;
        tabBar.querySelectorAll('.tab').forEach((btn) => {
          if (btn.dataset.tab === tabId) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }

      function switchTab(tabId) {
        state.currentTab = tabId;
        updateTabActive(tabId);

        const attendanceCard = document.getElementById('attendanceCard');
        const participantsCard = document.getElementById('participantsCard');
        const historyCard = document.getElementById('historyCard');
        const adminCard = document.getElementById('adminCard');

        if (attendanceCard)
          attendanceCard.style.display =
            tabId === 'attendance' ? 'block' : 'none';
        if (participantsCard)
          participantsCard.style.display =
            tabId === 'participants' ? 'block' : 'none';
        if (historyCard)
          historyCard.style.display = tabId === 'history' ? 'block' : 'none';
        if (adminCard)
          adminCard.style.display = tabId === 'admin' ? 'block' : 'none';

        // タブごとにデータ読み込み
        if (tabId === 'attendance') {
          loadAttendanceTab();
        } else if (tabId === 'participants') {
          loadParticipantsTab();
        } else if (tabId === 'history') {
          loadHistoryTab();
        } else if (tabId === 'admin') {
          loadAdminTab();
        }
      }

      // ===== 参加タブ =====
      async function loadAttendanceTab() {
        try {
          setBusy(true, '明日の練習を読み込み中です…');

          const eventsRes = await callApi('get_upcoming_events');
          const events = eventsRes.events || [];

          const today = new Date();
          const tomorrow = new Date(
            today.getFullYear(),
            today.getMonth(),
            today.getDate() + 1
          );
          const yyyy = tomorrow.getFullYear();
          const mm = String(tomorrow.getMonth() + 1).padStart(2, '0');
          const dd = String(tomorrow.getDate()).padStart(2, '0');
          const tomorrowStr = `${yyyy}-${mm}-${dd}`;

          let upcoming = null;
          for (const ev of events) {
            if (ev.date === tomorrowStr) {
              upcoming = ev;
              break;
            }
          }
          if (!upcoming && events.length > 0) {
            upcoming = events[0];
          }
          state.upcomingEvent = upcoming;

          if (upcoming && state.me) {
            const regRes = await callApi('get_my_registration', {
              event_id: upcoming.event_id,
              member_id: state.me.member_id,
            });
            state.myRegistration = regRes.exists ? regRes.registration : null;
          } else {
            state.myRegistration = null;
          }

          renderAttendance();
        } catch (err) {
          console.error(err);
          const bodyEl = document.getElementById('eventBody');
          const summaryEl = document.getElementById('eventSummary');
          if (summaryEl) summaryEl.textContent = '読み込みエラー';
          if (bodyEl)
            bodyEl.innerHTML =
              '<p class="status-text status-error">明日の練習情報の取得に失敗しました。</p>';
        } finally {
          setBusy(false);
        }
      }

      function renderAttendance() {
        const summaryEl = document.getElementById('eventSummary');
        const bodyEl = document.getElementById('eventBody');
        if (!summaryEl || !bodyEl) return;
        const ev = state.upcomingEvent;

        if (!ev) {
          summaryEl.textContent = '明日の練習はありません。';
          bodyEl.innerHTML =
            '<p class="muted">開催予定がないか、まだスケジュールが登録されていません。</p>';
          return;
        }

        const dateLabel = formatDateLabel(ev.date);
        summaryEl.textContent = `${dateLabel} ${ev.start_time}〜${ev.end_time}`;

        const myReg = state.myRegistration;
        const isReserved = myReg && myReg.status === 'reserved';

        const statusClass = isReserved ? 'status-ok' : 'status-warn';
        const statusText = isReserved
          ? '現在：参加予定です'
          : '現在：未登録です';

        const guestCount = isReserved ? myReg.guest_count_requested || 0 : 0;
        const guestNames = isReserved ? myReg.guest_names_requested || '' : '';

        bodyEl.innerHTML = `
          <div class="status-text ${statusClass}">
            ${statusText}
          </div>
          <div class="muted" style="margin-bottom:8px;">
            場所：大津市立中央小学校 体育館<br/>
            参加費：社会人 800円 / 大学生 600円 / 高校生以下 500円（予定）
          </div>

          <div style="margin-bottom:12px;">
            <label>
              <input type="checkbox" id="friendToggle" ${
                guestCount > 0 ? 'checked' : ''
              } />
              友達も連れていく
            </label>
          </div>

          <div id="friendFields" style="margin-bottom:12px; ${
            guestCount > 0 ? '' : 'display:none;'
          }">
            <div class="row">
              <div>
                <label>友達の人数</label>
                <input type="number" id="guestCount" min="0" step="1" value="${guestCount}" />
              </div>
            </div>
            <label>友達の名前（カンマ区切り）</label>
            <input type="text" id="guestNames" placeholder="例：山田太郎, 佐藤花子" value="${guestNames}" />
          </div>

          <div>
            <button id="btnSubmitAttendance">
              ${isReserved ? '参加内容を更新する' : '参加登録する'}
            </button>
            <button id="btnCancelAttendance" class="secondary" ${
              isReserved ? '' : 'disabled'
            }>
              参加をキャンセル
            </button>
          </div>

          <div class="muted" style="margin-top:8px;font-size:0.85rem;">
            ・事前に PayPay で支払っても、当日現金で支払ってもOKです。<br/>
            ・事前にキャッシュレス支払いをしてから不参加になった場合は、後日返金対応します。<br/>
            ・友達の分の支払い方法は、今後運営で相談して決めていきます。
          </div>
        `;

        setupAttendanceHandlers();
      }

      function setupAttendanceHandlers() {
        const ev = state.upcomingEvent;
        const me = state.me;
        if (!ev || !me) return;

        const friendToggle = document.getElementById('friendToggle');
        const friendFields = document.getElementById('friendFields');
        const guestCountInput = document.getElementById('guestCount');
        const guestNamesInput = document.getElementById('guestNames');
        const btnSubmit = document.getElementById('btnSubmitAttendance');
        const btnCancel = document.getElementById('btnCancelAttendance');

        if (friendToggle && friendFields) {
          friendToggle.onchange = () => {
            friendFields.style.display = friendToggle.checked ? '' : 'none';
          };
        }

        if (btnSubmit) {
          btnSubmit.onclick = async () => {
            let guestCount = 0;
            let guestNames = '';

            if (friendToggle && friendToggle.checked) {
              const raw = guestCountInput.value.trim();
              const n = parseInt(raw || '0', 10);
              guestCount = isNaN(n) || n < 0 ? 0 : n;
              guestNames = guestNamesInput.value.trim();
            }

            setBusy(true, '参加内容を送信中です…');
            try {
              btnSubmit.disabled = true;
              btnCancel.disabled = true;

              const res = await callApi(
                'register_participation',
                {
                  event_id: ev.event_id,
                  member_id: me.member_id,
                  status: 'reserved',
                  guest_count_requested: guestCount,
                  guest_names_requested: guestNames,
                },
                { method: 'POST', allowError: true }
              );

              if (!res.ok) {
                if (res.error === 'CAPACITY_FULL') {
                  const dbg = res.debug || {};
                  alert(
                    '定員に達しているため参加登録できません。\n\n現在の人数: ' +
                      (dbg.reservedCount ?? '?') +
                      ' / 定員: ' +
                      (dbg.capacityTotal ?? '?')
                  );
                } else {
                  alert(
                    '参加登録に失敗しました: ' +
                      (res.message || res.error || '')
                  );
                }
                return;
              }

              state.myRegistration = {
                status: 'reserved',
                guest_count_requested: guestCount,
                guest_names_requested: guestNames,
              };

              renderAttendance();
            } catch (err) {
              console.error(err);
              alert('参加登録に失敗しました: ' + err.message);
            } finally {
              btnSubmit.disabled = false;
              btnCancel.disabled =
                !state.myRegistration ||
                state.myRegistration.status !== 'reserved';
              setBusy(false);
            }
          };
        }

        if (btnCancel) {
          btnCancel.onclick = async () => {
            if (
              !state.myRegistration ||
              state.myRegistration.status !== 'reserved'
            ) {
              return;
            }
            if (!confirm('本当に参加をキャンセルしますか？')) return;

            setBusy(true, 'キャンセル処理中です…');
            try {
              btnSubmit.disabled = true;
              btnCancel.disabled = true;

              const res = await callApi(
                'register_participation',
                {
                  event_id: ev.event_id,
                  member_id: me.member_id,
                  status: 'canceled',
                },
                { method: 'POST', allowError: true }
              );

              if (!res.ok) {
                alert(
                  'キャンセルに失敗しました: ' +
                    (res.message || res.error || '')
                );
                return;
              }

              state.myRegistration = null;
              renderAttendance();
            } catch (err) {
              console.error(err);
              alert('キャンセルに失敗しました: ' + err.message);
            } finally {
              btnSubmit.disabled = false;
              btnCancel.disabled =
                !state.myRegistration ||
                state.myRegistration.status !== 'reserved';
              setBusy(false);
            }
          };
        }
      }

      // ===== 参加者タブ =====
      async function loadParticipantsTab() {
        try {
          setBusy(true, '参加者一覧を読み込み中です…');

          // イベント情報がまだなければ取得
          if (!state.upcomingEvent) {
            const eventsRes = await callApi('get_upcoming_events');
            const events = eventsRes.events || [];

            const today = new Date();
            const tomorrow = new Date(
              today.getFullYear(),
              today.getMonth(),
              today.getDate() + 1
            );
            const yyyy = tomorrow.getFullYear();
            const mm = String(tomorrow.getMonth() + 1).padStart(2, '0');
            const dd = String(tomorrow.getDate()).padStart(2, '0');
            const tomorrowStr = `${yyyy}-${mm}-${dd}`;

            let upcoming = null;
            for (const ev of events) {
              if (ev.date === tomorrowStr) {
                upcoming = ev;
                break;
              }
            }
            if (!upcoming && events.length > 0) {
              upcoming = events[0];
            }
            state.upcomingEvent = upcoming;
          }

          const summaryEl = document.getElementById('participantsSummary');
          const bodyEl = document.getElementById('participantsBody');

          if (!state.upcomingEvent) {
            if (summaryEl) summaryEl.textContent = '明日の練習はありません。';
            if (bodyEl)
              bodyEl.innerHTML =
                '<p class="muted">開催予定がないか、まだスケジュールが登録されていません。</p>';
            return;
          }

          const partRes = await callApi('get_event_participants', {
            event_id: state.upcomingEvent.event_id,
          });
          if (partRes.ok) {
            state.participants = partRes.participants || [];
            state.partStats = partRes.stats || null;
          } else {
            state.participants = [];
            state.partStats = null;
          }

          renderParticipants();
        } catch (err) {
          console.error(err);
          const summaryEl = document.getElementById('participantsSummary');
          const bodyEl = document.getElementById('participantsBody');
          if (summaryEl) summaryEl.textContent = '読み込みエラー';
          if (bodyEl)
            bodyEl.innerHTML =
              '<p class="status-text status-error">参加者一覧の取得に失敗しました。</p>';
        } finally {
          setBusy(false);
        }
      }

      function renderParticipants() {
        const card = document.getElementById('participantsCard');
        const bodyEl = document.getElementById('participantsBody');
        const summaryEl = document.getElementById('participantsSummary');
        const ev = state.upcomingEvent;

        if (!card || !bodyEl || !summaryEl) return;

        if (!ev) {
          summaryEl.textContent = '明日の練習はありません。';
          bodyEl.innerHTML =
            '<p class="muted">開催予定がないか、まだスケジュールが登録されていません。</p>';
          return;
        }

        const parts = state.participants || [];
        const stats = state.partStats || {};
        const reservedCount = stats.reservedCount ?? parts.length;
        const capacityTotal = stats.capacityTotal ?? null;
        const paidCount = stats.paidCount ?? 0;

        const manager = isManager();

        if (!parts.length) {
          summaryEl.textContent = 'まだ参加登録がありません。';
          bodyEl.innerHTML =
            '<p class="muted">参加登録するとここに一覧が表示されます。</p>';
          return;
        }

        let text = `参加者 ${reservedCount}人`;
        if (capacityTotal !== null) {
          text += ` / 定員 ${capacityTotal}人`;
        }
        if (manager) {
          text += `（支払い済 ${paidCount}人）`;
        }
        summaryEl.textContent = text;

        const sorted = parts
          .slice()
          .sort((a, b) =>
            (a.display_name || '').localeCompare(b.display_name || 'ja')
          );

        if (!manager) {
          // 一般メンバー向け：支払状況は表示しない
          const rowsHtml = sorted
            .map((p) => {
              const catLabel = formatCategoryLabel(p.category);
              const guestLabel = p.guest_count_requested
                ? `${p.guest_count_requested}人 ${
                    p.guest_names_requested
                      ? '（' + p.guest_names_requested + '）'
                      : ''
                  }`
                : '-';
              return `
              <tr>
                <td>${p.display_name || ''}</td>
                <td>${catLabel ? `<span class="tag">${catLabel}</span>` : ''}</td>
                <td>${guestLabel}</td>
              </tr>
            `;
            })
            .join('');

          bodyEl.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>名前</th>
                  <th>区分</th>
                  <th>友達</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          `;
        } else {
          // 管理メンバー向け：支払状況も表示
          const rowsHtml = sorted
            .map((p) => {
              const catLabel = formatCategoryLabel(p.category);
              const guestLabel = p.guest_count_requested
                ? `${p.guest_count_requested}人 ${
                    p.guest_names_requested
                      ? '（' + p.guest_names_requested + '）'
                      : ''
                  }`
                : '-';
              const checked = p.payment_status === 'paid';
              return `
              <tr>
                <td>${p.display_name || ''}</td>
                <td>${catLabel ? `<span class="tag">${catLabel}</span>` : ''}</td>
                <td>${guestLabel}</td>
                <td class="pay-cell">
                  <label>
                    <input type="checkbox"
                           class="pay-toggle"
                           data-member-id="${p.member_id}"
                           ${checked ? 'checked' : ''} />
                    支払い済
                  </label>
                </td>
              </tr>
            `;
            })
            .join('');

          bodyEl.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>名前</th>
                  <th>区分</th>
                  <th>友達</th>
                  <th>支払い</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
            <p class="muted" style="margin-top:8px;font-size:0.8rem;">
              ※チェックを入れると「支払い済」として記録されます（現金／PayPayの区別は別途帳簿で管理）。
            </p>
          `;

          setupPaymentHandlers();
        }
      }

      function setupPaymentHandlers() {
        const ev = state.upcomingEvent;
        if (!ev) return;

        const checkboxes = document.querySelectorAll('.pay-toggle');
        checkboxes.forEach((cb) => {
          cb.onchange = async (e) => {
            const memberId = e.target.dataset.memberId;
            const checked = e.target.checked;

            setBusy(true, '支払状況を更新中です…');
            try {
              e.target.disabled = true;
              await callApi(
                'update_payment_status',
                {
                  event_id: ev.event_id,
                  member_id: memberId,
                  status: checked ? 'paid' : 'unpaid',
                },
                { method: 'POST' }
              );

              const partRes = await callApi('get_event_participants', {
                event_id: ev.event_id,
              });
              if (partRes.ok) {
                state.participants = partRes.participants || [];
                state.partStats = partRes.stats || null;
              }
              renderParticipants();
            } catch (err) {
              console.error(err);
              alert('支払状況の更新に失敗しました: ' + err.message);
              e.target.checked = !checked;
              e.target.disabled = false;
            } finally {
              setBusy(false);
            }
          };
        });
      }

      // ===== 履歴タブ =====
      async function loadHistoryTab() {
        if (!state.me) return;
        try {
          setBusy(true, '参加履歴を読み込み中です…');

          const histRes = await callApi('get_my_history', {
            member_id: state.me.member_id,
            limit: 20,
          });
          if (histRes.ok) {
            state.myHistory = histRes.history || [];
          } else {
            state.myHistory = [];
          }

          const rank30 = await callApi('get_participation_ranking', {
            period_days: 30,
          });
          if (rank30.ok) {
            state.ranking30 = rank30.ranking || [];
          } else {
            state.ranking30 = [];
          }

          const rank365 = await callApi('get_participation_ranking', {
            period_days: 365,
          });
          if (rank365.ok) {
            state.ranking365 = rank365.ranking || [];
          } else {
            state.ranking365 = [];
          }

          renderHistory();
        } catch (err) {
          console.error(err);
          const bodyEl = document.getElementById('historyBody');
          if (bodyEl)
            bodyEl.innerHTML =
              '<p class="status-text status-error">参加履歴の取得に失敗しました。</p>';
        } finally {
          setBusy(false);
        }
      }

      function renderHistory() {
        const card = document.getElementById('historyCard');
        const bodyEl = document.getElementById('historyBody');
        if (!card || !bodyEl) return;

        const hasHistory = state.myHistory && state.myHistory.length > 0;
        const hasRanking =
          (state.ranking30 && state.ranking30.length > 0) ||
          (state.ranking365 && state.ranking365.length > 0);

        if (!hasHistory && !hasRanking) {
          bodyEl.innerHTML =
            '<p class="muted">まだ参加履歴やランキングのデータがありません。</p>';
          return;
        }

        let html = '';

        // 自分の参加履歴
        if (hasHistory) {
          html += `<h3 style="font-size:1rem;margin:0 0 4px;">最近の参加履歴</h3>`;
          html += `<ul style="list-style:none;padding-left:0;margin:0 0 12px;">`;
          state.myHistory.forEach((h) => {
            const label = formatDateLabel(h.date);
            const time =
              h.start_time && h.end_time
                ? `${h.start_time}〜${h.end_time}`
                : h.start_time || '';
            const guest =
              h.guest_count && h.guest_count > 0
                ? `（友達 ${h.guest_count}人）`
                : '';
            html += `<li class="muted" style="margin-bottom:2px;">${label} ${time} @ ${
              h.location || '大津市立中央小学校 体育館'
            } ${guest}</li>`;
          });
          html += `</ul>`;
        }

        // ランキングテーブル共通
        const meId = state.me && state.me.member_id;

        function buildRankingTable(ranking, title) {
          if (!ranking || !ranking.length) {
            return `
              <h3 style="font-size:1rem;margin:8px 0 4px;">${title}</h3>
              <p class="muted" style="margin:0 0 4px;">データがありません。</p>
            `;
          }
          let rows = '';
          ranking.slice(0, 10).forEach((r, idx) => {
            const isMe = r.member_id === meId;
            const catLabel = formatCategoryLabel(r.category);
            rows += `
              <tr class="${isMe ? 'me-row' : ''}">
                <td>${idx + 1}</td>
                <td>${r.display_name || ''}</td>
                <td>${catLabel || ''}</td>
                <td>${r.count}</td>
              </tr>
            `;
          });
          return `
            <h3 style="font-size:1rem;margin:8px 0 4px;">${title}</h3>
            <table style="margin-bottom:4px;">
              <thead>
                <tr>
                  <th>順位</th>
                  <th>名前</th>
                  <th>区分</th>
                  <th>参加回数</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          `;
        }

        html += buildRankingTable(
          state.ranking30,
          '参加回数ランキング（直近30日）'
        );
        html += buildRankingTable(
          state.ranking365,
          '参加回数ランキング（直近1年）'
        );

        html += `<p class="muted" style="margin-top:4px;font-size:0.8rem;">※自分の行は背景が薄い緑色で表示されます。</p>`;

        bodyEl.innerHTML = html;
      }

      // ===== 管理タブ =====
      async function loadAdminTab() {
        const bodyEl = document.getElementById('adminBody');
        if (!bodyEl) return;

        if (!isManager()) {
          bodyEl.innerHTML =
            '<p class="muted">このタブは管理メンバー専用です。</p>';
          return;
        }

        try {
          setBusy(true, '帳簿データを読み込み中です…');

          const sumRes = await callApi('get_accounting_summary');
          if (sumRes.ok) {
            state.accountingSummary = sumRes.summary || null;
          } else {
            state.accountingSummary = null;
          }

          const listRes = await callApi('list_accounting', { limit: 50 });
          if (listRes.ok) {
            state.accountingEntries = listRes.entries || [];
          } else {
            state.accountingEntries = [];
          }

          renderAdmin();
        } catch (err) {
          console.error(err);
          bodyEl.innerHTML =
            '<p class="status-text status-error">帳簿データの取得に失敗しました。</p>';
        } finally {
          setBusy(false);
        }
      }

      function renderAdmin() {
        const bodyEl = document.getElementById('adminBody');
        if (!bodyEl) return;

        if (!isManager()) {
          bodyEl.innerHTML =
            '<p class="muted">このタブは管理メンバー専用です。</p>';
          return;
        }

        const summary = state.accountingSummary;
        const entries = state.accountingEntries || [];

        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;

        const balances = summary && summary.balances ? summary.balances : {};
        const totalIncome = summary ? summary.total_income || 0 : 0;
        const totalExpense = summary ? summary.total_expense || 0 : 0;
        const net = summary ? summary.net || 0 : 0;

        const editing = state.editingTxId
          ? entries.find((e) => e.tx_id === state.editingTxId)
          : null;

        const formDate = editing ? editing.date || todayStr : todayStr;
        const formType = editing ? editing.type || 'income' : 'income';
        const formAccount = editing ? editing.account || '' : '';
        const formFrom = editing ? editing.from_account || '' : '';
        const formTo = editing ? editing.to_account || '' : '';
        const formCategory = editing ? editing.category || '' : '';
        const formEventId = editing ? editing.event_id || '' : '';
        const formAmount = editing ? editing.amount || '' : '';
        const formMemo = editing ? editing.memo || '' : '';

        let entriesHtml = '';
        if (!entries.length) {
          entriesHtml = '<p class="muted">帳簿の記録はまだありません。</p>';
        } else {
          const rows = entries
            .map((e) => {
              const dir =
                e.type === 'transfer'
                  ? `${e.from_account || '-'} → ${e.to_account || '-'}`
                  : e.account || '-';
              return `
              <tr>
                <td>${e.date || ''}</td>
                <td>${e.type || ''}</td>
                <td>${dir}</td>
                <td>${e.category || ''}</td>
                <td>${e.event_id || ''}</td>
                <td style="text-align:right;">${e.amount || 0}</td>
                <td>${e.memo || ''}</td>
                <td>
                  <button class="secondary acc-edit" data-tx-id="${e.tx_id}">
                    編集
                  </button>
                </td>
              </tr>
            `;
            })
            .join('');

          entriesHtml = `
            <table>
              <thead>
                <tr>
                  <th>日付</th>
                  <th>種別</th>
                  <th>口座/振替</th>
                  <th>カテゴリ</th>
                  <th>イベント</th>
                  <th>金額</th>
                  <th>メモ</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          `;
        }

        bodyEl.innerHTML = `
          <div style="margin-bottom:12px;">
            <h3 style="font-size:1rem;margin:0 0 4px;">口座別 残高（理論値）</h3>
            <ul class="muted" style="margin:0 0 4px;padding-left:18px;font-size:0.9rem;">
              <li>現金（cash）：${balances.cash || 0} 円</li>
              <li>PayPay（paypay）：${balances.paypay || 0} 円</li>
              <li>銀行（bank）：${balances.bank || 0} 円</li>
            </ul>
            <p class="muted" style="margin:0;font-size:0.85rem;">
              収入合計：${totalIncome} 円 / 支出合計：${totalExpense} 円 / 差額（純増）：${net} 円
            </p>
          </div>

          <hr style="margin:12px 0;" />

          <div style="margin-bottom:12px;">
            <h3 style="font-size:1rem;margin:0 0 4px;">
              帳簿入力 ${state.editingTxId ? '（編集モード）' : ''}
            </h3>
            <div class="row">
              <div>
                <label>日付</label>
                <input type="date" id="accDate" value="${formDate}" />
              </div>
              <div>
                <label>種別</label>
                <select id="accType">
                  <option value="income" ${
                    formType === 'income' ? 'selected' : ''
                  }>収入 (income)</option>
                  <option value="expense" ${
                    formType === 'expense' ? 'selected' : ''
                  }>支出 (expense)</option>
                  <option value="transfer" ${
                    formType === 'transfer' ? 'selected' : ''
                  }>振替 (transfer)</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:4px;">
              <div>
                <label>口座（income/expense 用）</label>
                <select id="accAccount">
                  <option value="" ${
                    !formAccount ? 'selected' : ''
                  }>（なし）</option>
                  <option value="cash" ${
                    formAccount === 'cash' ? 'selected' : ''
                  }>現金 (cash)</option>
                  <option value="paypay" ${
                    formAccount === 'paypay' ? 'selected' : ''
                  }>PayPay (paypay)</option>
                  <option value="bank" ${
                    formAccount === 'bank' ? 'selected' : ''
                  }>銀行 (bank)</option>
                </select>
              </div>
              <div>
                <label>振替元口座（transfer 用）</label>
                <select id="accFromAccount">
                  <option value="" ${
                    !formFrom ? 'selected' : ''
                  }>（なし）</option>
                  <option value="cash" ${
                    formFrom === 'cash' ? 'selected' : ''
                  }>現金 (cash)</option>
                  <option value="paypay" ${
                    formFrom === 'paypay' ? 'selected' : ''
                  }>PayPay (paypay)</option>
                  <option value="bank" ${
                    formFrom === 'bank' ? 'selected' : ''
                  }>銀行 (bank)</option>
                </select>
              </div>
              <div>
                <label>振替先口座（transfer 用）</label>
                <select id="accToAccount">
                  <option value="" ${
                    !formTo ? 'selected' : ''
                  }>（なし）</option>
                  <option value="cash" ${
                    formTo === 'cash' ? 'selected' : ''
                  }>現金 (cash)</option>
                  <option value="paypay" ${
                    formTo === 'paypay' ? 'selected' : ''
                  }>PayPay (paypay)</option>
                  <option value="bank" ${
                    formTo === 'bank' ? 'selected' : ''
                  }>銀行 (bank)</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:4px;">
              <div>
                <label>カテゴリ</label>
                <input type="text" id="accCategory" placeholder="例：参加費, シャトル, 体育館" value="${formCategory}" />
              </div>
              <div>
                <label>関連イベントID（任意）</label>
                <input type="text" id="accEventId" placeholder="例：E20250101" value="${formEventId}" />
              </div>
              <div>
                <label>金額</label>
                <input type="number" id="accAmount" step="1" value="${formAmount}" />
              </div>
            </div>

            <label style="margin-top:4px;">メモ</label>
            <input type="text" id="accMemo" placeholder="備考など" value="${formMemo}" />

            <div style="margin-top:8px;">
              <button id="accSaveButton">
                ${state.editingTxId ? '帳簿を更新する' : '帳簿に追加する'}
              </button>
              ${
                state.editingTxId
                  ? '<button id="accCancelEdit" class="secondary">編集キャンセル</button>'
                  : ''
              }
            </div>

            <p class="muted" style="margin-top:6px;font-size:0.8rem;">
              ※種別が income/expense のときは「口座」を、transfer のときは「振替元／振替先口座」を主に使います。<br/>
              ※イベントごとの参加費合計は、参加人数を見ながら手計算して記録してください。（自動連携は今後の拡張で対応予定）
            </p>
          </div>

          <hr style="margin:12px 0;" />

          <div>
            <h3 style="font-size:1rem;margin:0 0 4px;">帳簿一覧（直近）</h3>
            ${entriesHtml}
          </div>
        `;

        setupAdminHandlers();
      }

      function setupAdminHandlers() {
        const saveBtn = document.getElementById('accSaveButton');
        const cancelEditBtn = document.getElementById('accCancelEdit');

        if (saveBtn) {
          saveBtn.onclick = async () => {
            const date = document.getElementById('accDate').value;
            const type = document.getElementById('accType').value;
            const account = document.getElementById('accAccount').value;
            const fromAccount =
              document.getElementById('accFromAccount').value;
            const toAccount = document.getElementById('accToAccount').value;
            const category = document.getElementById('accCategory').value;
            const eventId = document.getElementById('accEventId').value;
            const amount = document.getElementById('accAmount').value;
            const memo = document.getElementById('accMemo').value;

            setBusy(true, '帳簿を保存中です…');
            try {
              const params = {
                date,
                type,
                account,
                from_account: fromAccount,
                to_account: toAccount,
                category,
                event_id: eventId,
                amount,
                memo,
              };
              if (state.editingTxId) {
                params.tx_id = state.editingTxId;
              }

              const res = await callApi(
                'upsert_accounting',
                params,
                { method: 'POST' }
              );
              if (!res.ok) {
                alert(
                  '帳簿の保存に失敗しました: ' +
                    (res.error || 'unknown error')
                );
                return;
              }

              // 編集モード解除
              state.editingTxId = null;

              // 再読み込み
              await loadAdminTab();
            } catch (err) {
              console.error(err);
              alert('帳簿の保存に失敗しました: ' + err.message);
            } finally {
              setBusy(false);
            }
          };
        }

        if (cancelEditBtn) {
          cancelEditBtn.onclick = () => {
            state.editingTxId = null;
            renderAdmin();
          };
        }

        const editButtons = document.querySelectorAll('.acc-edit');
        editButtons.forEach((btn) => {
          btn.onclick = () => {
            const txId = btn.dataset.txId;
            if (!txId) return;
            state.editingTxId = txId;
            renderAdmin();
          };
        });
      }

      // ===== 起動 =====
      window.addEventListener('load', () => {
        initApp();
      });
    </script>
  </body>
</html>
