<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>ゲヤマクラブ 参加ページ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
        color: #222;
        background: #f5f5f5;
      }
      body {
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 720px;
        margin: 0 auto;
        padding: 16px;
      }
      h1,
      h2,
      h3 {
        margin: 0 0 8px;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        align-items: baseline;
        margin-bottom: 8px;
      }
      .small {
        font-size: 0.85rem;
        color: #666;
      }
      label {
        display: block;
        margin: 6px 0;
        font-size: 0.9rem;
      }
      input[type='text'],
      input[type='number'],
      input[type='date'],
      select,
      textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 6px 8px;
        font-size: 0.95rem;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      textarea {
        min-height: 60px;
        resize: vertical;
      }
      button {
        border: none;
        border-radius: 999px;
        padding: 8px 14px;
        font-size: 0.9rem;
        cursor: pointer;
        background: #06c755;
        color: #fff;
      }
      button.secondary {
        background: #e0e0e0;
        color: #222;
        margin-left: 8px;
      }
      button.danger {
        background: #e53935;
        color: #fff;
        margin-left: 8px;
      }
      button:disabled {
        opacity: 0.6;
        cursor: default;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .row > div {
        flex: 1 1 120px;
      }
      .muted {
        color: #777;
        font-size: 0.9rem;
      }
      .status-text {
        margin: 6px 0 10px;
        font-size: 0.9rem;
      }
      .status-ok {
        color: #06c755;
      }
      .status-warn {
        color: #d35400;
      }
      .status-error {
        color: #e53935;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }
      th,
      td {
        padding: 6px 4px;
        border-bottom: 1px solid #eee;
        text-align: left;
      }
      th {
        font-weight: 600;
        white-space: nowrap;
      }
      tr:last-child td {
        border-bottom: none;
      }
      .pay-cell {
        white-space: nowrap;
      }
      .tag {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 999px;
        font-size: 0.75rem;
        border: 1px solid #ddd;
        color: #555;
      }
      .me-row {
        background: #e8f5e9;
      }

      /* タブ */
      .tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 12px;
        border-bottom: 1px solid #ddd;
      }
      .tab {
        flex: 1 1 auto;
        text-align: center;
        padding: 8px 4px;
        border-radius: 10px 10px 0 0;
        border: 1px solid #ccc;
        border-bottom: none;
        background: #e0e0e0;
        font-size: 0.9rem;
        cursor: pointer;
        color: #333;
      }
      .tab:not(.active):hover {
        background: #d0d0d0;
      }
      .tab.active {
        background: #06c755;
        color: #fff;
        border-color: #06c755;
        border-bottom-color: #06c755;
        font-weight: 600;
      }

      /* 初期ロードオーバーレイ */
      #loading {
        position: fixed;
        inset: 0;
        background: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      #loading-inner {
        text-align: center;
        padding: 24px;
      }
      #loading-spinner {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 3px solid #ccc;
        border-top-color: #06c755;
        margin: 0 auto 12px;
        animation: spin 0.8s linear infinite;
      }

      /* 操作中オーバーレイ */
      #busyOverlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 998;
      }
      #busy-inner {
        background: #fff;
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        text-align: center;
        font-size: 0.9rem;
      }
      #busy-spinner {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 3px solid #ccc;
        border-top-color: #06c755;
        margin: 0 auto 8px;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      #app {
        display: none;
      }

      /* 管理メニューのボタン */
      .admin-view-btn {
        margin-right: 8px;
        margin-bottom: 4px;
        padding: 6px 10px;
        font-size: 0.85rem;
        border-radius: 999px;
        border: none;
        background: #e0e0e0;
        color: #333;
        cursor: pointer;
      }
      .admin-view-btn.active {
        background: #06c755;
        color: #fff;
      }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  </head>
  <body>
    <!-- 初期ロード用 -->
    <div id="loading">
      <div id="loading-inner">
        <div id="loading-spinner"></div>
        <div id="loading-message">読み込み中です…</div>
      </div>
    </div>

    <!-- 操作中オーバーレイ -->
    <div id="busyOverlay">
      <div id="busy-inner">
        <div id="busy-spinner"></div>
        <div id="busy-message">処理中です…</div>
      </div>
    </div>

    <div id="app">
      <div class="container">
        <!-- ユーザー情報 -->
        <section class="card">
          <div class="card-header">
            <h1 style="font-size: 1.3rem">ゲヤマクラブ</h1>
            <div class="small" id="meInfo"></div>
          </div>
          <div class="muted" style="font-size: 0.85rem">
            LINE アカウントでログイン済みです。<br />
            ※UI は仮版です。機能が整ったら少しずつ見た目を整えます。
          </div>
        </section>

        <!-- タブ -->
        <div class="tabs" id="tabBar">
          <button class="tab active" data-tab="session">今週の練習</button>
          <button class="tab" data-tab="history">履歴</button>
          <button class="tab" data-tab="admin" id="adminTabButton">
            管理
          </button>
        </div>

        <!-- 今週の練習（参加＋参加者一覧） -->
        <section class="card" id="sessionCard">
          <div class="card-header">
            <h2 style="font-size: 1.15rem">今週の練習</h2>
            <div class="small" id="eventSummary"></div>
          </div>
          <div id="eventBody"></div>

          <hr style="margin: 12px 0" />

          <div class="card-header">
            <h3 style="font-size: 1.05rem">参加者一覧</h3>
            <div class="small" id="participantsSummary"></div>
          </div>
          <div id="participantsBody"></div>
        </section>

        <!-- 履歴タブ -->
        <section class="card" id="historyCard" style="display: none">
          <div class="card-header">
            <h2 style="font-size: 1.05rem">参加履歴・ランキング</h2>
          </div>
          <div id="historyBody"></div>
        </section>

        <!-- 管理タブ -->
        <section class="card" id="adminCard" style="display: none">
          <div class="card-header">
            <h2 style="font-size: 1.05rem">管理メニュー</h2>
          </div>
          <div id="adminBody"></div>
        </section>
      </div>
    </div>

    <script>
      // ===== 設定 =====
      const LIFF_ID = '2008652596-Gew4K44V';
      const GAS_BASE_URL =
        'https://script.google.com/macros/s/AKfycbx3QQMnnjQl-3bb77-HO9SVztNzaBpl8sXTHNBm7ydsLZMK50dlNqau-qHXU16HufrEBQ/exec';

      const state = {
        me: null,
        upcomingEvent: null,
        myRegistration: null,
        participants: [],
        partStats: null,
        paymentDraft: {},
        myHistory: [],
        ranking30: [],
        ranking365: [],
        accountingSummary: null,
        accountingEntries: [],
        recentEvents: [],
        feeSettings: null,
        members: [],
        editingTxId: null,
        currentTab: 'session',
        adminView: 'accounting', // accounting | fees | roles
      };

      // ===== 共通 API ヘルパー =====
      async function callApi(action, params = {}, options = {}) {
        const method = options.method || 'GET';
        const allowError = !!options.allowError;

        const url = new URL(GAS_BASE_URL);
        url.searchParams.set('action', action);

        const fetchOptions = {};
        if (method === 'GET') {
          Object.entries(params).forEach(([k, v]) => {
            if (v !== undefined && v !== null) {
              url.searchParams.set(k, v);
            }
          });
        } else {
          const body = new URLSearchParams();
          Object.entries(params).forEach(([k, v]) => {
            if (v !== undefined && v !== null) {
              body.append(k, v);
            }
          });
          fetchOptions.method = 'POST';
          fetchOptions.headers = {
            'Content-Type': 'application/x-www-form-urlencoded',
          };
          fetchOptions.body = body.toString();
        }

        const res = await fetch(url.toString(), fetchOptions);
        if (!res.ok) {
          throw new Error('API HTTP error: ' + res.status);
        }
        const data = await res.json();
        if (!allowError && !data.ok) {
          throw new Error(data.error || 'API responded with error');
        }
        return data;
      }

      function setLoading(message) {
        const loading = document.getElementById('loading');
        const msgEl = document.getElementById('loading-message');
        if (loading) loading.style.display = 'flex';
        if (msgEl && message) msgEl.textContent = message;
        const app = document.getElementById('app');
        if (app) app.style.display = 'none';
      }

      function showApp() {
        const loading = document.getElementById('loading');
        if (loading) loading.style.display = 'none';
        const app = document.getElementById('app');
        if (app) app.style.display = 'block';
      }

      function setBusy(active, message) {
        const overlay = document.getElementById('busyOverlay');
        const msgEl = document.getElementById('busy-message');
        if (!overlay) return;
        if (active) {
          overlay.style.display = 'flex';
          if (msgEl && message) msgEl.textContent = message;
        } else {
          overlay.style.display = 'none';
        }
      }

      function formatDateLabel(dateStr) {
        if (!dateStr) return '';
        const [y, m, d] = dateStr.split('-').map((v) => parseInt(v, 10));
        if (!y || !m || !d) return dateStr;
        const dt = new Date(y, m - 1, d);
        const w = ['日', '月', '火', '水', '木', '金', '土'][dt.getDay()];
        return `${y}年${m}月${d}日(${w})`;
      }

      function formatCategoryLabel(cat) {
        switch (cat) {
          case 'adult':
            return '社会人';
          case 'univ':
          case 'college':
            return '大学生';
          case 'high':
            return '高校生';
          case 'junior':
            return '中学生';
          case 'elem':
            return '小学生';
          default:
            return cat || '';
        }
      }

      function isManager() {
        return (
          state.me &&
          (state.me.role === 'admin' || state.me.role === 'sub_admin')
        );
      }

      // ===== 初期化 =====
      async function initApp() {
        try {
          setLoading('LINE と連携中です…');
          await liff.init({ liffId: LIFF_ID });

          const profile = await liff.getProfile();
          const lineUserId = profile.userId;

          setLoading('メンバー情報を確認中です…');
          let meRes = await callApi('get_me', { lineUserId });
          if (!meRes.exists) {
            await callApi(
              'upsert_member',
              {
                line_user_id: lineUserId,
                display_name: profile.displayName || '',
                category: 'adult',
                paypay_display_name: '',
              },
              { method: 'POST' }
            );
            meRes = await callApi('get_me', { lineUserId });
          }
          state.me = meRes.member;

          renderMe();
          setupTabs();
          showApp();

          // デフォルトは今週の練習タブ
          switchTab('session');
        } catch (err) {
          console.error(err);
          setLoading('エラーが発生しました: ' + err.message);
        }
      }

      function renderMe() {
        const el = document.getElementById('meInfo');
        if (!el) return;
        if (!state.me) {
          el.textContent = 'ログイン情報の取得に失敗しました';
          return;
        }
        const catLabel = formatCategoryLabel(state.me.category);
        el.textContent = `${state.me.display_name || ''}${
          catLabel ? '（' + catLabel + '）' : ''
        }`;
      }

      // ===== タブ =====
      function setupTabs() {
        const tabBar = document.getElementById('tabBar');
        if (!tabBar) return;

        const adminBtn = document.getElementById('adminTabButton');
        if (adminBtn) {
          if (!isManager()) {
            adminBtn.style.display = 'none';
          } else {
            adminBtn.style.display = '';
          }
        }

        tabBar.querySelectorAll('.tab').forEach((btn) => {
          btn.addEventListener('click', () => {
            const tabId = btn.dataset.tab;
            if (!tabId) return;
            switchTab(tabId);
          });
        });
      }

      function updateTabActive(tabId) {
        const tabBar = document.getElementById('tabBar');
        if (!tabBar) return;
        tabBar.querySelectorAll('.tab').forEach((btn) => {
          if (btn.dataset.tab === tabId) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }

      function switchTab(tabId) {
        state.currentTab = tabId;
        updateTabActive(tabId);

        const sessionCard = document.getElementById('sessionCard');
        const historyCard = document.getElementById('historyCard');
        const adminCard = document.getElementById('adminCard');

        if (sessionCard)
          sessionCard.style.display = tabId === 'session' ? 'block' : 'none';
        if (historyCard)
          historyCard.style.display = tabId === 'history' ? 'block' : 'none';
        if (adminCard)
          adminCard.style.display = tabId === 'admin' ? 'block' : 'none';

        if (tabId === 'session') {
          loadSessionTab();
        } else if (tabId === 'history') {
          loadHistoryTab();
        } else if (tabId === 'admin') {
          loadAdminTab();
        }
      }

      // ===== 今週の練習タブ =====
      async function loadSessionTab() {
        try {
          setBusy(true, '今週の練習情報を読み込み中です…');

          const eventsRes = await callApi('get_upcoming_events');
          const events = eventsRes.events || [];

          let upcoming = null;
          if (events.length > 0) {
            // 最も近い open イベント = 今週の練習
            upcoming = events[0];
          }
          state.upcomingEvent = upcoming;

          if (upcoming && state.me) {
            const regRes = await callApi('get_my_registration', {
              event_id: upcoming.event_id,
              member_id: state.me.member_id,
            });
            state.myRegistration = regRes.exists ? regRes.registration : null;
          } else {
            state.myRegistration = null;
          }

          // 参加者一覧
          if (upcoming) {
            const partRes = await callApi('get_event_participants', {
              event_id: upcoming.event_id,
            });
            if (partRes.ok) {
              state.participants = partRes.participants || [];
              state.partStats = partRes.stats || null;
            } else {
              state.participants = [];
              state.partStats = null;
            }
            state.paymentDraft = {};
          } else {
            state.participants = [];
            state.partStats = null;
            state.paymentDraft = {};
          }

          // 会費設定（未取得なら）
          if (!state.feeSettings) {
            try {
              const feeRes = await callApi('get_fee_settings');
              if (feeRes.ok) {
                state.feeSettings = {
                  adult: feeRes.fees?.adult ?? 800,
                  univ: feeRes.fees?.univ ?? 600,
                  high: feeRes.fees?.high ?? 500,
                  paypayMessage: feeRes.paypay_message || '',
                };
              }
            } catch (e) {
              console.warn('get_fee_settings failed', e);
            }
          }

          renderSession();
        } catch (err) {
          console.error(err);
          const summaryEl = document.getElementById('eventSummary');
          const eventBody = document.getElementById('eventBody');
          const partSummary = document.getElementById('participantsSummary');
          const partBody = document.getElementById('participantsBody');
          if (summaryEl) summaryEl.textContent = '読み込みエラー';
          if (eventBody)
            eventBody.innerHTML =
              '<p class="status-text status-error">今週の練習情報の取得に失敗しました。</p>';
          if (partSummary) partSummary.textContent = '';
          if (partBody)
            partBody.innerHTML =
              '<p class="muted">参加者一覧を取得できませんでした。</p>';
        } finally {
          setBusy(false);
        }
      }

      function renderSession() {
        renderAttendance();
        renderParticipants();
      }

      function renderAttendance() {
        const summaryEl = document.getElementById('eventSummary');
        const bodyEl = document.getElementById('eventBody');
        if (!summaryEl || !bodyEl) return;

        const ev = state.upcomingEvent;
        if (!ev) {
          summaryEl.textContent = '今週の練習は登録されていません。';
          bodyEl.innerHTML =
            '<p class="muted">開催予定がないか、まだスケジュールが登録されていません。</p>';
          return;
        }

        const dateLabel = formatDateLabel(ev.date);
        const timeRange =
          ev.start_time && ev.end_time
            ? `${ev.start_time}〜${ev.end_time}`
            : ev.start_time || '';
        summaryEl.textContent = `${dateLabel} ${timeRange}`;

        const myReg = state.myRegistration;
        const isReserved = myReg && myReg.status === 'reserved';

        const statusClass = isReserved ? 'status-ok' : 'status-warn';
        const statusText = isReserved
          ? '現在：参加予定です'
          : '現在：未登録です';

        const guestCount = isReserved ? myReg.guest_count_requested || 0 : 0;
        const guestNames = isReserved ? myReg.guest_names_requested || '' : '';

        const fees = state.feeSettings || {
          adult: 800,
          univ: 600,
          high: 500,
          paypayMessage: '',
        };

        const feeText = `社会人 ${fees.adult}円 / 大学生 ${fees.univ}円 / 高校生以下 ${fees.high}円`;

        bodyEl.innerHTML = `
          <div class="status-text ${statusClass}">
            ${statusText}
          </div>
          <div class="muted" style="margin-bottom:8px;">
            場所：大津市立中央小学校 体育館<br/>
            参加費：${feeText}
          </div>

          <div style="margin-bottom:12px;">
            <label>
              <input type="checkbox" id="friendToggle" ${
                guestCount > 0 ? 'checked' : ''
              } />
              友達も連れていく
            </label>
          </div>

          <div id="friendFields" style="margin-bottom:12px; ${
            guestCount > 0 ? '' : 'display:none;'
          }">
            <div class="row">
              <div>
                <label>友達の人数</label>
                <input type="number" id="guestCount" min="0" step="1" value="${guestCount}" />
              </div>
            </div>
            <label>友達の名前（カンマ区切り）</label>
            <input
              type="text"
              id="guestNames"
              placeholder="例：山田太郎, 佐藤花子"
              value="${guestNames}"
            />
          </div>

          <div>
            <button id="btnSubmitAttendance">
              ${
                isReserved ? '参加内容を更新する' : '今週の練習に参加登録する'
              }
            </button>
            <button id="btnCancelAttendance" class="secondary" ${
              isReserved ? '' : 'disabled'
            }>
              参加をキャンセル
            </button>
          </div>

          <div class="muted" style="margin-top:8px;font-size:0.85rem;">
            ${
              fees.paypayMessage
                ? fees.paypayMessage
                : '・事前に PayPay で支払っても、当日現金で支払ってもOKです。'
            }
          </div>
        `;

        setupAttendanceHandlers();
      }

      function setupAttendanceHandlers() {
        const ev = state.upcomingEvent;
        const me = state.me;
        if (!ev || !me) return;

        const friendToggle = document.getElementById('friendToggle');
        const friendFields = document.getElementById('friendFields');
        const guestCountInput = document.getElementById('guestCount');
        const guestNamesInput = document.getElementById('guestNames');
        const btnSubmit = document.getElementById('btnSubmitAttendance');
        const btnCancel = document.getElementById('btnCancelAttendance');

        if (friendToggle && friendFields) {
          friendToggle.onchange = () => {
            friendFields.style.display = friendToggle.checked ? '' : 'none';
          };
        }

        if (btnSubmit) {
          btnSubmit.onclick = async () => {
            let guestCount = 0;
            let guestNames = '';

            if (friendToggle && friendToggle.checked) {
              const raw = guestCountInput.value.trim();
              const n = parseInt(raw || '0', 10);
              guestCount = isNaN(n) || n < 0 ? 0 : n;
              guestNames = guestNamesInput.value.trim();
            }

            setBusy(true, '参加内容を送信中です…');
            try {
              btnSubmit.disabled = true;
              btnCancel.disabled = true;

              const res = await callApi(
                'register_participation',
                {
                  event_id: ev.event_id,
                  member_id: me.member_id,
                  status: 'reserved',
                  guest_count_requested: guestCount,
                  guest_names_requested: guestNames,
                },
                { method: 'POST', allowError: true }
              );

              if (!res.ok) {
                if (res.error === 'CAPACITY_FULL') {
                  const dbg = res.debug || {};
                  alert(
                    '定員に達しているため参加登録できません。\n\n現在の人数: ' +
                      (dbg.reservedCount ?? '?') +
                      ' / 定員: ' +
                      (dbg.capacityTotal ?? '?')
                  );
                } else {
                  alert(
                    '参加登録に失敗しました: ' +
                      (res.message || res.error || '')
                  );
                }
                return;
              }

              state.myRegistration = {
                status: 'reserved',
                guest_count_requested: guestCount,
                guest_names_requested: guestNames,
              };

              // 参加者一覧も再読込
              const partRes = await callApi('get_event_participants', {
                event_id: ev.event_id,
              });
              if (partRes.ok) {
                state.participants = partRes.participants || [];
                state.partStats = partRes.stats || null;
                state.paymentDraft = {};
              }

              renderSession();
            } catch (err) {
              console.error(err);
              alert('参加登録に失敗しました: ' + err.message);
            } finally {
              btnSubmit.disabled = false;
              btnCancel.disabled =
                !state.myRegistration ||
                state.myRegistration.status !== 'reserved';
              setBusy(false);
            }
          };
        }

        if (btnCancel) {
          btnCancel.onclick = async () => {
            if (
              !state.myRegistration ||
              state.myRegistration.status !== 'reserved'
            ) {
              return;
            }
            if (!confirm('本当に今週の練習の参加をキャンセルしますか？')) return;

            setBusy(true, 'キャンセル処理中です…');
            try {
              btnSubmit.disabled = true;
              btnCancel.disabled = true;

              const res = await callApi(
                'register_participation',
                {
                  event_id: ev.event_id,
                  member_id: me.member_id,
                  status: 'canceled',
                },
                { method: 'POST', allowError: true }
              );

              if (!res.ok) {
                alert(
                  'キャンセルに失敗しました: ' +
                    (res.message || res.error || '')
                );
                return;
              }

              state.myRegistration = null;

              const partRes = await callApi('get_event_participants', {
                event_id: ev.event_id,
              });
              if (partRes.ok) {
                state.participants = partRes.participants || [];
                state.partStats = partRes.stats || null;
                state.paymentDraft = {};
              }

              renderSession();
            } catch (err) {
              console.error(err);
              alert('キャンセルに失敗しました: ' + err.message);
            } finally {
              btnSubmit.disabled = false;
              btnCancel.disabled =
                !state.myRegistration ||
                state.myRegistration.status !== 'reserved';
              setBusy(false);
            }
          };
        }
      }

      // ===== 参加者一覧（今週の練習カード内） =====
      function renderParticipants() {
        const bodyEl = document.getElementById('participantsBody');
        const summaryEl = document.getElementById('participantsSummary');
        const ev = state.upcomingEvent;

        if (!bodyEl || !summaryEl) return;

        if (!ev) {
          summaryEl.textContent = '';
          bodyEl.innerHTML =
            '<p class="muted">今週の練習が登録されていないため、参加者一覧は表示できません。</p>';
          return;
        }

        const parts = state.participants || [];
        const stats = state.partStats || {};
        const reservedCount = stats.reservedCount ?? parts.length;
        const capacityTotal = stats.capacityTotal ?? null;
        const paidCount = stats.paidCount ?? 0;

        const manager = isManager();

        if (!parts.length) {
          summaryEl.textContent = 'まだ参加登録がありません。';
          bodyEl.innerHTML =
            '<p class="muted">参加登録するとここに一覧が表示されます。</p>';
          return;
        }

        let text = `参加者 ${reservedCount}人`;
        if (capacityTotal !== null) {
          text += ` / 定員 ${capacityTotal}人`;
        }
        if (manager) {
          text += `（支払い済 ${paidCount}人）`;
        }
        summaryEl.textContent = text;

        const sorted = parts
          .slice()
          .sort((a, b) =>
            (a.display_name || '').localeCompare(b.display_name || 'ja')
          );

        if (!manager) {
          const rowsHtml = sorted
            .map((p) => {
              const catLabel = formatCategoryLabel(p.category);
              const guestLabel = p.guest_count_requested
                ? `${p.guest_count_requested}人 ${
                    p.guest_names_requested
                      ? '（' + p.guest_names_requested + '）'
                      : ''
                  }`
                : '-';
              return `
              <tr>
                <td>${p.display_name || ''}</td>
                <td>${
                  catLabel ? `<span class="tag">${catLabel}</span>` : ''
                }</td>
                <td>${guestLabel}</td>
              </tr>
            `;
            })
            .join('');

          bodyEl.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>名前</th>
                  <th>区分</th>
                  <th>友達</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          `;
        } else {
          const rowsHtml = sorted
            .map((p) => {
              const catLabel = formatCategoryLabel(p.category);
              const guestLabel = p.guest_count_requested
                ? `${p.guest_count_requested}人 ${
                    p.guest_names_requested
                      ? '（' + p.guest_names_requested + '）'
                      : ''
                  }`
                : '-';
              const originalChecked = p.payment_status === 'paid';
              const draft =
                state.paymentDraft && p.member_id in state.paymentDraft
                  ? state.paymentDraft[p.member_id]
                  : originalChecked;
              const checked = draft ? 'checked' : '';
              return `
              <tr>
                <td>${p.display_name || ''}</td>
                <td>${
                  catLabel ? `<span class="tag">${catLabel}</span>` : ''
                }</td>
                <td>${guestLabel}</td>
                <td class="pay-cell">
                  <label>
                    <input type="checkbox"
                           class="pay-toggle"
                           data-member-id="${p.member_id}"
                           ${checked} />
                    支払い済
                  </label>
                </td>
              </tr>
            `;
            })
            .join('');

          bodyEl.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>名前</th>
                  <th>区分</th>
                  <th>友達</th>
                  <th>支払い</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
            <div style="margin-top:8px;">
              <button id="savePaymentsButton">支払状況を保存</button>
            </div>
            <p class="muted" style="margin-top:4px;font-size:0.8rem;">
              ※チェックを操作したあと、「支払状況を保存」ボタンを押すとまとめて反映されます。
            </p>
          `;

          setupPaymentHandlers();
        }
      }

      function setupPaymentHandlers() {
        const ev = state.upcomingEvent;
        if (!ev) return;

        state.paymentDraft = state.paymentDraft || {};

        const checkboxes = document.querySelectorAll('.pay-toggle');
        checkboxes.forEach((cb) => {
          cb.onchange = (e) => {
            const memberId = e.target.dataset.memberId;
            const checked = e.target.checked;
            state.paymentDraft[memberId] = checked;
          };
        });

        const saveBtn = document.getElementById('savePaymentsButton');
        if (saveBtn) {
          saveBtn.onclick = async () => {
            const participants = state.participants || [];
            const draft = state.paymentDraft || {};
            const updates = [];

            Object.entries(draft).forEach(([memberId, checked]) => {
              const p = participants.find((pp) => pp.member_id === memberId);
              if (!p) return;
              const original = p.payment_status === 'paid';
              if (original !== checked) {
                updates.push({
                  member_id: memberId,
                  status: checked ? 'paid' : 'unpaid',
                });
              }
            });

            if (!updates.length) {
              alert('変更はありません。');
              return;
            }

            setBusy(true, '支払状況を保存中です…');
            try {
              await callApi(
                'bulk_update_payment_status',
                {
                  event_id: ev.event_id,
                  updates_json: JSON.stringify(updates),
                },
                { method: 'POST' }
              );
              const partRes = await callApi('get_event_participants', {
                event_id: ev.event_id,
              });
              if (partRes.ok) {
                state.participants = partRes.participants || [];
                state.partStats = partRes.stats || null;
              }
              state.paymentDraft = {};
              renderParticipants();
            } catch (err) {
              console.error(err);
              alert('支払状況の保存に失敗しました: ' + err.message);
              setBusy(false);
            } finally {
              setBusy(false);
            }
          };
        }
      }

      // ===== 履歴タブ =====
      async function loadHistoryTab() {
        if (!state.me) return;
        try {
          setBusy(true, '参加履歴を読み込み中です…');

          const histRes = await callApi('get_my_history', {
            member_id: state.me.member_id,
            limit: 20,
          });
          if (histRes.ok) {
            state.myHistory = histRes.history || [];
          } else {
            state.myHistory = [];
          }

          const rank30 = await callApi('get_participation_ranking', {
            period_days: 30,
          });
          if (rank30.ok) {
            state.ranking30 = rank30.ranking || [];
          } else {
            state.ranking30 = [];
          }

          const rank365 = await callApi('get_participation_ranking', {
            period_days: 365,
          });
          if (rank365.ok) {
            state.ranking365 = rank365.ranking || [];
          } else {
            state.ranking365 = [];
          }

          renderHistory();
        } catch (err) {
          console.error(err);
          const bodyEl = document.getElementById('historyBody');
          if (bodyEl)
            bodyEl.innerHTML =
              '<p class="status-text status-error">参加履歴の取得に失敗しました。</p>';
        } finally {
          setBusy(false);
        }
      }

      function renderHistory() {
        const bodyEl = document.getElementById('historyBody');
        if (!bodyEl) return;

        const hasHistory = state.myHistory && state.myHistory.length > 0;
        const hasRanking =
          (state.ranking30 && state.ranking30.length > 0) ||
          (state.ranking365 && state.ranking365.length > 0);

        if (!hasHistory && !hasRanking) {
          bodyEl.innerHTML =
            '<p class="muted">まだ参加履歴やランキングのデータがありません。</p>';
          return;
        }

        let html = '';

        if (hasHistory) {
          html += `<h3 style="font-size:1rem;margin:0 0 4px;">最近の参加履歴</h3>`;
          html += `<ul style="list-style:none;padding-left:0;margin:0 0 12px;">`;
          state.myHistory.forEach((h) => {
            const label = formatDateLabel(h.date);
            const time =
              h.start_time && h.end_time
                ? `${h.start_time}〜${h.end_time}`
                : h.start_time || '';
            const guest =
              h.guest_count && h.guest_count > 0
                ? `（友達 ${h.guest_count}人）`
                : '';
            html += `<li class="muted" style="margin-bottom:2px;">${label} ${time} @ ${
              h.location || '大津市立中央小学校 体育館'
            } ${guest}</li>`;
          });
          html += `</ul>`;
        }

        const meId = state.me && state.me.member_id;

        function buildRankingTable(ranking, title) {
          if (!ranking || !ranking.length) {
            return `
              <h3 style="font-size:1rem;margin:8px 0 4px;">${title}</h3>
              <p class="muted" style="margin:0 0 4px;">データがありません。</p>
            `;
          }
          let rows = '';
          ranking.slice(0, 10).forEach((r, idx) => {
            const isMe = r.member_id === meId;
            const catLabel = formatCategoryLabel(r.category);
            rows += `
              <tr class="${isMe ? 'me-row' : ''}">
                <td>${idx + 1}</td>
                <td>${r.display_name || ''}</td>
                <td>${catLabel || ''}</td>
                <td>${r.count}</td>
              </tr>
            `;
          });
          return `
            <h3 style="font-size:1rem;margin:8px 0 4px;">${title}</h3>
            <table style="margin-bottom:4px;">
              <thead>
                <tr>
                  <th>順位</th>
                  <th>名前</th>
                  <th>区分</th>
                  <th>参加回数</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          `;
        }

        html += buildRankingTable(
          state.ranking30,
          '参加回数ランキング（直近30日）'
        );
        html += buildRankingTable(
          state.ranking365,
          '参加回数ランキング（直近1年）'
        );

        html += `<p class="muted" style="margin-top:4px;font-size:0.8rem;">※自分の行は背景が薄い緑色で表示されます。</p>`;

        bodyEl.innerHTML = html;
      }

      // ===== 管理タブ =====
      async function loadAdminTab() {
        const bodyEl = document.getElementById('adminBody');
        if (!bodyEl) return;

        if (!isManager()) {
          bodyEl.innerHTML =
            '<p class="muted">このタブは管理メンバー専用です。</p>';
          return;
        }

        try {
          setBusy(true, '管理データを読み込み中です…');

          const [sumRes, listRes, recentRes, feeRes, membersRes] =
            await Promise.all([
              callApi('get_accounting_summary'),
              callApi('list_accounting', { limit: 50 }),
              callApi('list_recent_events', { limit: 10 }),
              callApi('get_fee_settings'),
              callApi('list_members'),
            ]);

          if (sumRes.ok) state.accountingSummary = sumRes.summary || null;
          else state.accountingSummary = null;

          if (listRes.ok) state.accountingEntries = listRes.entries || [];
          else state.accountingEntries = [];

          if (recentRes.ok) state.recentEvents = recentRes.events || [];
          else state.recentEvents = [];

          if (feeRes.ok) {
            state.feeSettings = {
              adult: feeRes.fees?.adult ?? 800,
              univ: feeRes.fees?.univ ?? 600,
              high: feeRes.fees?.high ?? 500,
              paypayMessage: feeRes.paypay_message || '',
            };
          }

          if (membersRes.ok) state.members = membersRes.members || [];
          else state.members = [];

          renderAdmin();
        } catch (err) {
          console.error(err);
          bodyEl.innerHTML =
            '<p class="status-text status-error">管理データの取得に失敗しました。</p>';
        } finally {
          setBusy(false);
        }
      }

      function renderAdmin() {
        const bodyEl = document.getElementById('adminBody');
        if (!bodyEl) return;

        if (!isManager()) {
          bodyEl.innerHTML =
            '<p class="muted">このタブは管理メンバー専用です。</p>';
          return;
        }

        const view = state.adminView || 'accounting';

        let viewHtml = '';
        if (view === 'accounting') {
          viewHtml = buildAccountingViewHtml();
        } else if (view === 'fees') {
          viewHtml = buildFeesViewHtml();
        } else if (view === 'roles') {
          viewHtml = buildRolesViewHtml();
        }

        bodyEl.innerHTML = `
          <div style="margin-bottom:8px;">
            <button class="admin-view-btn ${
              view === 'accounting' ? 'active' : ''
            }" data-view="accounting">帳簿</button>
            <button class="admin-view-btn ${
              view === 'fees' ? 'active' : ''
            }" data-view="fees">会費設定</button>
            <button class="admin-view-btn ${
              view === 'roles' ? 'active' : ''
            }" data-view="roles">メンバー権限</button>
          </div>
          <div id="adminViewContainer">
            ${viewHtml}
          </div>
        `;

        setupAdminMenuHandlers();
        if (view === 'accounting') {
          setupAccountingHandlers();
        } else if (view === 'fees') {
          setupFeesHandlers();
        } else if (view === 'roles') {
          setupRolesHandlers();
        }
      }

      function setupAdminMenuHandlers() {
        document.querySelectorAll('.admin-view-btn').forEach((btn) => {
          btn.onclick = () => {
            const v = btn.dataset.view;
            if (!v) return;
            state.adminView = v;
            renderAdmin();
          };
        });
      }

      function buildAccountingViewHtml() {
        const summary = state.accountingSummary;
        const entries = state.accountingEntries || [];
        const recentEvents = state.recentEvents || [];

        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;

        const balances = summary && summary.balances ? summary.balances : {};
        const totalIncome = summary ? summary.total_income || 0 : 0;
        const totalExpense = summary ? summary.total_expense || 0 : 0;
        const net = summary ? summary.net || 0 : 0;

        const editing = state.editingTxId
          ? entries.find((e) => e.tx_id === state.editingTxId)
          : null;

        const formDate = editing ? editing.date || todayStr : todayStr;
        const formType = editing ? editing.type || 'income' : 'income';
        const formAccount = editing ? editing.account || '' : '';
        const formFrom = editing ? editing.from_account || '' : '';
        const formTo = editing ? editing.to_account || '' : '';
        const formCategory = editing ? editing.category || '' : '';
        const formEventId = editing ? editing.event_id || '' : '';
        const formAmount = editing ? editing.amount || '' : '';
        const formMemo = editing ? editing.memo || '' : '';

        let entriesHtml = '';
        if (!entries.length) {
          entriesHtml = '<p class="muted">帳簿の記録はまだありません。</p>';
        } else {
          const rows = entries
            .map((e) => {
              const dir =
                e.type === 'transfer'
                  ? `${e.from_account || '-'} → ${e.to_account || '-'}`
                  : e.account || '-';
              return `
              <tr>
                <td>${e.date || ''}</td>
                <td>${e.type || ''}</td>
                <td>${dir}</td>
                <td>${e.category || ''}</td>
                <td>${e.event_id || ''}</td>
                <td style="text-align:right;">${e.amount || 0}</td>
                <td>${e.memo || ''}</td>
                <td>
                  <button class="secondary acc-edit" data-tx-id="${e.tx_id}">
                    編集
                  </button>
                </td>
              </tr>
            `;
            })
            .join('');

          entriesHtml = `
            <table>
              <thead>
                <tr>
                  <th>日付</th>
                  <th>種別</th>
                  <th>口座/振替</th>
                  <th>カテゴリ</th>
                  <th>イベント</th>
                  <th>金額</th>
                  <th>メモ</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          `;
        }

        const eventOptions = recentEvents
          .map((ev) => {
            const label =
              formatDateLabel(ev.date) +
              (ev.start_time ? ` ${ev.start_time}〜${ev.end_time || ''}` : '');
            return `<option value="${ev.event_id}" ${
              formEventId === ev.event_id ? 'selected' : ''
            }>${label}</option>`;
          })
          .join('');

        const eventOptionsForIncome = recentEvents
          .map((ev, idx) => {
            const label =
              formatDateLabel(ev.date) +
              (ev.start_time ? ` ${ev.start_time}〜${ev.end_time || ''}` : '');
            return `<option value="${ev.event_id}" ${
              idx === 0 ? 'selected' : ''
            }>${label}</option>`;
          })
          .join('');

        return `
          <div style="margin-bottom:12px;">
            <h3 style="font-size:1rem;margin:0 0 4px;">口座別 残高（理論値）</h3>
            <ul class="muted" style="margin:0 0 4px;padding-left:18px;font-size:0.9rem;">
              <li>現金（cash）：${balances.cash || 0} 円</li>
              <li>PayPay（paypay）：${balances.paypay || 0} 円</li>
              <li>銀行（bank）：${balances.bank || 0} 円</li>
            </ul>
            <p class="muted" style="margin:0;font-size:0.85rem;">
              収入合計：${totalIncome} 円 / 支出合計：${totalExpense} 円 / 差額（純増）：${net} 円
            </p>
          </div>

          <hr style="margin:12px 0;" />

          <div style="margin-bottom:12px;">
            <h3 style="font-size:1rem;margin:0 0 4px;">
              帳簿入力 ${state.editingTxId ? '（編集モード）' : ''}
            </h3>
            <div class="row">
              <div>
                <label>日付</label>
                <input type="date" id="accDate" value="${formDate}" />
              </div>
              <div>
                <label>種別</label>
                <select id="accType">
                  <option value="income" ${
                    formType === 'income' ? 'selected' : ''
                  }>収入 (income)</option>
                  <option value="expense" ${
                    formType === 'expense' ? 'selected' : ''
                  }>支出 (expense)</option>
                  <option value="transfer" ${
                    formType === 'transfer' ? 'selected' : ''
                  }>振替 (transfer)</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:4px;">
              <div id="accAccountGroup">
                <label>口座（income/expense 用）</label>
                <select id="accAccount">
                  <option value="" ${
                    !formAccount ? 'selected' : ''
                  }>（なし）</option>
                  <option value="cash" ${
                    formAccount === 'cash' ? 'selected' : ''
                  }>現金 (cash)</option>
                  <option value="paypay" ${
                    formAccount === 'paypay' ? 'selected' : ''
                  }>PayPay (paypay)</option>
                  <option value="bank" ${
                    formAccount === 'bank' ? 'selected' : ''
                  }>銀行 (bank)</option>
                </select>
              </div>
              <div id="accFromGroup">
                <label>振替元口座（transfer 用）</label>
                <select id="accFromAccount">
                  <option value="" ${
                    !formFrom ? 'selected' : ''
                  }>（なし）</option>
                  <option value="cash" ${
                    formFrom === 'cash' ? 'selected' : ''
                  }>現金 (cash)</option>
                  <option value="paypay" ${
                    formFrom === 'paypay' ? 'selected' : ''
                  }>PayPay (paypay)</option>
                  <option value="bank" ${
                    formFrom === 'bank' ? 'selected' : ''
                  }>銀行 (bank)</option>
                </select>
              </div>
              <div id="accToGroup">
                <label>振替先口座（transfer 用）</label>
                <select id="accToAccount">
                  <option value="" ${
                    !formTo ? 'selected' : ''
                  }>（なし）</option>
                  <option value="cash" ${
                    formTo === 'cash' ? 'selected' : ''
                  }>現金 (cash)</option>
                  <option value="paypay" ${
                    formTo === 'paypay' ? 'selected' : ''
                  }>PayPay (paypay)</option>
                  <option value="bank" ${
                    formTo === 'bank' ? 'selected' : ''
                  }>銀行 (bank)</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:4px;">
              <div>
                <label>カテゴリ</label>
                <input
                  type="text"
                  id="accCategory"
                  placeholder="例：参加費, シャトル, 体育館"
                  value="${formCategory}"
                />
              </div>
              <div>
                <label>関連イベント（任意）</label>
                <select id="accEventId">
                  <option value="" ${
                    !formEventId ? 'selected' : ''
                  }>（なし）</option>
                  ${eventOptions}
                </select>
              </div>
              <div>
                <label>金額</label>
                <input type="number" id="accAmount" step="1" value="${formAmount}" />
              </div>
            </div>

            <label style="margin-top:4px;">メモ</label>
            <input type="text" id="accMemo" placeholder="備考など" value="${formMemo}" />

            <div style="margin-top:8px;">
              <button id="accSaveButton">
                ${state.editingTxId ? '帳簿を更新する' : '帳簿に追加する'}
              </button>
              ${
                state.editingTxId
                  ? '<button id="accCancelEdit" class="secondary">編集キャンセル</button>'
                  : ''
              }
            </div>

            <p class="muted" style="margin-top:6px;font-size:0.8rem;">
              ※種別が income/expense のときは「口座」を、transfer のときは「振替元／振替先口座」を主に使います。<br/>
              ※イベントごとの参加費合計は、下の「イベント収入の自動記帳」から自動計算して登録できます。
            </p>
          </div>

          <hr style="margin:12px 0;" />

          <div style="margin-bottom:12px;">
            <h3 style="font-size:1rem;margin:0 0 4px;">イベント収入の自動記帳</h3>
            <div class="row">
              <div>
                <label>対象イベント</label>
                <select id="incomeEvent">
                  ${eventOptionsForIncome}
                </select>
              </div>
              <div>
                <label>収入を記帳する口座</label>
                <select id="incomeAccount">
                  <option value="cash">現金 (cash)</option>
                  <option value="paypay">PayPay (paypay)</option>
                  <option value="bank">銀行 (bank)</option>
                </select>
              </div>
            </div>
            <div style="margin-top:8px;">
              <button id="recordEventIncomeButton">
                参加費収入を帳簿に反映する
              </button>
            </div>
            <p class="muted" style="margin-top:6px;font-size:0.8rem;">
              ※参加登録（友達人数を含む）と会費設定をもとに、指定イベントの理論上の収入を自動計算して帳簿に記録します。<br/>
              ※集金が完全に終わっていなくても、「全員払った」前提で一旦記帳し、差額は別途調整用レコードとして手入力してください。
            </p>
          </div>

          <hr style="margin:12px 0;" />

          <div>
            <h3 style="font-size:1rem;margin:0 0 4px;">帳簿一覧（直近）</h3>
            ${entriesHtml}
          </div>
        `;
      }

      function setupAccountingHandlers() {
        const saveBtn = document.getElementById('accSaveButton');
        const cancelEditBtn = document.getElementById('accCancelEdit');
        const typeSelect = document.getElementById('accType');
        const recordEventBtn = document.getElementById('recordEventIncomeButton');

        function updateAccountFieldVisibility() {
          if (!typeSelect) return;
          const type = typeSelect.value;
          const accGroup = document.getElementById('accAccountGroup');
          const fromGroup = document.getElementById('accFromGroup');
          const toGroup = document.getElementById('accToGroup');

          if (type === 'income' || type === 'expense') {
            if (accGroup) accGroup.style.display = '';
            if (fromGroup) fromGroup.style.display = 'none';
            if (toGroup) toGroup.style.display = 'none';
          } else if (type === 'transfer') {
            if (accGroup) accGroup.style.display = 'none';
            if (fromGroup) fromGroup.style.display = '';
            if (toGroup) toGroup.style.display = '';
          } else {
            if (accGroup) accGroup.style.display = '';
            if (fromGroup) fromGroup.style.display = '';
            if (toGroup) toGroup.style.display = '';
          }
        }

        updateAccountFieldVisibility();
        if (typeSelect) {
          typeSelect.onchange = updateAccountFieldVisibility;
        }

        if (saveBtn) {
          saveBtn.onclick = async () => {
            const date = document.getElementById('accDate').value;
            const type = document.getElementById('accType').value;
            const account = document.getElementById('accAccount').value;
            const fromAccount =
              document.getElementById('accFromAccount').value;
            const toAccount = document.getElementById('accToAccount').value;
            const category = document.getElementById('accCategory').value;
            const eventId = document.getElementById('accEventId').value;
            const amount = document.getElementById('accAmount').value;
            const memo = document.getElementById('accMemo').value;

            setBusy(true, '帳簿を保存中です…');
            try {
              const params = {
                date,
                type,
                account,
                from_account: fromAccount,
                to_account: toAccount,
                category,
                event_id: eventId,
                amount,
                memo,
              };
              if (state.editingTxId) {
                params.tx_id = state.editingTxId;
              }

              const res = await callApi(
                'upsert_accounting',
                params,
                { method: 'POST' }
              );
              if (!res.ok) {
                alert(
                  '帳簿の保存に失敗しました: ' +
                    (res.error || 'unknown error')
                );
                return;
              }

              state.editingTxId = null;
              await loadAdminTab();
            } catch (err) {
              console.error(err);
              alert('帳簿の保存に失敗しました: ' + err.message);
            } finally {
              setBusy(false);
            }
          };
        }

        if (cancelEditBtn) {
          cancelEditBtn.onclick = () => {
            state.editingTxId = null;
            renderAdmin();
          };
        }

        const editButtons = document.querySelectorAll('.acc-edit');
        editButtons.forEach((btn) => {
          btn.onclick = () => {
            const txId = btn.dataset.txId;
            if (!txId) return;
            state.editingTxId = txId;
            renderAdmin();
          };
        });

        if (recordEventBtn) {
          recordEventBtn.onclick = async () => {
            const eventSelect = document.getElementById('incomeEvent');
            const accountSelect = document.getElementById('incomeAccount');
            if (!eventSelect || !accountSelect) return;
            const eventId = eventSelect.value;
            const account = accountSelect.value || 'cash';
            if (!eventId) {
              alert('対象イベントを選択してください。');
              return;
            }

            setBusy(true, 'イベント収入を計算して記帳中です…');
            try {
              const res = await callApi(
                'record_event_income',
                {
                  event_id: eventId,
                  account,
                },
                { method: 'POST', allowError: true }
              );
              if (!res.ok) {
                alert(
                  'イベント収入の記帳に失敗しました: ' +
                    (res.error || 'unknown error')
                );
                return;
              }

              const breakdown = res.breakdown || {};
              alert(
                `イベント収入を記帳しました。\n\n金額: ${
                  res.amount ?? 0
                } 円\n内訳(人数): 社会人 ${
                  breakdown.adult ?? 0
                } 名, 大学生 ${breakdown.univ ?? 0} 名, 高校生以下 ${
                  breakdown.high ?? 0
                } 名\n(ホスト＋友達を合算した人数です)`
              );

              await loadAdminTab();
            } catch (err) {
              console.error(err);
              alert('イベント収入の記帳に失敗しました: ' + err.message);
            } finally {
              setBusy(false);
            }
          };
        }
      }

      function buildFeesViewHtml() {
        const fees = state.feeSettings || {
          adult: 800,
          univ: 600,
          high: 500,
          paypayMessage: '',
        };

        return `
          <div style="margin-bottom:12px;">
            <h3 style="font-size:1rem;margin:0 0 4px;">会費設定</h3>
            <div class="row">
              <div>
                <label>社会人</label>
                <input
                  type="number"
                  id="feeAdult"
                  min="0"
                  step="1"
                  value="${fees.adult}"
                />
              </div>
              <div>
                <label>大学生</label>
                <input
                  type="number"
                  id="feeUniv"
                  min="0"
                  step="1"
                  value="${fees.univ}"
                />
              </div>
              <div>
                <label>高校生以下</label>
                <input
                  type="number"
                  id="feeHigh"
                  min="0"
                  step="1"
                  value="${fees.high}"
                />
              </div>
            </div>

            <label style="margin-top:8px;">PayPay 支払い案内（メンバー向け表示）</label>
            <textarea
              id="paypayMessage"
              placeholder="例：PayPay ID: geyama123 / 送金名には「苗字＋名前」が分かる形でお願いします。"
            >${fees.paypayMessage || ''}</textarea>

            <div style="margin-top:8px;">
              <button id="saveFeesButton">会費設定を保存</button>
            </div>

            <p class="muted" style="margin-top:6px;font-size:0.8rem;">
              ※ここで設定した会費は、今週の練習画面の表示とイベント収入の自動計算に使われます。<br/>
              ※PayPay案内は、今週の練習画面の下部にそのまま表示されます。
            </p>
          </div>
        `;
      }

      function setupFeesHandlers() {
        const btn = document.getElementById('saveFeesButton');
        if (!btn) return;

        btn.onclick = async () => {
          const adult = document.getElementById('feeAdult').value;
          const univ = document.getElementById('feeUniv').value;
          const high = document.getElementById('feeHigh').value;
          const msg = document.getElementById('paypayMessage').value;

          setBusy(true, '会費設定を保存中です…');
          try {
            const res = await callApi(
              'save_fee_settings',
              {
                fee_adult: adult,
                fee_univ: univ,
                fee_high: high,
                paypay_message: msg,
              },
              { method: 'POST' }
            );
            if (!res.ok) {
              alert(
                '会費設定の保存に失敗しました: ' +
                  (res.error || 'unknown error')
              );
              return;
            }

            state.feeSettings = {
              adult: parseInt(adult || '0', 10) || 0,
              univ: parseInt(univ || '0', 10) || 0,
              high: parseInt(high || '0', 10) || 0,
              paypayMessage: msg,
            };

            alert('会費設定を保存しました。');
          } catch (err) {
            console.error(err);
            alert('会費設定の保存に失敗しました: ' + err.message);
          } finally {
            setBusy(false);
          }
        };
      }

      function buildRolesViewHtml() {
        const members = state.members || [];
        if (!members.length) {
          return `
            <div>
              <h3 style="font-size:1rem;margin:0 0 4px;">メンバー権限</h3>
              <p class="muted">メンバー情報がありません。</p>
            </div>
          `;
        }

        const rows = members
          .map((m) => {
            const catLabel = formatCategoryLabel(m.category);
            return `
            <tr>
              <td>${m.display_name || ''}</td>
              <td>${catLabel || ''}</td>
              <td>${m.total_participation_count || 0}</td>
              <td>
                <select class="role-select" data-member-id="${m.member_id}">
                  <option value="member" ${
                    m.role === 'member' ? 'selected' : ''
                  }>member</option>
                  <option value="sub_admin" ${
                    m.role === 'sub_admin' ? 'selected' : ''
                  }>sub_admin</option>
                  <option value="admin" ${
                    m.role === 'admin' ? 'selected' : ''
                  }>admin</option>
                </select>
              </td>
              <td>
                <button class="secondary role-save" data-member-id="${
                  m.member_id
                }">更新</button>
              </td>
            </tr>
          `;
          })
          .join('');

        return `
          <div>
            <h3 style="font-size:1rem;margin:0 0 4px;">メンバー権限</h3>
            <table>
              <thead>
                <tr>
                  <th>名前</th>
                  <th>区分</th>
                  <th>参加回数</th>
                  <th>権限</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
            <p class="muted" style="margin-top:6px;font-size:0.8rem;">
              ※権限は必要なメンバーだけ admin / sub_admin に設定し、それ以外は member のままにしておいてください。
            </p>
          </div>
        `;
      }

      function setupRolesHandlers() {
        const buttons = document.querySelectorAll('.role-save');
        buttons.forEach((btn) => {
          btn.onclick = async () => {
            const memberId = btn.dataset.memberId;
            if (!memberId) return;
            const select = document.querySelector(
              `.role-select[data-member-id="${memberId}"]`
            );
            if (!select) return;
            const role = select.value;

            setBusy(true, '権限を更新中です…');
            try {
              const res = await callApi(
                'update_member_role',
                {
                  member_id: memberId,
                  role,
                },
                { method: 'POST' }
              );
              if (!res.ok) {
                alert(
                  '権限の更新に失敗しました: ' +
                    (res.error || 'unknown error')
                );
                return;
              }
              alert('権限を更新しました。');
            } catch (err) {
              console.error(err);
              alert('権限の更新に失敗しました: ' + err.message);
            } finally {
              setBusy(false);
            }
          };
        });
      }

      // ===== 起動 =====
      window.addEventListener('load', () => {
        initApp();
      });
    </script>
  </body>
</html>
