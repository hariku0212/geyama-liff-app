<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ã‚²ãƒ¤ãƒã‚¯ãƒ©ãƒ–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta property="og:title" content="ã‚²ãƒ¤ãƒã‚¯ãƒ©ãƒ–ã‚¢ãƒ—ãƒª">
  <meta property="og:description" content="ç·´ç¿’ã®å‚åŠ ç™»éŒ²ã€PayPayæ”¯æ‰•ã„ã€ã‚³ãƒ¼ãƒˆæŠ½é¸ãªã©ãŒã§ãã‚‹ã‚¢ãƒ—ãƒªã§ã™ã€‚">
  <meta property="og:type" content="website">
  <style>
    /* ... (CSSã¯å‰å›ã¨åŒã˜ã€‚å¤‰æ›´ãªã—) ... */
    :root { --primary: #06c755; --bg: #f2f4f8; --card: #ffffff; --text: #333; --danger: #e53935; --gray: #888; --accent: #ff9800; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; }
    .container { max-width: 600px; margin: 0 auto; padding: 15px; }
    .view-section { display: none; }
    .view-active { display: block; animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .card { background: var(--card); padding: 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-bottom: 16px; }
    h2 { font-size: 1.1rem; margin: 0 0 10px; border-bottom: 2px solid var(--primary); padding-bottom: 5px; display: inline-block; }
    h3 { font-size: 1rem; margin: 15px 0 8px; font-weight: bold; color: #444; }
    .muted { color: var(--gray); font-size: 0.85rem; line-height: 1.4; }
    .small { font-size: 0.8rem; }
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .shuttle-img { width: 80px; height: auto; animation: bounce 1s infinite alternate ease-in-out; }
    @keyframes bounce { 0% { transform: translateY(0); } 100% { transform: translateY(-30px); } }
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
    .nav-item { flex: 1; text-align: center; padding: 8px 0; font-size: 0.65rem; color: var(--gray); cursor: pointer; }
    .nav-item.active { color: var(--primary); font-weight: bold; }
    .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 2px; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; font-size: 1rem; background: #fff; }
    button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 8px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 8px 12px; font-size: 0.9rem; }
    .btn-copy { padding: 6px 10px; font-size: 0.8rem; width: auto; margin: 0 0 0 8px; display: inline-block; }
    .btn-sm { width: auto; padding: 6px 12px; font-size: 0.8rem; margin: 0; border-radius: 4px; }
    .admin-list-item { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; padding: 12px 0; }
    .admin-item-left { flex: 1; display: flex; align-items: center; overflow: hidden; margin-right: 10px; min-width: 0; }
    .admin-item-left label { display: flex; align-items: center; width: 100%; cursor: pointer; }
    .admin-item-left input { width: 24px; height: 24px; margin: 0 10px 0 0; flex-shrink: 0; }
    .admin-name { font-weight: bold; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; flex: 1; }
    .admin-item-right { flex: 0 0 auto; display: flex; align-items: center; justify-content: flex-end; }
    .status-select { padding: 4px 8px; margin: 0; font-size: 0.85rem; width: auto; height: 32px; background: #fff; }
    .pay-icon { font-size: 0.65rem; padding: 3px 6px; border-radius: 4px; margin-right: 6px; font-weight: bold; cursor: pointer; user-select: none; border: 1px solid rgba(0,0,0,0.1); }
    .pay-icon.pp { background: #ffeb3b; color: #333; }
    .pay-icon.cash { background: #e0e0e0; color: #555; }
    .pay-status { font-size: 0.8rem; color: #666; white-space: nowrap; width: 30px; text-align: right; }
    .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
    .admin-menu-btn { background: #fff; border: 1px solid #eee; padding: 20px; text-align: center; border-radius: 12px; cursor: pointer; user-select: none; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: background 0.1s; }
    .admin-menu-btn:active { background: #f0f0f0; transform: scale(0.98); }
    .admin-icon { font-size: 2rem; display: block; margin-bottom: 8px; }
    .admin-label { font-weight: bold; color: #555; }
    .guest-row { display: flex; gap: 5px; margin-bottom: 5px; }
    .guest-row input { flex: 2; }
    .guest-row select { flex: 1; font-size: 0.85rem; padding: 8px 4px; }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
    .bg-green { background: #e8f5e9; color: #2e7d32; }
    .bg-gray { background: #eee; color: #666; }
    .paypay-box { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; border: 1px solid #eee; }
    .step-list { padding-left: 20px; margin: 5px 0 10px; font-size: 0.85rem; color: #444; line-height: 1.6; }
    .member-list-chip { display: inline-block; background: #e0f2f1; color: #00695c; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; margin: 2px; }
    .paid-row { opacity: 0.5; }
    input[type="checkbox"], input[type="radio"] { width: 22px; height: 22px; margin: 0 8px 0 0; vertical-align: middle; }
    .inline-label { display: flex; align-items: center; width: 100%; cursor: pointer; margin-bottom: 12px; padding: 5px 0; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: left; }
    .rank-1 { color: #d4af37; font-weight: bold; }
    .court-box { background: #e8f5e9; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #c8e6c9; text-align: center; }
    .court-name { font-weight: bold; color: var(--primary); font-size: 1.1rem; margin-bottom: 8px; display: block; }
    .match-pair { font-size: 1.2rem; font-weight: bold; color: #333; margin: 5px 0; }
    .past-item { background: #f9f9f9; padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.1s; }
    .past-item:active { background: #e0e0e0; transform: scale(0.98); }
    .past-arrow { font-weight: bold; color: #ccc; }
    #restrictedMsg { text-align: center; padding: 40px 0; color: #888; }
    #debugLog { background: #333; color: #0f0; padding: 10px; font-family: monospace; font-size: 0.8rem; margin-bottom: 20px; border-radius: 8px; display: none; }
    #demoRibbon { position:fixed; top:0; right:0; background:#f0ad4e; color:white; font-size:0.7rem; padding:3px 15px; z-index:9999; display:none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1500; display:none; justify-content:center; align-items:center; }
    .modal { background:#fff; padding:20px; border-radius:12px; width:90%; max-width:400px; max-height:85%; overflow-y:auto; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div id="loading">
    <img src="fig/shuttle.png" class="shuttle-img" onerror="this.style.display='none';">
    <div style="margin-top:15px; font-weight:bold; color:#06c755;">Loading...</div>
  </div>
  <div id="debugLog"></div>
  <div id="demoRibbon">DEMO MODE</div>

  <div id="infoModal" class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><h3 id="modalTitle">è©³ç´°</h3><div id="modalContent"></div><button class="btn-outline" onclick="closeModal()" style="margin-top:15px; width:100%;">é–‰ã˜ã‚‹</button></div></div>

  <div id="app" style="display:none;">
    <div class="container">
      
      <div id="view-register" class="view-section">
        <div class="card">
          <h2>ä»Šé€±ã®ç·´ç¿’</h2>
          <div id="thisWeekInfo"><p class="muted">å‹Ÿé›†ä¸­ã®ç·´ç¿’ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p></div>
          <div id="regFormArea" style="display:none; margin-top:15px;">
            <div id="regStatusBadge" class="badge bg-gray" style="display:inline-block; margin-bottom:10px;">æœªç™»éŒ²</div>
            <div style="margin-bottom:15px; font-size:0.9rem;">
              <span class="muted">ç¾åœ¨ã®å‚åŠ è€…:</span> <span id="currentParticipantsCount">0</span>å<br>
              <div id="regMembersList" style="margin-top:5px; font-size:0.8rem;"></div>
            </div>
            
            <form id="regForm">
              <label class="inline-label"><input type="checkbox" id="friendToggle" onchange="toggleGuests()"><span>å‹é”ã‚’é€£ã‚Œã¦ã„ã</span></label>
              <div id="guestSection" style="display:none; background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:10px;">
                <label>äººæ•°: <input type="number" id="guestCount" min="0" max="5" value="0" onchange="renderGuestInputs()"></label>
                <div id="guestInputs"></div>
                <div class="small muted" style="margin-top:10px; color:#c62828;">
                   <strong>ã€å‹é”åˆ†ã®æ”¯æ‰•ã„ã€‘</strong> å‹é”ã®åˆ†ã¯ã€Œå½“æ—¥ ç¾é‡‘ã€ã¾ãŸã¯ã€Œå½“æ—¥ PayPayã€ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚
                </div>
              </div>
              <div id="feeDisplay" style="text-align:center; font-weight:bold; color:var(--primary); margin:15px 0;">æ”¯æ‰•é‡‘é¡: - å††</div>

              <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px;">
                <h3 style="margin-top:0;">ãŠæ”¯æ‰•ã„æ–¹æ³• (æœ¬äººåˆ†)</h3>
                <p class="small muted" style="margin-top:0; color:#06c755; font-weight:bold;">
                  â€»é‹å–¶ã®è² æ‹…è»½æ¸›ï¼ˆå°éŠ­ç®¡ç†ï¼‰ã®ãŸã‚ã€PayPayäº‹å‰æ±ºæ¸ˆã«ã”å”åŠ›ã„ãŸã ã‘ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™ğŸ™‡â€â™‚ï¸
                </p>
                <label class="inline-label"><input type="radio" name="payMethod" value="advance" onchange="togglePayMethod()"><span>äº‹å‰PayPayæ±ºæ¸ˆ</span></label>
                <div id="payDetail-advance" style="display:none; margin-left:10px; margin-bottom:15px;">
                   <div class="paypay-box">
                     <strong>&lt;æ‰‹é †&gt;</strong><ol class="step-list"><li>ä¸‹è¨˜ <strong>ID</strong> ã‚’ã‚³ãƒ”ãƒ¼</li><li>PayPayã‚¢ãƒ—ãƒª > é€ã‚‹ > IDã§é€ã‚‹</li><li>IDè²¼ã‚Šä»˜ã‘ > æ¤œç´¢</li><li>åç¾© <strong class="ppNameTarget">-</strong> ã‚’ç¢ºèª</li><li>é‡‘é¡å…¥åŠ› (<strong>ä¸‹è¨˜ã®ãƒ¡ãƒ¢ã¯ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è²¼ã‚Šä»˜ã‘</strong>)</li><li>é€é‡‘å¾Œã€ä¸‹è¨˜ã€Œé€é‡‘ã—ã¾ã—ãŸã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹</li></ol>
                     <div>ID: <span class="ppId" style="font-weight:bold;">-</span> <button type="button" class="btn-outline btn-copy" onclick="copyText('ppId')">ã‚³ãƒ”ãƒ¼</button></div>
                     <div style="margin-top:8px; display:flex;"><input type="text" id="ppMsg" readonly style="margin:0; font-size:0.8rem; background:#fff; flex:1;"><button type="button" class="btn-outline btn-copy" onclick="copyText('ppMsg')">ãƒ¡ãƒ¢ã‚³ãƒ”ãƒ¼</button></div>
                   </div>
                   <label class="inline-label" style="margin-top:10px; color:var(--primary); font-weight:bold;"><input type="checkbox" id="chkPaidAdvance"> é€é‡‘ã—ã¾ã—ãŸ</label>
                </div>
                <label class="inline-label"><input type="radio" name="payMethod" value="day_paypay" onchange="togglePayMethod()"><span>å½“æ—¥PayPayæ”¯æ‰•ã„</span></label>
                <label class="inline-label"><input type="radio" name="payMethod" value="day_cash" onchange="togglePayMethod()"><span>å½“æ—¥ç¾é‡‘æ”¯æ‰•ã„</span></label>
              </div>
              <button type="button" id="btnRegister" class="btn-primary" onclick="submitRegistration()">å‚åŠ ç™»éŒ²ã™ã‚‹</button>
              <button type="button" id="btnCancel" class="btn-danger" style="display:none;" onclick="cancelRegistration()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </form>
          </div>
          <div id="cancelEventArea" style="display:none; margin-top:20px; text-align:right;">
            <button class="btn-outline btn-sm" style="color:var(--danger); border-color:var(--danger);" onclick="cancelEvent()">ç·´ç¿’ã‚’ä¸­æ­¢ã«ã™ã‚‹</button>
          </div>
        </div>
        <div id="lazyRegister" style="display:none;">
          <div class="card"><h2>ä»Šå¾Œã®äºˆå®š</h2><div id="futureList" class="small">èª­ã¿è¾¼ã¿ä¸­...</div></div>
          <div class="card"><h2>éå»ã®ç·´ç¿’</h2><div id="pastList" class="small">èª­ã¿è¾¼ã¿ä¸­...</div></div>
        </div>
      </div>

      <div id="view-day" class="view-section">
        <div id="dayContent" style="display:none;">
          <div id="subAdminArea" style="display:none;">
            <div class="card" style="border-left: 5px solid var(--danger);">
              <h3 style="color:var(--danger); margin:0 0 10px;">é‹å–¶: æŠ½é¸</h3>
              <div id="adminLotteryList"></div>
              <div style="margin-top:15px; display:flex; gap:10px;">
                <button class="btn-outline btn-sm" onclick="manualAddUser()">+ è¿½åŠ </button>
                <button class="btn-danger" style="flex:1; margin:0;" onclick="executeLottery()">æŠ½é¸å®Ÿè¡Œ</button>
              </div>
              <div style="text-align:right; margin-top:10px;"><button class="btn-outline btn-sm" style="color:#888; border-color:#ccc;" onclick="deleteLastRound()">ç›´å‰å–æ¶ˆ</button></div>
            </div>
          </div>

          <div class="card"><h2>æœ¬æ—¥ã®ç·´ç¿’</h2><div id="dayLotteryResult"><p>æŠ½é¸çµæœã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p></div></div>

          <div id="subAdminCollection" style="display:none;">
            <div class="card" style="border-left: 5px solid var(--accent);">
              <h3 style="color:var(--accent);">é‹å–¶: é›†é‡‘</h3>
              <p class="small muted">å—å–æ¸ˆã¿ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ä¿å­˜ã€‚<br>ã‚¢ã‚¤ã‚³ãƒ³(P/ç¾)ã‚¿ãƒƒãƒ—ã§æ–¹æ³•å¤‰æ›´ã€‚</p>
              <div id="adminCollectionList"></div>
              <button class="btn-accent" style="margin-top:10px;" onclick="saveCollection()">é›†é‡‘çŠ¶æ³ã‚’ä¿å­˜</button>
            </div>
          </div>
          
          <div class="card" id="dayPayInfo" style="display:none;">
            <h2>å½“æ—¥PayPayæ”¯æ‰•ã„</h2>
            <div class="paypay-box">
              <strong>&lt;æ‰‹é †&gt;</strong><ol class="step-list"><li>ID <strong class="ppId">-</strong> ã‚³ãƒ”ãƒ¼</li><li>PayPayã§é€é‡‘</li><li>åç¾© <strong class="ppNameTarget">-</strong> ç¢ºèª</li><li>é‡‘é¡å…¥åŠ› (<strong>ãƒ¡ãƒ¢ã«åå‰</strong>)</li><li><span style="color:red;font-weight:bold;">å®Œäº†ç”»é¢ã‚’æ‹…å½“è€…ã«è¦‹ã›ã‚‹</span></li></ol>
              <div>ID: <span class="ppId" style="font-weight:bold;">-</span> <button class="btn-outline btn-copy" onclick="copyText('ppId')">ã‚³ãƒ”ãƒ¼</button></div>
            </div>
          </div>
        </div>
        <div id="restrictedMsg" style="text-align:center; padding:50px 0;"><h3>æ™‚é–“å¤–ã§ã™</h3><p class="muted">å½“æ—¥ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ç·´ç¿’æ—¥ã®<br>17:30ã€œ22:00ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚</p></div>
      </div>

      <div id="view-mypage" class="view-section">
        <div class="card">
          <h2>è¨­å®š</h2>
          <div style="margin-bottom:15px;">
            <label>è¡¨ç¤ºå</label><input type="text" id="myName">
            <label>åŒºåˆ†</label><select id="myCat"><option value="adult">ç¤¾ä¼šäºº</option><option value="college">å¤§å­¦ç”Ÿ</option><option value="student">é«˜æ ¡ç”Ÿä»¥ä¸‹</option></select>
            <button class="btn-primary" onclick="saveProfile()">ä¿å­˜ã™ã‚‹</button>
          </div>
          <div id="demoRoleSwitcher" style="display:none; margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
            <p class="small" style="font-weight:bold; color:#f0ad4e;">ã€ãƒ‡ãƒ¢ã€‘æ¨©é™åˆ‡ã‚Šæ›¿ãˆ</p>
            <div style="display:flex; gap:5px;">
              <button class="btn-outline btn-sm" onclick="setDemoRole('member')">ä¸€èˆ¬</button>
              <button class="btn-outline btn-sm" onclick="setDemoRole('sub_admin')">æº–ç®¡ç†</button>
              <button class="btn-outline btn-sm" onclick="setDemoRole('admin')">ç®¡ç†</button>
            </div>
          </div>
          <div id="demoDataGen" style="display:none; margin-top:10px;">
             <button class="btn-danger btn-sm" onclick="genDebugData()">[Demo] ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</button>
          </div>
        </div>
        <div class="card"><h2>ä»Šæœˆã®å‚åŠ æ•° <span id="periodMonth" class="small muted" style="font-weight:normal;"></span></h2><table id="rankMonth"><tr><td>Loading...</td></tr></table></div>
        <div class="card"><h2>ä»Šå¹´ã®å‚åŠ æ•° <span id="periodYear" class="small muted" style="font-weight:normal;"></span></h2><table id="rankYear"><tr><td>Loading...</td></tr></table></div>
      </div>

      <div id="view-admin-menu" class="view-section">
        <div class="admin-grid">
          <div class="admin-menu-btn" onclick="navigateTo('admin-acc')"><span class="admin-icon">ğŸ’°</span><br><span class="admin-label">å¸³ç°¿</span></div>
          <div class="admin-menu-btn" onclick="navigateTo('admin-sched')"><span class="admin-icon">ğŸ“…</span><br><span class="admin-label">æ—¥ç¨‹ç™»éŒ²</span></div>
          <div class="admin-menu-btn" onclick="navigateTo('admin-fees')"><span class="admin-icon">ğŸ·ï¸</span><br><span class="admin-label">ä¼šè²»ãƒ»å®šå“¡</span></div>
          <div class="admin-menu-btn" onclick="navigateTo('admin-roles')"><span class="admin-icon">ğŸ”‘</span><br><span class="admin-label">æ¨©é™è¨­å®š</span></div>
        </div>
      </div>

      <div id="view-admin-acc" class="view-section">
        <button class="btn-outline btn-sm" onclick="navigateTo('admin-menu')">â† æˆ»ã‚‹</button>
        <div class="card" style="margin-top:10px;">
          <h2>å¸³ç°¿</h2>
          <div id="accSummary" style="margin-bottom:15px; font-weight:bold; background:#e3f2fd; padding:10px; border-radius:8px;">Loading...</div>
          <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="btn-outline" style="flex:1;" onclick="document.getElementById('accListArea').style.display='block';document.getElementById('accEntryArea').style.display='none';">å±¥æ­´ç¢ºèª</button>
            <button class="btn-outline" style="flex:1;" id="btnAccEntry" onclick="document.getElementById('accListArea').style.display='none';document.getElementById('accEntryArea').style.display='block';">è¨˜å¸³ãƒ»ç§»å‹•</button>
          </div>
          <div id="accListArea">
             <div style="display:flex; gap:5px; margin-bottom:5px;">
              <select id="filterAccMonth" style="padding:6px; font-size:0.8rem;" onchange="filterAccounting()"><option value="all">å…¨æœŸé–“</option></select>
              <select id="filterAccType" style="padding:6px; font-size:0.8rem;" onchange="filterAccounting()"><option value="all">å…¨ã¦</option><option value="income">åå…¥</option><option value="expense">æ”¯å‡º</option></select>
            </div>
            <div id="adminAccList" class="small" style="max-height:300px; overflow-y:auto;"></div>
          </div>
          <div id="accEntryArea" style="display:none;">
            <h3>åæ”¯å…¥åŠ›</h3>
            <select id="accType"><option value="expense">æ”¯å‡º (æ”¯æ‰•)</option><option value="income">åå…¥ (å—å–)</option></select>
            <select id="accWallet"><option value="cash">ç¾é‡‘</option><option value="paypay">PayPay</option><option value="bank">å£åº§</option></select>
            <input type="number" id="accAmount" placeholder="é‡‘é¡"><input type="text" id="accDesc" placeholder="å†…å®¹ (ä¾‹: ã‚·ãƒ£ãƒˆãƒ«ä»£)">
            <button class="btn-primary" onclick="saveAccounting()">ä¿å­˜</button>
            <h3 style="margin-top:30px;">è³‡é‡‘ç§»å‹•</h3>
            <div style="display:flex; align-items:center; gap:5px; margin-bottom:10px;">
              <select id="trFrom" style="flex:1;"><option value="paypay">PayPay</option><option value="bank">å£åº§</option><option value="cash">ç¾é‡‘</option></select><span>â†’</span><select id="trTo" style="flex:1;"><option value="bank">å£åº§</option><option value="cash">ç¾é‡‘</option><option value="paypay">PayPay</option></select>
            </div>
            <input type="number" id="trAmount" placeholder="ç§»å‹•é‡‘é¡">
            <button class="btn-accent" onclick="saveTransfer()">ç§»å‹•ã‚’è¨˜éŒ²</button>
          </div>
        </div>
      </div>

      <div id="view-admin-sched" class="view-section">
        <button class="btn-outline btn-sm" onclick="navigateTo('admin-menu')">â† æˆ»ã‚‹</button>
        <div class="card" style="margin-top:10px;">
          <h2>æ—¥ç¨‹ç™»éŒ²</h2>
          <p class="muted">ä»Šå¾Œã®æ—¥æ›œæ—¥ä¸€è¦§ã€‚é–‹å‚¬ã™ã‚‹æ—¥ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ä¿å­˜ã€‚<br>â€»ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</p>
          <div id="schedList" style="max-height:400px; overflow-y:auto; border:1px solid #eee; padding:10px; margin-bottom:10px;"></div>
          <button class="btn-primary" onclick="saveSchedule()">é¸æŠã—ãŸæ—¥ç¨‹ã‚’ç™»éŒ²/å‰Šé™¤</button>
        </div>
      </div>

      <div id="view-admin-fees" class="view-section">
        <button class="btn-outline btn-sm" onclick="navigateTo('admin-menu')">â† æˆ»ã‚‹</button>
        <div class="card" style="margin-top:10px;">
          <h2>è¨­å®šå¤‰æ›´</h2>
          <div style="margin-bottom:10px;"><label>ç¤¾ä¼šäºº ä¼šè²»</label><input type="number" id="cfgAdult"></div>
          <div style="margin-bottom:10px;"><label>å¤§å­¦ç”Ÿ ä¼šè²»</label><input type="number" id="cfgCollege"></div>
          <div style="margin-bottom:10px;"><label>é«˜æ ¡ç”Ÿä»¥ä¸‹ ä¼šè²»</label><input type="number" id="cfgStudent"></div>
          <div style="margin-bottom:10px;"><label>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®šå“¡ (äºº)</label><input type="number" id="cfgCapacity"></div>
          <button class="btn-primary" onclick="saveFees()">è¨­å®šã‚’ä¿å­˜</button>
        </div>
      </div>

      <div id="view-admin-roles" class="view-section">
        <button class="btn-outline btn-sm" onclick="navigateTo('admin-menu')">â† æˆ»ã‚‹</button>
        <div class="card" style="margin-top:10px;">
          <h2>æ¨©é™è¨­å®š</h2>
          <p class="muted small">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®æ¨©é™ã‚’å¤‰æ›´ã—ã¾ã™ã€‚</p>
          <div id="adminMemberList" style="max-height:400px; overflow-y:auto;"></div>
        </div>
      </div>
    </div>

    <div class="bottom-nav">
      <div class="nav-item active" onclick="navigateTo('register')" id="nav-register"><span class="nav-icon">ğŸ“…</span>ç™»éŒ²</div>
      <div class="nav-item" onclick="navigateTo('day')" id="nav-day"><span class="nav-icon">ğŸ¸</span>å½“æ—¥</div>
      <div class="nav-item" onclick="navigateTo('mypage')" id="nav-mypage"><span class="nav-icon">ğŸ‘¤</span>ãƒã‚¤ãƒšãƒ¼ã‚¸</div>
      <div class="nav-item" onclick="navigateTo('admin-menu')" id="nav-admin" style="display:none;"><span class="nav-icon">âš™ï¸</span>ç®¡ç†</div>
    </div>
  </div>

  <script>
    // --- 1. GLOBALS & CONFIG ---
    const API_URL = 'https://script.google.com/macros/s/AKfycbx3QQMnnjQl-3bb77-HO9SVztNzaBpl8sXTHNBm7ydsLZMK50dlNqau-qHXU16HufrEBQ/exec';
    const LIFF_ID = '2008652596-Gew4K44V';
    const params = new URLSearchParams(window.location.search);
    const INIT_PAGE = params.get('page') || 'register';

    let state = { me: null, paypay: null, event: null, reg: null, participants: [], isDebug: false, feeConfig: {adult:800, college:600, student:500} };
    let loadedData = { future: false, ranking: false, admin: false };
    let rawAccountingList = [];
    let registeredDates = [];

    // --- 2. FUNCTION DECLARATIONS ---
    function setBusy(isBusy) { document.getElementById('loading').style.display = isBusy ? 'flex' : 'none'; }
    async function callApi(action, data, isPost=false) {
      let url = `${API_URL}?action=${action}`;
      let opts = { method: isPost?'POST':'GET' };
      if(isPost) { opts.body = JSON.stringify(data); opts.headers = {'Content-Type':'text/plain'}; }
      else if(data) { Object.keys(data).forEach(k => url += `&${k}=${encodeURIComponent(data[k])}`); }
      const r = await fetch(url, opts);
      const json = await r.json();
      if(json.is_demo_mock) { alert('ã€ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã€‘\nã‚µãƒ¼ãƒãƒ¼ã¸ã®æ›¸ãè¾¼ã¿ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚\n(æˆåŠŸã—ãŸã‚ˆã†ã«è¦‹ã›ã‹ã‘ã¾ã™)'); return { ok: true, data: {}, is_demo_mock: true }; }
      return json;
    }
    function navigateTo(viewId) {
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('view-active'));
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      let navId = '';
      if(viewId === 'register') navId = 'nav-register';
      else if(viewId === 'day') navId = 'nav-day';
      else if(viewId === 'mypage') navId = 'nav-mypage';
      else if(viewId.startsWith('admin')) navId = 'nav-admin';
      if(navId) document.getElementById(navId).classList.add('active');
      document.getElementById('view-' + viewId).classList.add('view-active');
      if(viewId === 'register' && !loadedData.future) { setBusy(true); loadedData.future = true; loadFutureAndPast().then(()=>setBusy(false)); }
      if(viewId === 'mypage' && !loadedData.ranking) { setBusy(true); loadedData.ranking = true; loadRankings().then(()=>setBusy(false)); }
      if(viewId.startsWith('admin') && !loadedData.admin) { setBusy(true); loadedData.admin = true; loadAdminData().then(()=>setBusy(false)); }
      if(viewId === 'day') checkDayAccess();
    }
    function initUI(isFirst) {
      if(state.me) {
        document.getElementById('myName').value = state.me.display_name;
        document.getElementById('myCat').value = state.me.category;
        const r = state.me.role;
        const isAdmin = (r==='admin'||r==='sub_admin');
        if(isAdmin) {
          document.getElementById('subAdminArea').style.display = 'block';
          document.getElementById('subAdminCollection').style.display = 'block';
          document.getElementById('nav-admin').style.display = 'block';
          if(r==='admin') document.getElementById('cancelEventArea').style.display = 'block';
          else {
             document.querySelector('.admin-menu-btn[onclick*="fees"]').style.display = 'none';
             document.querySelector('.admin-menu-btn[onclick*="roles"]').style.display = 'none';
          }
        }
      }
      if(state.paypay) {
        const setT = (s,t) => document.querySelectorAll(s).forEach(e => e.innerText=t);
        setT('.ppId', state.paypay.id); setT('.ppNameTarget', state.paypay.receiver);
      }
      if(state.isDebug) {
        document.getElementById('debugRibbon').style.display='block';
        if(['admin','sub_admin'].includes(state.me.role)) document.getElementById('debugAdminArea').style.display='block';
        document.getElementById('demoRoleSwitcher').style.display='block';
        if(['admin','sub_admin'].includes(state.me.role)) document.getElementById('demoDataGen').style.display='block';
      }
      setBusy(false);
      document.getElementById('app').style.display = 'block';
      navigateTo(isFirst ? 'mypage' : INIT_PAGE);
    }
    window.setDemoRole = function(role) { state.me.role = role; alert(`æ¨©é™ã‚’ ${role} ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚\nç”»é¢ã‚’æ›´æ–°ã—ã¾ã™ã€‚`); ['subAdminArea','subAdminCollection','nav-admin','cancelEventArea'].forEach(id=>document.getElementById(id).style.display='none'); document.querySelector('.admin-menu-btn[onclick*="fees"]').style.display = ''; document.querySelector('.admin-menu-btn[onclick*="roles"]').style.display = ''; initUI(false); }

    window.saveAccounting = async function() { const amt=document.getElementById('accAmount').value; if(!amt)return alert('é‡‘é¡å…¥åŠ›'); setBusy(true); await callApi('save_accounting',{type:document.getElementById('accType').value,wallet:document.getElementById('accWallet').value,amount:amt,desc:document.getElementById('accDesc').value},true); alert('ä¿å­˜'); loadAdminData(); setBusy(false); }
    window.saveTransfer = async function() { const amt=document.getElementById('trAmount').value; if(!amt)return alert('é‡‘é¡å…¥åŠ›'); setBusy(true); await callApi('save_transfer',{amount:amt,from_wallet:document.getElementById('trFrom').value,to_wallet:document.getElementById('trTo').value},true); alert('ç§»å‹•'); loadAdminData(); setBusy(false); }
    window.saveFees = async function() { if(!confirm('ä¿å­˜?'))return; setBusy(true); await callApi('save_fee_config',{adult:document.getElementById('cfgAdult').value,college:document.getElementById('cfgCollege').value,student:document.getElementById('cfgStudent').value,capacity:document.getElementById('cfgCapacity').value},true); alert('ä¿å­˜'); setBusy(false); }
    window.saveSchedule = async function() { const dates=[]; document.querySelectorAll('.sch-chk:checked').forEach(c=>dates.push(c.value)); if(confirm('ç™»éŒ²ãƒ»å‰Šé™¤ã‚’å®Ÿè¡Œ?')) { setBusy(true); await callApi('save_schedule',{dates:dates},true); alert('æ›´æ–°'); await loadAdminData(); setBusy(false); } }
    window.updateRole = async function(mid, role) { await callApi('update_role', { member_id: mid, role: role }, true); }
    window.cancelEvent = async function() { if(confirm('ä¸­æ­¢ã—ã¾ã™ã‹?')) { setBusy(true); await callApi('cancel_event', { event_id: state.event.event_id }, true); alert('ä¸­æ­¢'); location.reload(); } }
    window.filterAccounting = function() { const m=document.getElementById('filterAccMonth').value; const t=document.getElementById('filterAccType').value; const f=rawAccountingList.filter(a=>{ const d=new Date(a.raw_date); const y=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; return(m==='all'||m===y)&&(t==='all'||a.type===t); }); renderAccountingList(f); }
    function renderAccountingList(list) { const w={cash:'ç¾é‡‘',paypay:'PayPay',bank:'å£åº§'}; document.getElementById('adminAccList').innerHTML=list.map(a=>`<div style="border-bottom:1px solid #eee; padding:6px; font-size:0.85rem;">${a.date} <span class="badge ${a.type=='income'?'bg-green':'bg-gray'}">${a.type=='income'?'å':'æ”¯'}</span> ${a.amount}å†† (${w[a.wallet]||a.wallet}) ${a.desc}</div>`).join(''); }

    window.executeLottery = async function() { 
      if(!confirm('æŠ½é¸å®Ÿè¡Œ?'))return; 
      if(state.isDebug) { alert('(Demo) å®Œäº†'); location.reload(); return; }
      const s={}; state.participants.forEach(p=>{const v=document.getElementById(`stat-${p.participant_id}`).value;if(v!==p.status)s[p.participant_id]=v;}); setBusy(true); await callApi('run_lottery',{event_id:state.event.event_id,statuses:s},true); alert('å®Œäº†'); loadDayData(); setBusy(false); 
    }
    window.saveCollection = async function() {
      const ids=[]; const methods={};
      document.querySelectorAll('.col-chk:checked:not([disabled])').forEach(e=>{ ids.push(e.value); const icon=document.getElementById(`pay-icon-${e.value}`); if(icon) methods[e.value]=icon.dataset.method; });
      if(!ids.length) return alert('ãƒã‚§ãƒƒã‚¯ãªã—');
      if(state.isDebug) { alert('(Demo) ä¿å­˜'); return; }
      if(confirm('ä¿å­˜ã—ã¾ã™ã‹?')) { setBusy(true); await callApi('update_collection',{event_id:state.event.event_id,paid_ids:ids,methods:methods},true); alert('ä¿å­˜'); loadDayData(); setBusy(false); }
    }
    window.togglePayIcon = function(pid) {
      const el = document.getElementById(`pay-icon-${pid}`); const next = (el.dataset.method === 'day_cash') ? 'day_paypay' : 'day_cash';
      el.dataset.method = next; el.className = next === 'day_paypay' ? 'pay-icon pp' : 'pay-icon cash'; el.innerText = next === 'day_paypay' ? 'P' : 'ç¾';
    }
    window.deleteLastRound = async function() { if(confirm('å–æ¶ˆ?')) { setBusy(true); await callApi('delete_round', { event_id: state.event.event_id }); loadDayData(); setBusy(false); } }
    window.manualAddUser = async function() { const n=prompt('åå‰:'); if(n) { setBusy(true); await callApi('manual_add_participant', { event_id: state.event.event_id, name: n }); loadDayData(); setBusy(false); } }
    window.genDebugData = async function() { if(confirm('ç”Ÿæˆ?')) { setBusy(true); await callApi('generate_debug', {}, true); alert('å®Œäº†'); location.reload(); } }

    window.togglePayMethod = function() { const val=document.querySelector('input[name="payMethod"]:checked')?.value; document.getElementById('payDetail-advance').style.display=(val==='advance')?'block':'none'; }
    window.submitRegistration = async function() {
      const method = document.querySelector('input[name="payMethod"]:checked')?.value;
      if(!method) return alert('æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„');
      let isPaid = false;
      if(method === 'advance') { if(!document.getElementById('chkPaidAdvance').checked) return alert('ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„'); isPaid = true; }
      const guests = [];
      if(document.getElementById('friendToggle').checked) {
        const names = document.querySelectorAll('.g-name'); const cats = document.querySelectorAll('.g-cat');
        for(let i=0; i<names.length; i++) { if(!names[i].value) return alert('ã‚²ã‚¹ãƒˆåã‚’å…¥åŠ›'); guests.push({name:names[i].value, category:cats[i].value}); }
      }
      if(state.isDebug) { alert('(Demo) ç™»éŒ²å®Œäº†'); location.reload(); return; }
      if(confirm('ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ')) { setBusy(true); try { await callApi('register', { event_id: state.event.event_id, member_id: state.me.member_id, status: 'reserved', guests: guests, is_paid: isPaid, pay_method: method }, true); alert('ç™»éŒ²ã—ã¾ã—ãŸ'); location.reload(); } catch(e) { setBusy(false); alert(e.message); } }
    }
    window.cancelRegistration = async function() { 
      if(state.isDebug) { alert('(Demo) ã‚­ãƒ£ãƒ³ã‚»ãƒ«'); return; }
      if(confirm('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) { setBusy(true); await callApi('register', { event_id: state.event.event_id, member_id: state.me.member_id, status: 'canceled', guests: [] }, true); alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ'); location.reload(); } 
    }
    window.saveProfile = async function() { const n=document.getElementById('myName').value; const c=document.getElementById('myCat').value; if(!n) return; setBusy(true); await callApi('upsert_member', { lineUserId: state.me.line_user_id, display_name: n, category: c }, true); alert('ä¿å­˜ã—ã¾ã—ãŸ'); setBusy(false); }
    window.toggleGuests = function() { const on = document.getElementById('friendToggle').checked; document.getElementById('guestSection').style.display = on?'block':'none'; if(on && document.getElementById('guestCount').value==0) { document.getElementById('guestCount').value=1; renderGuestInputs(); } calcTotal(); }
    window.renderGuestInputs = function() { const cnt = document.getElementById('guestCount').value; const box = document.getElementById('guestInputs'); box.innerHTML = ''; for(let i=0; i<cnt; i++) box.innerHTML += `<div class="guest-row"><input type="text" class="g-name" placeholder="åå‰" required><select class="g-cat" onchange="calcTotal()"><option value="adult">ç¤¾ä¼šäºº</option><option value="college">å¤§å­¦ç”Ÿ</option><option value="student">é«˜æ ¡ç”Ÿ</option></select></div>`; calcTotal(); }
    window.calcTotal = function() { if(!state.me) return; let sum = getFee(state.me.category); document.getElementById('feeDisplay').innerText = `æ”¯æ‰•é‡‘é¡(æœ¬äººåˆ†): ${sum} å††`; }
    function getFee(c){ return state.feeConfig[c]||800; }
    window.copyText = function(id) { const el = document.querySelector('.'+id) || document.getElementById(id); const t = el.tagName==='INPUT' ? el.value : el.innerText; if (navigator.clipboard) { navigator.clipboard.writeText(t).then(()=>alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')).catch(()=>prompt('ã‚³ãƒ”ãƒ¼', t)); } else { prompt('ã‚³ãƒ”ãƒ¼', t); } }
    window.closeModal = function() { document.getElementById('infoModal').style.display = 'none'; }
    window.showPastDetail = async function(eid) { setBusy(true); const res=await callApi('get_past_event_detail',{event_id:eid}); setBusy(false); const html=res.participants.length?res.participants.map(p=>`<div style="border-bottom:1px solid #eee; padding:5px; display:flex; justify-content:space-between;"><span>${p.name}${p.guests}</span></div>`).join(''):'å‚åŠ è€…ãªã—'; document.getElementById('modalContent').innerHTML=html; document.getElementById('infoModal').style.display='flex'; }
    function renderRegStatus() {
      const badge = document.getElementById('regStatusBadge'); const btnReg = document.getElementById('btnRegister'); const btnCancel = document.getElementById('btnCancel');
      if(state.reg && state.reg.status === 'reserved') {
        badge.innerText = 'å‚åŠ ç™»éŒ²æ¸ˆ'; badge.className = 'badge bg-green'; btnReg.innerText = 'ç™»éŒ²æ›´æ–°'; btnCancel.style.display = 'inline-block';
        const method = state.reg.payment_method;
        if(method) {
          const radio = document.querySelector(`input[name="payMethod"][value="${method}"]`); if(radio) radio.checked = true;
          if(method === 'advance' && state.reg.payment_status === 'paid_advance') { document.getElementById('chkPaidAdvance').checked = true; document.getElementById('chkPaidAdvance').disabled = true; }
        }
      } else { badge.innerText = 'æœªç™»éŒ²'; badge.className = 'badge bg-gray'; btnReg.innerText = 'å‚åŠ ç™»éŒ²'; btnCancel.style.display = 'none'; }
      togglePayMethod(); calcTotal();
    }
    function checkDayAccess() {
      if(!state.event) return;
      const now = new Date(); const hh = now.getHours(); const mm = now.getMinutes(); const t = hh * 60 + mm;
      if(state.isDebug || (t >= 1050 && t <= 1320)) { document.getElementById('dayContent').style.display = 'block'; document.getElementById('restrictedMsg').style.display = 'none'; loadDayData(); }
      else { document.getElementById('dayContent').style.display = 'none'; document.getElementById('restrictedMsg').style.display = 'block'; }
    }
    async function loadDayData() {
      setBusy(true); const res = await callApi('get_participants_detail', { event_id: state.event.event_id }); setBusy(false);
      state.participants = res.data.participants || []; const rounds = res.data.allRounds || []; 
      const box = document.getElementById('dayLotteryResult');
      if(rounds.length > 0) {
        let html = ''; rounds.forEach(r => { html += `<div style="margin-bottom:15px; border-bottom:1px dashed #ccc; padding-bottom:10px;"><p style="font-weight:bold; margin:0 0 5px;">ç¬¬${r.round_no}ãƒ©ã‚¦ãƒ³ãƒ‰</p>`; Object.keys(r.result.courts).forEach(k => { const c = r.result.courts[k]; html += `<div class="court-box"><span class="court-name">${k}</span><div class="match-pair">${c[0][0]}<br>${c[0][1]}</div><div class="match-pair" style="font-size:0.9rem;">vs</div><div class="match-pair">${c[1][0]}<br>${c[1][1]}</div></div>`; }); if(r.result.rest && r.result.rest.length) html += `<div class="small muted">ä¼‘æ†©: ${r.result.rest.join(', ')}</div>`; html += `</div>`; }); box.innerHTML = html;
      } else { box.innerHTML = '<p>æŠ½é¸çµæœã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>'; }
      const myP = state.participants.find(p => p.member_id === state.me.member_id);
      document.getElementById('dayPayInfo').style.display = (myP && myP.payment_method === 'day_paypay' && myP.payment_status !== 'paid') ? 'block' : 'none';
      if(['admin','sub_admin'].includes(state.me.role)) renderAdminLists();
    }
    function renderAdminLists() {
      document.getElementById('adminLotteryList').innerHTML = state.participants.map(p => `
        <div class="admin-list-item"><div class="admin-item-left"><span class="admin-name">${p.name}</span><span class="small muted" style="margin-left:5px;">(${p.play_count})</span></div><div class="admin-item-right"><select id="stat-${p.participant_id}" class="status-select"><option value="participating" ${p.status=='participating'?'selected':''}>å‚åŠ </option><option value="late" ${p.status=='late'?'selected':''}>é…åˆ»</option><option value="leave" ${p.status=='leave'?'selected':''}>æ—©é€€</option><option value="rest_request" ${p.status=='rest_request'?'selected':''}>ä¼‘æ†©</option></select></div></div>`).join('');
      document.getElementById('adminCollectionList').innerHTML = state.participants.map(p => {
        const isPaid = p.payment_status === 'paid' || p.payment_status === 'paid_advance';
        const method = p.payment_method || 'day_cash'; const icon = (method === 'advance' || method === 'day_paypay') ? '<span class="pay-icon pp">P</span>' : '<span class="pay-icon cash">ç¾</span>'; const stTxt = isPaid ? 'æ¸ˆ' : 'æœªæ‰•';
        return `<div class="admin-list-item ${isPaid?'paid-row':''}"><div class="admin-item-left"><label><input type="checkbox" class="col-chk" value="${p.participant_id}" data-category="${p.category}" ${isPaid?'disabled checked':''}> <span class="admin-name">${p.name}</span></label></div><div class="admin-item-right"><span id="pay-icon-${p.participant_id}" class="${(method === 'advance' || method === 'day_paypay') ? 'pay-icon pp' : 'pay-icon cash'}" data-method="${method}" ${isPaid?'':`onclick="togglePayIcon('${p.participant_id}')"`}>${(method === 'advance' || method === 'day_paypay') ? 'P' : 'ç¾'}</span> <span class="pay-status">${stTxt}</span></div></div>`;
      }).join('');
      // No sum calculation here anymore
    }
    async function loadAdminData() {
      setBusy(true); const res = await callApi('get_admin_init'); setBusy(false);
      const s = res.summary; document.getElementById('accSummary').innerText = `åˆè¨ˆ: ${s.total}å†† (ç¾:${s.cash}/P:${s.paypay}/å£:${s.bank})`;
      document.getElementById('cfgAdult').value = res.fees.adult; document.getElementById('cfgCollege').value = res.fees.college; document.getElementById('cfgStudent').value = res.fees.student; document.getElementById('cfgCapacity').value = res.fees.capacity || 16;
      state.feeConfig = res.fees; 
      document.getElementById('adminMemberList').innerHTML = res.members.map(m => `
        <div class="admin-list-item"><div class="admin-item-left"><span class="admin-name">${m.display_name}</span></div><div class="admin-item-right"><select onchange="updateRole('${m.member_id}', this.value)" class="status-select"><option value="admin" ${m.role=='admin'?'selected':''}>ç®¡ç†è€…</option><option value="sub_admin" ${m.role=='sub_admin'?'selected':''}>æº–ç®¡ç†è€…</option><option value="member" ${m.role=='member'?'selected':''}>ãƒ¡ãƒ³ãƒãƒ¼</option></select></div></div>`).join('');
      if(state.me.role === 'sub_admin') document.getElementById('btnAccEntry').style.display = 'none';
      const accRes = await callApi('get_accounting_list'); rawAccountingList = accRes.list; const monthSet = new Set(); rawAccountingList.forEach(a => { const d=new Date(a.raw_date); monthSet.add(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`); }); const mSel = document.getElementById('filterAccMonth'); mSel.innerHTML = '<option value="all">å…¨æœŸé–“</option>'; Array.from(monthSet).sort().reverse().forEach(m => mSel.innerHTML += `<option value="${m}">${m}</option>`); filterAccounting(); registeredDates = res.registeredDates || []; renderScheduleGen();
    }
    function renderScheduleGen() { const list = document.getElementById('schedList'); list.innerHTML = ''; const today = new Date(); for(let i=0; i<55; i++) { const d = new Date(); d.setDate(today.getDate() + (7 - today.getDay()) + (i*7)); const dStr = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`; const isReg = registeredDates.includes(dStr); list.innerHTML += `<label class="inline-label" style="border-bottom:1px solid #eee; padding:8px;"><input type="checkbox" class="sch-chk" value="${dStr}" ${isReg?'checked':''}> ${dStr} (æ—¥)</label>`; } }
    async function loadFutureAndPast() {
      document.getElementById('lazyRegister').style.display='block';
      const [fut, past] = await Promise.all([callApi('get_future_events'), callApi('get_past_events')]);
      const boxF = document.getElementById('futureList'); const boxP = document.getElementById('pastList');
      if(!fut.events || !fut.events.length) boxF.innerText = 'äºˆå®šãªã—'; else boxF.innerHTML = fut.events.map(e => `<div style="border-bottom:1px solid #eee; padding:8px 0;">${e.date_str} ${e.start_time}-${e.end_time}</div>`).join('');
      if(!past.events || !past.events.length) boxP.innerText = 'å±¥æ­´ãªã—'; else boxP.innerHTML = past.events.map(e => `<button class="btn-outline btn-sm" style="display:block; width:100%; margin-bottom:5px; text-align:left;" onclick="showPastDetail('${e.event_id}')">${e.date_str} (å‚åŠ è€…)</button>`).join('');
    }
    async function loadRankings() { setBusy(true); const res = await callApi('get_rankings'); setBusy(false); const now = new Date(); const y=now.getFullYear(); const m=(now.getMonth()+1).toString().padStart(2,'0'); document.getElementById('periodMonth').innerText = `(${y}/${m}/01ã€œ)`; document.getElementById('periodYear').innerText = `(${y}/01/01ã€œ)`; renderTable('rankMonth', res.data.month); renderTable('rankYear', res.data.year); }
    function renderTable(id, list) { const el = document.getElementById(id); if(!list.length) { el.innerHTML = '<tr><td>ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>'; return; } el.innerHTML = list.map((r,i) => `<tr><td style="width:30px;">${i+1}</td><td class="${i==0?'rank-1':''}">${r.name}</td><td style="text-align:right;">${i==0?r.month||r.year:r.month||r.year}å›</td></tr>`).join(''); }
    window.onload = async function() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        const [userRes, weekRes] = await Promise.all([callApi('get_me', { lineUserId: profile.userId }), callApi('get_this_week')]);
        if (!userRes.exists) {
          await callApi('upsert_member', { lineUserId: profile.userId, display_name: profile.displayName }, true);
          const retry = await callApi('get_me', { lineUserId: profile.userId });
          state.me = retry.member; state.paypay = userRes.paypay_config; initUI(true);
        } else {
          state.me = userRes.member; state.paypay = userRes.paypay_config; state.isDebug = userRes.is_debug; initUI(false);
        }
        if(weekRes.event) {
          state.event = weekRes.event;
          document.getElementById('thisWeekInfo').innerHTML = `<div>${state.event.date_str} ${state.event.start_time}-${state.event.end_time}</div>`;
          document.getElementById('regFormArea').style.display = 'block';
          document.getElementById('ppMsg').value = `${state.event.date_str} ${state.me.display_name}`;
          const mems = weekRes.registrations || [];
          document.getElementById('currentParticipantsCount').innerText = mems.reduce((a,b)=>a+1+b.guests, 0);
          document.getElementById('regMembersList').innerHTML = mems.map(m => `<span class="member-list-chip">${m.name}${m.guests>0?'+'+m.guests:''}</span>`).join('');
          const myReg = await callApi('get_my_registration', { event_id: state.event.event_id, member_id: state.me.member_id });
          state.reg = myReg.registration; renderRegStatus();
        }
        if(state.me.role !== 'member') { const adm = await callApi('get_admin_init'); state.feeConfig = adm.fees; }
        if(INIT_PAGE==='register') { loadedData.future=true; loadFutureAndPast(); }
      } catch (err) { alert('èµ·å‹•ã‚¨ãƒ©ãƒ¼: ' + err.message); }
    };
  </script>
</body>
</html>