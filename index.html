<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ã‚²ãƒ¤ãƒã‚¯ãƒ©ãƒ–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <style>
    :root { --primary: #06c755; --bg: #f2f4f8; --card: #ffffff; --text: #333; --danger: #e53935; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
    .container { max-width: 600px; margin: 0 auto; padding: 15px; }
    
    /* ã‚«ãƒ¼ãƒ‰ */
    .card { background: var(--card); padding: 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-bottom: 16px; }
    h2 { font-size: 1.1rem; margin: 0 0 10px; border-bottom: 2px solid var(--primary); padding-bottom: 5px; display: inline-block; }
    h3 { font-size: 1rem; margin: 15px 0 8px; font-weight: bold; }
    .muted { color: #888; font-size: 0.85rem; }
    .small { font-size: 0.8rem; }
    
    /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ (ä¸‹éƒ¨å›ºå®š) */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; padding-bottom: env(safe-area-inset-bottom); z-index: 100; }
    .nav-item { flex: 1; text-align: center; padding: 10px 0; font-size: 0.7rem; color: #888; cursor: pointer; }
    .nav-item.active { color: var(--primary); font-weight: bold; }
    .nav-icon { font-size: 1.5rem; display: block; margin-bottom: 2px; }
    
    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px; font-size: 1rem; }
    button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 8px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
    
    /* ã‚²ã‚¹ãƒˆå…¥åŠ› */
    .guest-row { display: flex; gap: 8px; }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
    .bg-green { background: #e8f5e9; color: #2e7d32; }
    .bg-red { background: #ffebee; color: #c62828; }
    .bg-gray { background: #eee; color: #666; }

    /* PayPay */
    .paypay-box { background: #f0f0f0; padding: 12px; border-radius: 8px; margin-top: 10px; text-align: center; }
    .copy-btn { font-size: 0.8rem; padding: 4px 8px; margin-left: 5px; width: auto; display: inline-block; }

    /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
    th { color: #888; font-weight: normal; }
    .rank-1 { color: #d4af37; font-weight: bold; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div id="loading" style="text-align:center; padding:50px;">èª­ã¿è¾¼ã¿ä¸­...</div>

  <div id="app" style="display:none;">
    <div class="container">
      
      <div id="tab-register" class="page">
        <div class="card">
          <h2>ä»Šé€±ã®ç·´ç¿’</h2>
          <div id="thisWeekInfo">
            <p class="muted">ç¾åœ¨ã€å‹Ÿé›†ä¸­ã®ç·´ç¿’ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          </div>
          
          <div id="regFormArea" style="display:none; margin-top:15px;">
            <div id="regStatusBadge" class="badge bg-gray" style="display:inline-block; margin-bottom:10px;">æœªç™»éŒ²</div>
            
            <form id="regForm">
              <label>
                <input type="checkbox" id="friendToggle" onchange="toggleGuests()"> å‹é”ã‚’é€£ã‚Œã¦ã„ã
              </label>
              <div id="guestSection" style="display:none; background:#f9f9f9; padding:10px; border-radius:8px;">
                <label>äººæ•°: <input type="number" id="guestCount" min="0" max="5" value="0" onchange="renderGuestInputs()"></label>
                <div id="guestInputs"></div>
              </div>
              <div style="margin-top:15px; text-align:center; font-weight:bold; color:var(--primary);" id="feeDisplay">
                æ”¯æ‰•äºˆå®š: - å††
              </div>
              <button type="button" id="btnRegister" class="btn-primary" onclick="submitRegistration()">å‚åŠ ç™»éŒ²ã™ã‚‹</button>
              <button type="button" id="btnCancel" class="btn-danger" style="display:none;" onclick="cancelRegistration()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </form>

            <div id="prePaySection" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
              <h3>äº‹å‰PayPayæ”¯æ‰•ã„</h3>
              <p class="small muted">äº‹å‰ã«æ”¯æ‰•ã†å ´åˆã¯ã€ä»¥ä¸‹ã®IDã¸é€é‡‘ã—ã¦ãã ã•ã„ã€‚</p>
              <div class="paypay-box">
                ID: <span id="ppId" style="font-weight:bold;">-</span> <button class="btn-outline copy-btn" onclick="copyText('ppId')">ã‚³ãƒ”ãƒ¼</button><br>
                åç¾©: <span id="ppName">-</span><br>
                <input type="text" id="ppMsg" readonly style="margin-top:5px; font-size:0.8rem; color:#666; background:#fff;" value="ç·´ç¿’æ—¥ æ°å">
                <button class="btn-outline copy-btn" onclick="copyText('ppMsg')">ãƒ¡ãƒ¢ã‚’ã‚³ãƒ”ãƒ¼</button>
              </div>
              <label style="margin-top:10px; display:flex; align-items:center;">
                <input type="checkbox" id="chkPaid" style="width:auto; margin-right:8px;"> PayPayã§æ”¯æ‰•ã„ã¾ã—ãŸ
              </label>
              <button id="btnPayReport" class="btn-outline" onclick="reportPayment()">æ”¯æ‰•ã„å®Œäº†ã‚’å ±å‘Š</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>ä»Šå¾Œã®äºˆå®š</h2>
          <div id="futureList" class="small">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <div class="card">
          <h2>éå»ã®å±¥æ­´</h2>
          <div id="pastList" class="small">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>

      <div id="tab-day" class="page" style="display:none;">
        <div class="card">
          <h2>æœ¬æ—¥ã®ç·´ç¿’</h2>
          <p class="small muted">æŠ½é¸çµæœã‚„æ”¯æ‰•ã„ã¯ã“ã“ã‹ã‚‰ç¢ºèªã—ã¾ã™ã€‚</p>
          <div id="dayLotteryResult">
            <p>ç¾åœ¨ã€æŠ½é¸çµæœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          </div>
        </div>

        <div class="card">
          <h2>å½“æ—¥æ”¯æ‰•ã„</h2>
          <p class="small muted">ç¾é‡‘ã¾ãŸã¯PayPayã§ã€é›†é‡‘æ‹…å½“è€…ã«æ”¯æ‰•ã£ã¦ãã ã•ã„ã€‚</p>
          <div class="paypay-box">
            <p style="font-weight:bold; color:var(--danger);">âš ï¸ æ”¯æ‰•ã£ãŸã‚‰å¿…ãšæ‹…å½“è€…ã«ç”»é¢ã‚’è¦‹ã›ã¦ãã ã•ã„</p>
            ID: <span id="ppIdDay">-</span> <button class="btn-outline copy-btn" onclick="copyText('ppIdDay')">ã‚³ãƒ”ãƒ¼</button><br>
            åç¾©: <span id="ppNameDay">-</span>
          </div>
        </div>
      </div>

      <div id="tab-ranking" class="page" style="display:none;">
        <div class="card">
          <h2>ä»Šæœˆã®å‚åŠ æ•°</h2>
          <table id="rankMonth"></table>
        </div>
        <div class="card">
          <h2>ä»Šå¹´ã®å‚åŠ æ•°</h2>
          <table id="rankYear"></table>
        </div>
      </div>

      <div id="tab-mypage" class="page" style="display:none;">
        <div class="card">
          <h2>ãƒ¡ãƒ³ãƒãƒ¼è¨­å®š</h2>
          <label>è¡¨ç¤ºå</label>
          <input type="text" id="myName">
          <label>åŒºåˆ†</label>
          <select id="myCat">
            <option value="adult">ç¤¾ä¼šäºº (800å††)</option>
            <option value="college">å¤§å­¦ç”Ÿ (600å††)</option>
            <option value="student">é«˜æ ¡ç”Ÿä»¥ä¸‹ (500å††)</option>
          </select>
          <button class="btn-primary" onclick="saveProfile()">ä¿å­˜ã™ã‚‹</button>
        </div>
        
        <div class="card" id="adminArea" style="display:none;">
          <h2 style="border-color:var(--danger);">ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
          <p class="small">æŠ½é¸ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>
          <select id="adminCourts"><option value="2">2ã‚³ãƒ¼ãƒˆ</option><option value="3" selected>3ã‚³ãƒ¼ãƒˆ</option></select>
          <button class="btn-danger" onclick="runLottery()">æŠ½é¸å®Ÿè¡Œ</button>
        </div>
      </div>

    </div>

    <div class="bottom-nav">
      <div class="nav-item active" onclick="switchTab('register')" id="nav-register">
        <span class="nav-icon">ğŸ“…</span>å‚åŠ ç™»éŒ²
      </div>
      <div class="nav-item" onclick="switchTab('day')" id="nav-day">
        <span class="nav-icon">ğŸ¸</span>å½“æ—¥ç”¨
      </div>
      <div class="nav-item" onclick="switchTab('ranking')" id="nav-ranking">
        <span class="nav-icon">ğŸ†</span>ãƒ©ãƒ³ã‚­ãƒ³ã‚°
      </div>
      <div class="nav-item" onclick="switchTab('mypage')" id="nav-mypage">
        <span class="nav-icon">ğŸ‘¤</span>ãƒã‚¤ãƒšãƒ¼ã‚¸
      </div>
    </div>
  </div>

  <script>
    // â–¼ GAS URLã‚’è¨­å®š â–¼
    const API_URL = 'https://script.google.com/macros/s/AKfycbx3QQMnnjQl-3bb77-HO9SVztNzaBpl8sXTHNBm7ydsLZMK50dlNqau-qHXU16HufrEBQ/exec';
    const LIFF_ID = '2008652596-Gew4K44V';

    // GASã‹ã‚‰æ¸¡ã•ã‚ŒãŸåˆæœŸãƒšãƒ¼ã‚¸ ('<?= initPage ?>' ã¯GASãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§å±•é–‹ã•ã‚Œã‚‹)
    const INIT_PAGE = '<?= initPage ?>';

    let state = {
      me: null,
      paypay: null,
      event: null,
      reg: null
    };

    window.onload = async () => {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      
      const profile = await liff.getProfile();
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
      const res = await callApi('get_me', { lineUserId: profile.userId });
      if (!res.exists) {
        // åˆå›ç™»éŒ²
        await callApi('upsert_member', { lineUserId: profile.userId, display_name: profile.displayName });
        const retry = await callApi('get_me', { lineUserId: profile.userId });
        state.me = retry.member;
      } else {
        state.me = res.member;
      }
      state.paypay = res.paypay_config;

      // ãƒã‚¤ãƒšãƒ¼ã‚¸åæ˜ 
      document.getElementById('myName').value = state.me.display_name;
      document.getElementById('myCat').value = state.me.category;
      if(state.me.role === 'admin' || state.me.role === 'sub_admin') {
        document.getElementById('adminArea').style.display = 'block';
      }

      // PayPayè¡¨ç¤º
      if(state.paypay) {
        ['ppId','ppIdDay'].forEach(id => document.getElementById(id).innerText = state.paypay.id);
        ['ppName','ppNameDay'].forEach(id => document.getElementById(id).innerText = state.paypay.receiver);
      }

      // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
      await loadThisWeek();
      loadFuture();
      loadPast();
      loadRankings();

      document.getElementById('loading').style.display = 'none';
      document.getElementById('app').style.display = 'block';

      // åˆæœŸã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      if(INIT_PAGE === 'day') switchTab('day');
      else if(INIT_PAGE === 'mypage') switchTab('mypage');
      else switchTab('register');
    };

    // --- API ---
    async function callApi(action, data, isPost=false) {
      let url = `${API_URL}?action=${action}`;
      let opts = { method: isPost?'POST':'GET' };
      if(isPost) opts.body = JSON.stringify(data);
      else if(data) Object.keys(data).forEach(k=> url += `&${k}=${encodeURIComponent(data[k])}`);
      const r = await fetch(url, opts);
      return await r.json();
    }

    // --- Tab ---
    window.switchTab = (page) => {
      document.querySelectorAll('.page').forEach(e => e.style.display='none');
      document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
      document.getElementById('tab-'+page).style.display = 'block';
      document.getElementById('nav-'+page).classList.add('active');
    };

    // --- Logic: Register ---
    async function loadThisWeek() {
      const res = await callApi('get_this_week');
      const box = document.getElementById('thisWeekInfo');
      const form = document.getElementById('regFormArea');
      
      if(!res.event) {
        box.innerHTML = '<p class="muted">ç¾åœ¨ã€å‹Ÿé›†ä¸­ã®ç·´ç¿’ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        form.style.display = 'none';
        return;
      }

      state.event = res.event;
      box.innerHTML = `
        <div style="font-weight:bold; font-size:1.1rem;">${state.event.date_str}</div>
        <div>${state.event.start_time} - ${state.event.end_time}</div>
        <div class="small muted">å®šå“¡: ${state.event.capacity_total}å</div>
      `;
      form.style.display = 'block';
      
      // ãƒ¡ãƒ¢æ¬„ã«æ—¥ä»˜ã¨åå‰ã‚’ã‚»ãƒƒãƒˆ
      document.getElementById('ppMsg').value = `${state.event.date_str} ${state.me.display_name}`;

      // è‡ªåˆ†ã®ç™»éŒ²çŠ¶æ³
      const myReg = await callApi('get_my_registration', { event_id: state.event.event_id, member_id: state.me.member_id });
      state.reg = myReg.registration;
      renderRegStatus();
    }

    function renderRegStatus() {
      const badge = document.getElementById('regStatusBadge');
      const btnReg = document.getElementById('btnRegister');
      const btnCancel = document.getElementById('btnCancel');
      const prePay = document.getElementById('prePaySection');

      if(state.reg && state.reg.status === 'reserved') {
        badge.innerText = 'å‚åŠ ç™»éŒ²æ¸ˆ';
        badge.className = 'badge bg-green';
        btnReg.innerText = 'ç™»éŒ²å†…å®¹ã‚’æ›´æ–°';
        btnCancel.style.display = 'inline-block';
        prePay.style.display = 'block';

        // æ”¯æ‰•ã„æ¸ˆã¿ãƒã‚§ãƒƒã‚¯
        if(state.reg.payment_status === 'paid' || state.reg.payment_status === 'paid_advance') {
           document.getElementById('chkPaid').checked = true;
           document.getElementById('chkPaid').disabled = true;
           document.getElementById('btnPayReport').innerText = 'æ”¯æ‰•ã„å ±å‘Šæ¸ˆã¿';
           document.getElementById('btnPayReport').disabled = true;
        }

        // ã‚²ã‚¹ãƒˆå¾©å…ƒ
        if(state.reg.guest_count > 0) {
          document.getElementById('friendToggle').checked = true;
          document.getElementById('guestSection').style.display = 'block';
          document.getElementById('guestCount').value = state.reg.guest_count;
          const container = document.getElementById('guestInputs');
          container.innerHTML = '';
          const guests = JSON.parse(state.reg.guest_info||'[]');
          guests.forEach((g,i) => container.appendChild(createGuestRow(i, g.name, g.category)));
        }

      } else {
        badge.innerText = 'æœªç™»éŒ²';
        badge.className = 'badge bg-gray';
        btnReg.innerText = 'å‚åŠ ç™»éŒ²ã™ã‚‹';
        btnCancel.style.display = 'none';
        prePay.style.display = 'none';
      }
      calcTotal();
    }

    // --- Logic: Guests & Fee ---
    window.toggleGuests = () => {
      const on = document.getElementById('friendToggle').checked;
      document.getElementById('guestSection').style.display = on?'block':'none';
      if(on && document.getElementById('guestCount').value==0) {
        document.getElementById('guestCount').value=1; renderGuestInputs();
      }
      calcTotal();
    };

    window.renderGuestInputs = () => {
      const cnt = document.getElementById('guestCount').value;
      const box = document.getElementById('guestInputs');
      box.innerHTML = '';
      for(let i=0; i<cnt; i++) box.appendChild(createGuestRow(i));
      calcTotal();
    };

    function createGuestRow(i, name='', cat='adult') {
      const d = document.createElement('div');
      d.className = 'guest-row';
      d.innerHTML = `
        <input type="text" class="g-name" placeholder="åå‰" value="${name}">
        <select class="g-cat" onchange="calcTotal()">
          <option value="adult" ${cat=='adult'?'selected':''}>ç¤¾ä¼šäºº</option>
          <option value="college" ${cat=='college'?'selected':''}>å¤§å­¦ç”Ÿ</option>
          <option value="student" ${cat=='student'?'selected':''}>é«˜æ ¡ç”Ÿ</option>
        </select>
      `;
      return d;
    }

    window.calcTotal = () => {
      let sum = getFee(state.me.category);
      if(document.getElementById('friendToggle').checked) {
        document.querySelectorAll('.g-cat').forEach(e => sum += getFee(e.value));
      }
      document.getElementById('feeDisplay').innerText = `æ”¯æ‰•äºˆå®š: ${sum} å††`;
    };
    function getFee(c){ return c=='adult'?800:c=='college'?600:500; }

    // --- Logic: Actions ---
    window.submitRegistration = async () => {
      if(!state.event) return;
      const guests = [];
      if(document.getElementById('friendToggle').checked) {
        const names = document.querySelectorAll('.g-name');
        const cats = document.querySelectorAll('.g-cat');
        for(let i=0; i<names.length; i++) {
          if(!names[i].value) { alert('ã‚²ã‚¹ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
          guests.push({name:names[i].value, category:cats[i].value});
        }
      }
      if(!confirm('ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ')) return;
      await callApi('register', {
        event_id: state.event.event_id, member_id: state.me.member_id,
        status: 'reserved', guests: guests
      }, true);
      alert('ç™»éŒ²ã—ã¾ã—ãŸ');
      location.reload();
    };

    window.cancelRegistration = async () => {
      if(!confirm('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
      await callApi('register', {
        event_id: state.event.event_id, member_id: state.me.member_id,
        status: 'canceled', guests: []
      }, true);
      alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
      location.reload();
    };

    window.reportPayment = async () => {
      if(!document.getElementById('chkPaid').checked) { alert('ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„'); return; }
      if(!confirm('PayPayã§ã®æ”¯æ‰•ã„ã‚’å ±å‘Šã—ã¾ã™ã‹ï¼Ÿ')) return;
      await callApi('pay_advance', { event_id: state.event.event_id, member_id: state.me.member_id }, true);
      alert('å ±å‘Šã—ã¾ã—ãŸ');
      location.reload();
    };

    window.saveProfile = async () => {
      const name = document.getElementById('myName').value;
      const cat = document.getElementById('myCat').value;
      if(!name) return;
      await callApi('upsert_member', { lineUserId: state.me.line_user_id, display_name: name, category: cat }, true);
      alert('ä¿å­˜ã—ã¾ã—ãŸ');
      location.reload();
    };

    window.runLottery = async () => {
      if(!confirm('æŠ½é¸å®Ÿè¡Œï¼Ÿ')) return;
      const c = document.getElementById('adminCourts').value;
      await callApi('run_lottery', { event_id: state.event.event_id, courts: c }, true);
      alert('å®Œäº†');
    };

    // --- Logic: Lists ---
    async function loadFuture() {
      const res = await callApi('get_future_events');
      const box = document.getElementById('futureList');
      if(!res.events.length) { box.innerText = 'äºˆå®šãªã—'; return; }
      box.innerHTML = res.events.map(e => 
        `<div style="border-bottom:1px solid #eee; padding:5px;">${e.date_str} ${e.start_time}-${e.end_time} (${e.status})</div>`
      ).join('');
    }

    async function loadPast() {
      const res = await callApi('get_past_events');
      const box = document.getElementById('pastList');
      if(!res.events.length) { box.innerText = 'å±¥æ­´ãªã—'; return; }
      box.innerHTML = res.events.map(e => 
        `<div style="border-bottom:1px solid #eee; padding:5px;">${e.date_str}</div>`
      ).join('');
    }

    async function loadRankings() {
      const res = await callApi('get_rankings');
      renderTable('rankMonth', res.data.month);
      renderTable('rankYear', res.data.year);
    }
    function renderTable(id, list) {
      const t = document.getElementById(id);
      t.innerHTML = list.map((r,i) => 
        `<tr><td style="width:30px;">${i+1}</td><td class="${i==0?'rank-1':''}">${r.name}</td><td style="text-align:right;">${i==0?r.month||r.year:r.month||r.year}å›</td></tr>`
      ).join('');
    }

    // --- Util ---
    window.copyText = (id) => {
      const t = document.getElementById(id).tagName==='INPUT' ? document.getElementById(id).value : document.getElementById(id).innerText;
      navigator.clipboard.writeText(t);
      alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: ' + t);
    };
  </script>
</body>
</html>