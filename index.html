<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>ゲヤマクラブ 参加登録</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
        color: #222;
        background: #f5f5f5;
      }
      body {
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 720px;
        margin: 0 auto;
        padding: 16px;
      }
      h1,
      h2,
      h3 {
        margin: 0 0 8px;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        align-items: baseline;
        margin-bottom: 8px;
      }
      .small {
        font-size: 0.85rem;
        color: #666;
      }
      label {
        display: block;
        margin: 6px 0;
        font-size: 0.9rem;
      }
      input[type='text'],
      input[type='number'],
      select {
        width: 100%;
        box-sizing: border-box;
        padding: 6px 8px;
        font-size: 0.95rem;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      button {
        border: none;
        border-radius: 999px;
        padding: 8px 14px;
        font-size: 0.9rem;
        cursor: pointer;
        background: #06c755;
        color: #fff;
      }
      button.secondary {
        background: #e0e0e0;
        color: #222;
        margin-left: 8px;
      }
      button:disabled {
        opacity: 0.6;
        cursor: default;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .row > div {
        flex: 1 1 120px;
      }
      .muted {
        color: #777;
        font-size: 0.9rem;
      }
      .status-text {
        margin: 6px 0 10px;
        font-size: 0.9rem;
      }
      .status-ok {
        color: #06c755;
      }
      .status-warn {
        color: #d35400;
      }
      .status-error {
        color: #e53935;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }
      th,
      td {
        padding: 6px 4px;
        border-bottom: 1px solid #eee;
        text-align: left;
      }
      th {
        font-weight: 600;
        white-space: nowrap;
      }
      tr:last-child td {
        border-bottom: none;
      }
      .pay-cell {
        white-space: nowrap;
      }
      .tag {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 999px;
        font-size: 0.75rem;
        border: 1px solid #ddd;
        color: #555;
      }
      .me-row {
        background: #e8f5e9;
      }
      /* initial loading overlay */
      #loading {
        position: fixed;
        inset: 0;
        background: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      #loading-inner {
        text-align: center;
        padding: 24px;
      }
      #loading-spinner {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 3px solid #ccc;
        border-top-color: #06c755;
        margin: 0 auto 12px;
        animation: spin 0.8s linear infinite;
      }
      /* busy overlay for user actions */
      #busyOverlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 998;
      }
      #busy-inner {
        background: #fff;
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        text-align: center;
        font-size: 0.9rem;
      }
      #busy-spinner {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 3px solid #ccc;
        border-top-color: #06c755;
        margin: 0 auto 8px;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      #app {
        display: none;
      }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  </head>
  <body>
    <!-- 初期ロード用 -->
    <div id="loading">
      <div id="loading-inner">
        <div id="loading-spinner"></div>
        <div id="loading-message">読み込み中です…</div>
      </div>
    </div>

    <!-- 操作中オーバーレイ -->
    <div id="busyOverlay">
      <div id="busy-inner">
        <div id="busy-spinner"></div>
        <div id="busy-message">処理中です…</div>
      </div>
    </div>

    <div id="app">
      <div class="container">
        <!-- ユーザー情報 -->
        <section class="card">
          <div class="card-header">
            <h1 style="font-size: 1.3rem">ゲヤマクラブ 参加ページ</h1>
            <div class="small" id="meInfo"></div>
          </div>
          <div class="muted" style="font-size: 0.85rem">
            LINE アカウントでログイン済みです。<br />
            ※UI は仮版です。機能が整ったら少しずつ見た目を整えます。
          </div>
        </section>

        <!-- 明日の練習 & 参加登録 -->
        <section class="card" id="eventCard">
          <div class="card-header">
            <h2 style="font-size: 1.15rem">明日の練習</h2>
            <div class="small" id="eventSummary"></div>
          </div>
          <div id="eventBody"></div>
        </section>

        <!-- 参加者一覧 & 支払状況 -->
        <section class="card" id="participantsCard" style="display: none">
          <div class="card-header">
            <h2 style="font-size: 1.05rem">参加者一覧・支払状況</h2>
            <div class="small" id="participantsSummary"></div>
          </div>
          <div id="participantsBody"></div>
        </section>

        <!-- 参加履歴 & ランキング -->
        <section class="card" id="historyCard" style="display: none">
          <div class="card-header">
            <h2 style="font-size: 1.05rem">参加履歴・ランキング</h2>
          </div>
          <div id="historyBody"></div>
        </section>
      </div>
    </div>

    <script>
      // ===== 設定 =====
      const LIFF_ID = '2008652596-Gew4K44V';
      const GAS_BASE_URL =
        'https://script.google.com/macros/s/AKfycbx3QQMnnjQl-3bb77-HO9SVztNzaBpl8sXTHNBm7ydsLZMK50dlNqau-qHXU16HufrEBQ/exec';

      const state = {
        me: null,
        upcomingEvent: null,
        myRegistration: null,
        participants: [],
        partStats: null,
        myHistory: [],
        ranking30: [],
        ranking365: [],
      };

      // ===== 共通 API ヘルパー =====
      async function callApi(action, params = {}, options = {}) {
        const method = options.method || 'GET';
        const allowError = !!options.allowError;

        const url = new URL(GAS_BASE_URL);
        url.searchParams.set('action', action);

        const fetchOptions = {};
        if (method === 'GET') {
          Object.entries(params).forEach(([k, v]) => {
            if (v !== undefined && v !== null) {
              url.searchParams.set(k, v);
            }
          });
        } else {
          const body = new URLSearchParams();
          Object.entries(params).forEach(([k, v]) => {
            if (v !== undefined && v !== null) {
              body.append(k, v);
            }
          });
          fetchOptions.method = 'POST';
          fetchOptions.headers = {
            'Content-Type': 'application/x-www-form-urlencoded',
          };
          fetchOptions.body = body.toString();
        }

        const res = await fetch(url.toString(), fetchOptions);
        if (!res.ok) {
          throw new Error('API HTTP error: ' + res.status);
        }
        const data = await res.json();
        if (!allowError && !data.ok) {
          throw new Error(data.error || 'API responded with error');
        }
        return data;
      }

      function setLoading(message) {
        const loading = document.getElementById('loading');
        const msgEl = document.getElementById('loading-message');
        if (loading) loading.style.display = 'flex';
        if (msgEl && message) msgEl.textContent = message;
        const app = document.getElementById('app');
        if (app) app.style.display = 'none';
      }

      function showApp() {
        const loading = document.getElementById('loading');
        if (loading) loading.style.display = 'none';
        const app = document.getElementById('app');
        if (app) app.style.display = 'block';
      }

      function setBusy(active, message) {
        const overlay = document.getElementById('busyOverlay');
        const msgEl = document.getElementById('busy-message');
        if (!overlay) return;
        if (active) {
          overlay.style.display = 'flex';
          if (msgEl && message) msgEl.textContent = message;
        } else {
          overlay.style.display = 'none';
        }
      }

      function formatDateLabel(dateStr) {
        if (!dateStr) return '';
        const [y, m, d] = dateStr.split('-').map((v) => parseInt(v, 10));
        if (!y || !m || !d) return dateStr;
        const dt = new Date(y, m - 1, d);
        const w = ['日', '月', '火', '水', '木', '金', '土'][dt.getDay()];
        return `${y}年${m}月${d}日(${w})`;
      }

      function formatCategoryLabel(cat) {
        switch (cat) {
          case 'adult':
            return '社会人';
          case 'univ':
          case 'college':
            return '大学生';
          case 'high':
            return '高校生';
          case 'junior':
            return '中学生';
          case 'elem':
            return '小学生';
          default:
            return cat || '';
        }
      }

      // ===== 初期化 =====
      async function initApp() {
        try {
          setLoading('LINE と連携中です…');

          await liff.init({ liffId: LIFF_ID });

          const profile = await liff.getProfile();
          const lineUserId = profile.userId;

          // メンバー情報取得 or 初回登録
          setLoading('メンバー情報を確認中です…');
          let meRes = await callApi('get_me', { lineUserId });
          if (!meRes.exists) {
            await callApi(
              'upsert_member',
              {
                line_user_id: lineUserId,
                display_name: profile.displayName || '',
                category: 'adult',
                paypay_display_name: '',
              },
              { method: 'POST' }
            );
            meRes = await callApi('get_me', { lineUserId });
          }
          state.me = meRes.member;

          // 明日のイベント取得
          setLoading('明日の練習を確認中です…');
          const eventsRes = await callApi('get_upcoming_events');
          const events = eventsRes.events || [];

          const today = new Date();
          const tomorrow = new Date(
            today.getFullYear(),
            today.getMonth(),
            today.getDate() + 1
          );
          const yyyy = tomorrow.getFullYear();
          const mm = String(tomorrow.getMonth() + 1).padStart(2, '0');
          const dd = String(tomorrow.getDate()).padStart(2, '0');
          const tomorrowStr = `${yyyy}-${mm}-${dd}`;

          let upcoming = null;
          for (const ev of events) {
            if (ev.date === tomorrowStr) {
              upcoming = ev;
              break;
            }
          }
          if (!upcoming && events.length > 0) {
            upcoming = events[0];
          }
          state.upcomingEvent = upcoming;

          if (upcoming && state.me) {
            // 自分の参加状況
            setLoading('参加状況を読み込み中です…');
            const regRes = await callApi('get_my_registration', {
              event_id: upcoming.event_id,
              member_id: state.me.member_id,
            });
            state.myRegistration = regRes.exists ? regRes.registration : null;

            // 参加者一覧
            setLoading('参加者一覧を読み込み中です…');
            const partRes = await callApi('get_event_participants', {
              event_id: upcoming.event_id,
            });
            if (partRes.ok) {
              state.participants = partRes.participants || [];
              state.partStats = partRes.stats || null;
            }
          }

          if (state.me) {
            // 参加履歴 & ランキング
            setLoading('参加履歴を読み込み中です…');
            const histRes = await callApi('get_my_history', {
              member_id: state.me.member_id,
              limit: 20,
            });
            if (histRes.ok) {
              state.myHistory = histRes.history || [];
            }

            const rank30 = await callApi('get_participation_ranking', {
              period_days: 30,
            });
            if (rank30.ok) {
              state.ranking30 = rank30.ranking || [];
            }

            const rank365 = await callApi('get_participation_ranking', {
              period_days: 365,
            });
            if (rank365.ok) {
              state.ranking365 = rank365.ranking || [];
            }
          }

          renderAll();
          showApp();
        } catch (err) {
          console.error(err);
          setLoading('エラーが発生しました: ' + err.message);
        }
      }

      // ===== 描画 =====
      function renderAll() {
        renderMe();
        renderEvent();
        renderParticipants();
        renderHistory();
      }

      function renderMe() {
        const el = document.getElementById('meInfo');
        if (!el) return;
        if (!state.me) {
          el.textContent = 'ログイン情報の取得に失敗しました';
          return;
        }
        const catLabel = formatCategoryLabel(state.me.category);
        el.textContent = `${state.me.display_name || ''}${
          catLabel ? '（' + catLabel + '）' : ''
        }`;
      }

      function renderEvent() {
        const summaryEl = document.getElementById('eventSummary');
        const bodyEl = document.getElementById('eventBody');
        if (!summaryEl || !bodyEl) return;
        const ev = state.upcomingEvent;

        if (!ev) {
          summaryEl.textContent = '明日の練習はありません。';
          bodyEl.innerHTML =
            '<p class="muted">開催予定がないか、まだスケジュールが登録されていません。</p>';
          return;
        }

        const dateLabel = formatDateLabel(ev.date);
        summaryEl.textContent = `${dateLabel} ${ev.start_time}〜${ev.end_time}`;

        const myReg = state.myRegistration;
        const isReserved = myReg && myReg.status === 'reserved';

        const statusClass = isReserved ? 'status-ok' : 'status-warn';
        const statusText = isReserved
          ? '現在：参加予定です'
          : '現在：未登録です';

        const guestCount = isReserved ? myReg.guest_count_requested || 0 : 0;
        const guestNames = isReserved ? myReg.guest_names_requested || '' : '';

        bodyEl.innerHTML = `
          <div class="status-text ${statusClass}">
            ${statusText}
          </div>
          <div class="muted" style="margin-bottom:8px;">
            場所：大津市立中央小学校 体育館<br/>
            参加費：社会人 800円 / 大学生 600円 / 高校生以下 500円（予定）
          </div>

          <div style="margin-bottom:12px;">
            <label>
              <input type="checkbox" id="friendToggle" ${
                guestCount > 0 ? 'checked' : ''
              } />
              友達も連れていく
            </label>
          </div>

          <div id="friendFields" style="margin-bottom:12px; ${
            guestCount > 0 ? '' : 'display:none;'
          }">
            <div class="row">
              <div>
                <label>友達の人数</label>
                <input type="number" id="guestCount" min="0" step="1" value="${guestCount}" />
              </div>
            </div>
            <label>友達の名前（カンマ区切り）</label>
            <input type="text" id="guestNames" placeholder="例：山田太郎, 佐藤花子" value="${guestNames}" />
          </div>

          <div>
            <button id="btnSubmitAttendance">
              ${isReserved ? '参加内容を更新する' : '参加登録する'}
            </button>
            <button id="btnCancelAttendance" class="secondary" ${
              isReserved ? '' : 'disabled'
            }>
              参加をキャンセル
            </button>
          </div>

          <div class="muted" style="margin-top:8px;font-size:0.85rem;">
            ・事前に PayPay で支払っても、当日現金で支払ってもOKです。<br/>
            ・事前にキャッシュレス支払いをしてから不参加になった場合は、後日返金対応します。<br/>
            ・友達の分の支払い方法は、今後運営で相談して決めていきます。
          </div>
        `;

        setupAttendanceHandlers();
      }

      function setupAttendanceHandlers() {
        const ev = state.upcomingEvent;
        const me = state.me;
        if (!ev || !me) return;

        const friendToggle = document.getElementById('friendToggle');
        const friendFields = document.getElementById('friendFields');
        const guestCountInput = document.getElementById('guestCount');
        const guestNamesInput = document.getElementById('guestNames');
        const btnSubmit = document.getElementById('btnSubmitAttendance');
        const btnCancel = document.getElementById('btnCancelAttendance');

        if (friendToggle && friendFields) {
          friendToggle.onchange = () => {
            friendFields.style.display = friendToggle.checked ? '' : 'none';
          };
        }

        if (btnSubmit) {
          btnSubmit.onclick = async () => {
            let guestCount = 0;
            let guestNames = '';

            if (friendToggle && friendToggle.checked) {
              const raw = guestCountInput.value.trim();
              const n = parseInt(raw || '0', 10);
              guestCount = isNaN(n) || n < 0 ? 0 : n;
              guestNames = guestNamesInput.value.trim();
            }

            setBusy(true, '参加内容を送信中です…');
            try {
              btnSubmit.disabled = true;
              btnCancel.disabled = true;

              const res = await callApi(
                'register_participation',
                {
                  event_id: ev.event_id,
                  member_id: me.member_id,
                  status: 'reserved',
                  guest_count_requested: guestCount,
                  guest_names_requested: guestNames,
                },
                { method: 'POST', allowError: true }
              );

              if (!res.ok) {
                if (res.error === 'CAPACITY_FULL') {
                  const dbg = res.debug || {};
                  alert(
                    '定員に達しているため参加登録できません。\n\n現在の人数: ' +
                      (dbg.reservedCount ?? '?') +
                      ' / 定員: ' +
                      (dbg.capacityTotal ?? '?')
                  );
                } else {
                  alert(
                    '参加登録に失敗しました: ' +
                      (res.message || res.error || '')
                  );
                }
                return;
              }

              state.myRegistration = {
                status: 'reserved',
                guest_count_requested: guestCount,
                guest_names_requested: guestNames,
              };

              const partRes = await callApi('get_event_participants', {
                event_id: ev.event_id,
              });
              if (partRes.ok) {
                state.participants = partRes.participants || [];
                state.partStats = partRes.stats || null;
              }

              // 履歴＆ランキングもついでに最新化（軽めの同期）
              if (state.me) {
                const histRes = await callApi('get_my_history', {
                  member_id: state.me.member_id,
                  limit: 20,
                });
                if (histRes.ok) {
                  state.myHistory = histRes.history || [];
                }
              }

              renderEvent();
              renderParticipants();
              renderHistory();
            } catch (err) {
              console.error(err);
              alert('参加登録に失敗しました: ' + err.message);
            } finally {
              btnSubmit.disabled = false;
              btnCancel.disabled =
                !state.myRegistration ||
                state.myRegistration.status !== 'reserved';
              setBusy(false);
            }
          };
        }

        if (btnCancel) {
          btnCancel.onclick = async () => {
            if (
              !state.myRegistration ||
              state.myRegistration.status !== 'reserved'
            ) {
              return;
            }
            if (!confirm('本当に参加をキャンセルしますか？')) return;

            setBusy(true, 'キャンセル処理中です…');
            try {
              btnSubmit.disabled = true;
              btnCancel.disabled = true;

              const res = await callApi(
                'register_participation',
                {
                  event_id: ev.event_id,
                  member_id: me.member_id,
                  status: 'canceled',
                },
                { method: 'POST', allowError: true }
              );

              if (!res.ok) {
                alert(
                  'キャンセルに失敗しました: ' +
                    (res.message || res.error || '')
                );
                return;
              }

              state.myRegistration = null;

              const partRes = await callApi('get_event_participants', {
                event_id: ev.event_id,
              });
              if (partRes.ok) {
                state.participants = partRes.participants || [];
                state.partStats = partRes.stats || null;
              }

              if (state.me) {
                const histRes = await callApi('get_my_history', {
                  member_id: state.me.member_id,
                  limit: 20,
                });
                if (histRes.ok) {
                  state.myHistory = histRes.history || [];
                }
              }

              renderEvent();
              renderParticipants();
              renderHistory();
            } catch (err) {
              console.error(err);
              alert('キャンセルに失敗しました: ' + err.message);
            } finally {
              btnSubmit.disabled = false;
              btnCancel.disabled =
                !state.myRegistration ||
                state.myRegistration.status !== 'reserved';
              setBusy(false);
            }
          };
        }
      }

      function renderParticipants() {
        const card = document.getElementById('participantsCard');
        const bodyEl = document.getElementById('participantsBody');
        const summaryEl = document.getElementById('participantsSummary');
        const ev = state.upcomingEvent;

        if (!card || !bodyEl || !summaryEl) return;

        if (!ev) {
          card.style.display = 'none';
          return;
        }

        card.style.display = 'block';

        const parts = state.participants || [];
        const stats = state.partStats || {};
        const reservedCount = stats.reservedCount ?? parts.length;
        const capacityTotal = stats.capacityTotal ?? null;
        const paidCount = stats.paidCount ?? 0;

        if (!parts.length) {
          summaryEl.textContent = 'まだ参加登録がありません。';
          bodyEl.innerHTML =
            '<p class="muted">参加登録するとここに一覧が表示されます。</p>';
          return;
        }

        let text = `参加者 ${reservedCount}人`;
        if (capacityTotal !== null) {
          text += ` / 定員 ${capacityTotal}人`;
        }
        text += `（支払い済 ${paidCount}人）`;
        summaryEl.textContent = text;

        const isManager =
          state.me &&
          (state.me.role === 'admin' || state.me.role === 'sub_admin');

        const rowsHtml = parts
          .slice()
          .sort((a, b) =>
            (a.display_name || '').localeCompare(b.display_name || 'ja')
          )
          .map((p) => {
            const catLabel = formatCategoryLabel(p.category);
            const guestLabel = p.guest_count_requested
              ? `${p.guest_count_requested}人 ${
                  p.guest_names_requested
                    ? '（' + p.guest_names_requested + '）'
                    : ''
                }`
              : '-';
            const checked = p.payment_status === 'paid';

            return `
              <tr>
                <td>${p.display_name || ''}</td>
                <td>${catLabel ? `<span class="tag">${catLabel}</span>` : ''}</td>
                <td>${guestLabel}</td>
                <td class="pay-cell">
                  <label>
                    <input type="checkbox"
                           class="pay-toggle"
                           data-member-id="${p.member_id}"
                           ${checked ? 'checked' : ''}
                           ${isManager ? '' : 'disabled'} />
                    支払い済
                  </label>
                </td>
              </tr>
            `;
          })
          .join('');

        bodyEl.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>名前</th>
                <th>区分</th>
                <th>友達</th>
                <th>支払い</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>
          ${
            !isManager
              ? '<p class="muted" style="margin-top:8px;font-size:0.8rem;">※支払い状況の更新は管理メンバーのみが行えます。</p>'
              : ''
          }
        `;

        if (isManager) {
          setupPaymentHandlers();
        }
      }

      function setupPaymentHandlers() {
        const ev = state.upcomingEvent;
        if (!ev) return;

        const checkboxes = document.querySelectorAll('.pay-toggle');
        checkboxes.forEach((cb) => {
          cb.onchange = async (e) => {
            const memberId = e.target.dataset.memberId;
            const checked = e.target.checked;

            setBusy(true, '支払状況を更新中です…');
            try {
              e.target.disabled = true;
              await callApi(
                'update_payment_status',
                {
                  event_id: ev.event_id,
                  member_id: memberId,
                  status: checked ? 'paid' : 'unpaid',
                },
                { method: 'POST' }
              );

              const partRes = await callApi('get_event_participants', {
                event_id: ev.event_id,
              });
              if (partRes.ok) {
                state.participants = partRes.participants || [];
                state.partStats = partRes.stats || null;
              }
              renderParticipants();
            } catch (err) {
              console.error(err);
              alert('支払状況の更新に失敗しました: ' + err.message);
              e.target.checked = !checked;
              e.target.disabled = false;
            } finally {
              setBusy(false);
            }
          };
        });
      }

      function renderHistory() {
        const card = document.getElementById('historyCard');
        const bodyEl = document.getElementById('historyBody');
        if (!card || !bodyEl) return;

        const hasHistory = state.myHistory && state.myHistory.length > 0;
        const hasRanking =
          (state.ranking30 && state.ranking30.length > 0) ||
          (state.ranking365 && state.ranking365.length > 0);

        if (!hasHistory && !hasRanking) {
          card.style.display = 'none';
          return;
        }

        card.style.display = 'block';

        let html = '';

        // 自分の参加履歴
        if (hasHistory) {
          html += `<h3 style="font-size:1rem;margin:0 0 4px;">最近の参加履歴</h3>`;
          html += `<ul style="list-style:none;padding-left:0;margin:0 0 12px;">`;
          state.myHistory.forEach((h) => {
            const label = formatDateLabel(h.date);
            const time =
              h.start_time && h.end_time
                ? `${h.start_time}〜${h.end_time}`
                : h.start_time || '';
            const guest =
              h.guest_count && h.guest_count > 0
                ? `（友達 ${h.guest_count}人）`
                : '';
            html += `<li class="muted" style="margin-bottom:2px;">${label} ${time} @ ${
              h.location || '大津市立中央小学校 体育館'
            } ${guest}</li>`;
          });
          html += `</ul>`;
        }

        // ランキングテーブル共通
        const meId = state.me && state.me.member_id;

        function buildRankingTable(ranking, title) {
          if (!ranking || !ranking.length) {
            return `
              <h3 style="font-size:1rem;margin:8px 0 4px;">${title}</h3>
              <p class="muted" style="margin:0 0 4px;">データがありません。</p>
            `;
          }
          let rows = '';
          ranking.slice(0, 10).forEach((r, idx) => {
            const isMe = r.member_id === meId;
            const catLabel = formatCategoryLabel(r.category);
            rows += `
              <tr class="${isMe ? 'me-row' : ''}">
                <td>${idx + 1}</td>
                <td>${r.display_name || ''}</td>
                <td>${catLabel || ''}</td>
                <td>${r.count}</td>
              </tr>
            `;
          });
          return `
            <h3 style="font-size:1rem;margin:8px 0 4px;">${title}</h3>
            <table style="margin-bottom:4px;">
              <thead>
                <tr>
                  <th>順位</th>
                  <th>名前</th>
                  <th>区分</th>
                  <th>参加回数</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          `;
        }

        html += buildRankingTable(
          state.ranking30,
          '参加回数ランキング（直近30日）'
        );
        html += buildRankingTable(
          state.ranking365,
          '参加回数ランキング（直近1年）'
        );

        html += `<p class="muted" style="margin-top:4px;font-size:0.8rem;">※自分の行は背景が薄い緑色で表示されます。</p>`;

        bodyEl.innerHTML = html;
      }

      // ===== 起動 =====
      window.addEventListener('load', () => {
        initApp();
      });
    </script>
  </body>
</html>
