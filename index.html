<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ã‚²ãƒ¤ãƒã‚¯ãƒ©ãƒ–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <style>
    :root { --primary: #06c755; --bg: #f2f4f8; --card: #ffffff; --text: #333; --danger: #e53935; --gray: #888; --accent: #ff9800; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
    .container { max-width: 600px; margin: 0 auto; padding: 15px; }
    
    /* ã‚«ãƒ¼ãƒ‰ */
    .card { background: var(--card); padding: 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-bottom: 16px; }
    h2 { font-size: 1.1rem; margin: 0 0 10px; border-bottom: 2px solid var(--primary); padding-bottom: 5px; display: inline-block; }
    h3 { font-size: 1rem; margin: 15px 0 8px; font-weight: bold; color: #444; }
    .muted { color: var(--gray); font-size: 0.85rem; line-height: 1.4; }
    .small { font-size: 0.8rem; }
    
    /* ãƒªã‚¢ãƒ«ãªã‚·ãƒ£ãƒˆãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(255,255,255,0.95); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .shuttle-svg { width: 60px; height: 60px; animation: arc 1.2s infinite ease-in-out; }
    @keyframes arc {
      0% { transform: translateY(20px) rotate(-20deg); }
      50% { transform: translateY(-40px) rotate(0deg); }
      100% { transform: translateY(20px) rotate(20deg); }
    }
    
    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; }
    .nav-item { flex: 1; text-align: center; padding: 10px 0; font-size: 0.7rem; color: var(--gray); cursor: pointer; }
    .nav-item.active { color: var(--primary); font-weight: bold; }
    .nav-icon { font-size: 1.5rem; display: block; margin-bottom: 2px; }
    
    /* ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ãƒœã‚¿ãƒ³ */
    input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px; font-size: 1rem; }
    button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 8px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 6px 12px; font-size: 0.9rem; }
    .btn-copy { padding: 4px 8px; font-size: 0.8rem; width: auto; margin: 0 0 0 8px; display: inline-block; }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
    .bg-green { background: #e8f5e9; color: #2e7d32; }
    .bg-gray { background: #eee; color: #666; }
    .bg-blue { background: #e3f2fd; color: #1565c0; }
    
    /* PayPayãƒ»é‹å–¶ */
    .paypay-box { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; border: 1px solid #eee; }
    .step-list { padding-left: 20px; font-size: 0.85rem; color: #444; line-height: 1.6; margin-bottom: 10px; }
    
    .admin-list-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 8px 0; }
    .pay-icon { font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }
    .pay-icon.pp { background: #ffeb3b; color: #333; } /* PayPay */
    .pay-icon.cash { background: #ddd; color: #333; } /* ç¾é‡‘ */
    
    #restrictedMsg { text-align: center; padding: 40px 0; color: #888; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div id="loading">
    <svg class="shuttle-svg" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M50 80C50 80 40 75 40 65H60C60 75 50 80 50 80Z" fill="#8d6e63"/> <path d="M40 65L25 20L35 15L42 60" fill="#eee" stroke="#ccc"/> <path d="M60 65L75 20L65 15L58 60" fill="#eee" stroke="#ccc"/>
      <path d="M50 65V15" stroke="#ccc" stroke-width="2"/>
      <path d="M35 15Q50 5 65 15" fill="none" stroke="#ddd"/>
    </svg>
    <div style="margin-top:15px; font-weight:bold; color:#06c755;">Loading...</div>
  </div>

  <div id="app" style="display:none;">
    <div class="container">
      
      <div id="tab-register" class="page">
        <div class="card">
          <h2>ä»Šé€±ã®ç·´ç¿’</h2>
          <div id="thisWeekInfo"><p class="muted">å‹Ÿé›†ä¸­ã®ç·´ç¿’ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p></div>
          <div id="regFormArea" style="display:none; margin-top:15px;">
            <div id="regStatusBadge" class="badge bg-gray" style="display:inline-block; margin-bottom:10px;">æœªç™»éŒ²</div>
            <div style="margin-bottom:15px; font-size:0.9rem;">
              <span class="muted">ç¾åœ¨ã®å‚åŠ è€…:</span> <span id="currentParticipantsCount">0</span>å
            </div>
            
            <form id="regForm">
              <label><input type="checkbox" id="friendToggle" onchange="toggleGuests()"> å‹é”ã‚’é€£ã‚Œã¦ã„ã</label>
              <div id="guestSection" style="display:none; background:#f9f9f9; padding:10px; border-radius:8px;">
                <label>äººæ•°: <input type="number" id="guestCount" min="0" max="5" value="0" onchange="renderGuestInputs()"></label>
                <div id="guestInputs"></div>
              </div>
              <div id="feeDisplay" style="text-align:center; font-weight:bold; color:var(--primary); margin:15px 0;">æ”¯æ‰•äºˆå®š: - å††</div>

              <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px;">
                <h3 style="margin-top:0;">ãŠæ”¯æ‰•ã„æ–¹æ³•</h3>
                <p class="muted small">é‹å–¶å††æ»‘åŒ–ã®ãŸã‚ã€PayPayäº‹å‰æ±ºæ¸ˆã«ã”å”åŠ›ãã ã•ã„ã€‚</p>

                <label style="margin-top:10px; display:flex; align-items:start;">
                  <input type="radio" name="payMethod" value="advance" onchange="togglePayMethod()" style="width:auto; margin-top:4px; margin-right:8px;">
                  <div><span style="font-weight:bold;">äº‹å‰PayPayæ±ºæ¸ˆ</span></div>
                </label>
                <div id="payDetail-advance" style="display:none; margin-left:25px;">
                   <div class="paypay-box">
                     <strong>&lt;æ‰‹é †&gt;</strong>
                     <ol class="step-list">
                       <li>ä¸‹è¨˜ã® <strong>PayPay ID</strong> ã‚’ã‚³ãƒ”ãƒ¼</li>
                       <li>PayPayã‚¢ãƒ—ãƒª >ã€Œé€ã‚‹ã€>ã€ŒIDã§é€ã‚‹ã€</li>
                       <li>IDã‚’è²¼ã‚Šä»˜ã‘ã¦æ¤œç´¢</li>
                       <li>åç¾© <strong class="ppNameTarget">-</strong> ã‚’ç¢ºèª</li>
                       <li>é‡‘é¡å…¥åŠ› (<strong>ãƒ¡ãƒ¢ã‚‚ã‚³ãƒ”ãƒšæ¨å¥¨</strong>)</li>
                       <li>é€é‡‘å®Œäº†å¾Œã€ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹</li>
                     </ol>
                     <div>ID: <span class="ppId" style="font-weight:bold;">-</span> <button type="button" class="btn-outline btn-copy" onclick="copyText('ppId')">ã‚³ãƒ”ãƒ¼</button></div>
                     <div style="margin-top:5px; display:flex;">
                       <input type="text" id="ppMsg" readonly style="margin:0; font-size:0.8rem; background:#fff; flex:1;">
                       <button type="button" class="btn-outline btn-copy" onclick="copyText('ppMsg')">ãƒ¡ãƒ¢ã‚³ãƒ”ãƒ¼</button>
                     </div>
                   </div>
                   <label style="margin-top:10px; color:var(--primary); font-weight:bold;">
                     <input type="checkbox" id="chkPaidAdvance" style="width:auto;"> é€é‡‘ã—ã¾ã—ãŸ
                   </label>
                </div>

                <label style="margin-top:15px; display:flex; align-items:start;">
                  <input type="radio" name="payMethod" value="day_paypay" onchange="togglePayMethod()" style="width:auto; margin-top:4px; margin-right:8px;">
                  <div><span style="font-weight:bold;">å½“æ—¥PayPayæ”¯æ‰•ã„</span></div>
                </label>
                <label style="margin-top:15px; display:flex; align-items:start;">
                  <input type="radio" name="payMethod" value="day_cash" onchange="togglePayMethod()" style="width:auto; margin-top:4px; margin-right:8px;">
                  <div><span style="font-weight:bold;">å½“æ—¥ç¾é‡‘æ”¯æ‰•ã„</span></div>
                </label>
              </div>

              <button type="button" id="btnRegister" class="btn-primary" onclick="submitRegistration()">å‚åŠ ç™»éŒ²ã™ã‚‹</button>
              <button type="button" id="btnCancel" class="btn-danger" style="display:none;" onclick="cancelRegistration()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </form>
          </div>
        </div>
      </div>

      <div id="tab-day" class="page" style="display:none;">
        <div id="dayContent" style="display:none;">
          <div id="subAdminArea" style="display:none;">
            <div class="card" style="border-left: 5px solid var(--danger);">
              <h3 style="color:var(--danger);">é‹å–¶: æŠ½é¸</h3>
              <p class="small muted">å‚åŠ çŠ¶æ³ã‚’ç¢ºèªã—ã¦æŠ½é¸ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>
              <div id="adminLotteryList"></div>
              <div style="margin-top:10px; display:flex; gap:10px;">
                <button class="btn-outline" style="font-size:0.8rem;" onclick="manualAddUser()">+ æ‰‹å‹•è¿½åŠ </button>
                <button class="btn-danger" style="flex:1;" onclick="executeLottery()">æŠ½é¸å®Ÿè¡Œ</button>
              </div>
              <div style="text-align:right; margin-top:10px;">
                <button class="btn-outline" style="font-size:0.8rem; color:#888; border-color:#ccc;" onclick="deleteLastRound()">ç›´å‰ã®å›ã‚’å–æ¶ˆ</button>
              </div>
            </div>
            
            <div class="card" style="border-left: 5px solid var(--accent);">
              <h3 style="color:var(--accent);">é‹å–¶: é›†é‡‘</h3>
              <p class="small muted">ãŠé‡‘ã‚’å—ã‘å–ã£ãŸã‚‰ãƒã‚§ãƒƒã‚¯ã—ã¦ä¿å­˜ã€‚<br><span class="pay-icon pp">P</span>PayPay <span class="pay-icon cash">ç¾</span>ç¾é‡‘</p>
              <div id="adminCollectionList"></div>
              <button class="btn-accent" onclick="saveCollection()">é›†é‡‘çŠ¶æ³ã‚’ä¿å­˜</button>
            </div>
          </div>

          <div class="card">
            <h2>æœ¬æ—¥ã®ç·´ç¿’</h2>
            <div id="dayLotteryResult"><p>æŠ½é¸çµæœã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p></div>
          </div>
          
          <div class="card" id="dayPayInfo" style="display:none;">
            <h2>å½“æ—¥PayPayæ”¯æ‰•ã„</h2>
            <div class="paypay-box">
              <strong>&lt;æ‰‹é †&gt;</strong>
              <ol class="step-list">
                <li>ID: <strong class="ppId">-</strong> ã‚’ã‚³ãƒ”ãƒ¼</li>
                <li>PayPayã‚¢ãƒ—ãƒªã§é€é‡‘</li>
                <li>åç¾© <strong class="ppNameTarget">-</strong> ã‚’ç¢ºèª</li>
                <li>é‡‘é¡ã‚’å…¥åŠ› (ãƒ¡ãƒ¢ã«åå‰ã‚’å…¥ã‚Œã‚‹)</li>
                <li><span style="color:red;font-weight:bold;">å®Œäº†ç”»é¢ã‚’é›†é‡‘æ‹…å½“è€…ã«è¦‹ã›ã¦å ±å‘Š</span></li>
              </ol>
              <div>ID: <span class="ppId" style="font-weight:bold;">-</span> <button class="btn-outline btn-copy" onclick="copyText('ppId')">ã‚³ãƒ”ãƒ¼</button></div>
            </div>
          </div>
        </div>
        
        <div id="restrictedMsg">
          <h3>æ™‚é–“å¤–ã§ã™</h3>
          <p>å½“æ—¥ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã€ç·´ç¿’æ—¥ã®<br>17:30 ã€œ 22:00 ã®é–“ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚</p>
        </div>
      </div>

      <div id="tab-ranking" class="page" style="display:none;">
        <div class="card"><h2>ä»Šæœˆã®å‚åŠ æ•°</h2><div id="rankMonth">Loading...</div></div>
      </div>

      <div id="tab-mypage" class="page" style="display:none;">
        <div class="card">
          <h2>è¨­å®š</h2>
          <label>è¡¨ç¤ºå</label><input type="text" id="myName">
          <label>åŒºåˆ†</label>
          <select id="myCat"><option value="adult">ç¤¾ä¼šäºº</option><option value="college">å¤§å­¦ç”Ÿ</option><option value="student">é«˜æ ¡ç”Ÿ</option></select>
          <button class="btn-primary" onclick="saveProfile()">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <div class="bottom-nav">
      <div class="nav-item active" onclick="switchTab('register')" id="nav-register"><span class="nav-icon">ğŸ“…</span>å‚åŠ ç™»éŒ²</div>
      <div class="nav-item" onclick="switchTab('day')" id="nav-day"><span class="nav-icon">ğŸ¸</span>å½“æ—¥ç”¨</div>
      <div class="nav-item" onclick="switchTab('ranking')" id="nav-ranking"><span class="nav-icon">ğŸ†</span>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
      <div class="nav-item" onclick="switchTab('mypage')" id="nav-mypage"><span class="nav-icon">ğŸ‘¤</span>ãƒã‚¤ãƒšãƒ¼ã‚¸</div>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbx3QQMnnjQl-3bb77-HO9SVztNzaBpl8sXTHNBm7ydsLZMK50dlNqau-qHXU16HufrEBQ/exec';
    const LIFF_ID = '2008652596-Gew4K44V';
    const params = new URLSearchParams(window.location.search);
    const INIT_PAGE = params.get('page') || 'register';

    let state = { me: null, paypay: null, event: null, reg: null, participants: [] };

    function setBusy(isBusy) { document.getElementById('loading').style.display = isBusy ? 'flex' : 'none'; }

    window.onload = async () => {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        
        const [userRes, weekRes] = await Promise.all([
          callApi('get_me', { lineUserId: profile.userId }),
          callApi('get_this_week')
        ]);

        if (!userRes.exists) {
          await callApi('upsert_member', { lineUserId: profile.userId, display_name: profile.displayName }, true);
          const retry = await callApi('get_me', { lineUserId: profile.userId });
          state.me = retry.member;
        } else { state.me = userRes.member; }
        state.paypay = userRes.paypay_config;

        if(state.me) {
          document.getElementById('myName').value = state.me.display_name;
          document.getElementById('myCat').value = state.me.category;
          if(['admin','sub_admin'].includes(state.me.role)) document.getElementById('subAdminArea').style.display = 'block';
        }
        if(state.paypay) {
          document.querySelectorAll('.ppId').forEach(e => e.innerText = state.paypay.id);
          document.querySelectorAll('.ppNameTarget').forEach(e => e.innerText = state.paypay.receiver);
        }

        if(weekRes.event) {
          state.event = weekRes.event;
          document.getElementById('thisWeekInfo').innerHTML = `<div>${state.event.date_str} ${state.event.start_time}-${state.event.end_time}</div>`;
          document.getElementById('regFormArea').style.display = 'block';
          document.getElementById('ppMsg').value = `${state.event.date_str} ${state.me.display_name}`;
          
          const myReg = await callApi('get_my_registration', { event_id: state.event.event_id, member_id: state.me.member_id });
          state.reg = myReg.registration;
          renderRegStatus();
        }

        setBusy(false);
        document.getElementById('app').style.display = 'block';
        switchTab(INIT_PAGE);

      } catch (err) { alert('èµ·å‹•ã‚¨ãƒ©ãƒ¼: ' + err.message); }
    };

    async function callApi(a, d, p=false) {
      let u = `${API_URL}?action=${a}`, o = { method: p?'POST':'GET' };
      if(p) { o.body = JSON.stringify(d); o.headers = {'Content-Type':'text/plain'}; }
      else if(d) Object.keys(d).forEach(k => u += `&${k}=${encodeURIComponent(d[k])}`);
      return await (await fetch(u, o)).json();
    }

    window.switchTab = (page) => {
      document.querySelectorAll('.page').forEach(e => e.style.display='none');
      document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
      document.getElementById('tab-'+page).style.display = 'block';
      document.getElementById('nav-'+page).classList.add('active');

      if(page === 'day') checkDayAccess();
      if(page === 'ranking') loadRankings();
    };

    // --- Day Logic ---
    function checkDayAccess() {
      if(!state.event) return;
      const now = new Date();
      const evDate = new Date(state.event.date); // "YYYY-MM-DD"
      // ç·´ç¿’æ—¥å½“æ—¥ã‹ï¼Ÿ
      if(now.toDateString() !== evDate.toDateString()) {
        // ãƒ‡ãƒ¢ç”¨ã‚„é–‹ç™ºä¸­ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ã‚‚è‰¯ã„
        // document.getElementById('dayContent').style.display = 'none';
        // document.getElementById('restrictedMsg').style.display = 'block';
        // return; 
      }
      
      const hh = now.getHours();
      const mm = now.getMinutes();
      const timeVal = hh * 60 + mm;
      // 17:30(1050) ~ 22:00(1320)
      if(timeVal >= 1050 && timeVal <= 1320) {
        document.getElementById('dayContent').style.display = 'block';
        document.getElementById('restrictedMsg').style.display = 'none';
        loadDayData();
      } else {
        // â˜…é–‹ç™ºä¸­ã«ã¤ãã€æœ¬æ¥ã¯éè¡¨ç¤ºã ãŒè¡¨ç¤ºã•ã›ã¦ãŠãå ´åˆã¯ã“ã“ã‚’èª¿æ•´
        document.getElementById('dayContent').style.display = 'block'; // æœ¬ç•ªã¯none
        document.getElementById('restrictedMsg').style.display = 'none'; // æœ¬ç•ªã¯block
        loadDayData();
      }
    }

    async function loadDayData() {
      const res = await callApi('get_participants_detail', { event_id: state.event.event_id });
      state.participants = res.data.participants || [];
      const result = res.data.lastResult;
      
      // æŠ½é¸çµæœ
      const box = document.getElementById('dayLotteryResult');
      if(result && result.courts) {
        let html = `<p style="font-weight:bold;">ç¬¬${res.data.currentRound}ãƒ©ã‚¦ãƒ³ãƒ‰</p>`;
        Object.keys(result.courts).forEach(k => {
          const c = result.courts[k];
          html += `<div style="background:#eee; padding:5px; margin:5px 0; border-radius:4px;">${k}<br>${c[0][0]},${c[0][1]} vs ${c[1][0]},${c[1][1]}</div>`;
        });
        if(result.rest && result.rest.length) html += `<div class="small muted">ä¼‘æ†©: ${result.rest.join(', ')}</div>`;
        box.innerHTML = html;
      }

      // å½“æ—¥æ‰•ã„è¡¨ç¤º (è‡ªåˆ†ãŒ day_paypay ã‹ã¤æœªæ‰•ã„ã®å ´åˆ)
      const myP = state.participants.find(p => p.member_id === state.me.member_id);
      if (myP && myP.payment_method === 'day_paypay' && myP.payment_status !== 'paid') {
        document.getElementById('dayPayInfo').style.display = 'block';
      } else {
        document.getElementById('dayPayInfo').style.display = 'none';
      }

      // SubAdmin
      if(['admin','sub_admin'].includes(state.me.role)) {
        renderAdminLists();
      }
    }

    function renderAdminLists() {
      // æŠ½é¸ãƒªã‚¹ãƒˆ
      const lBox = document.getElementById('adminLotteryList');
      lBox.innerHTML = state.participants.map(p => `
        <div class="admin-list-item">
          <div>${p.name} <span class="small muted">(${p.play_count}å›)</span></div>
          <select id="stat-${p.participant_id}" style="width:auto; padding:2px; margin:0;">
            <option value="participating" ${p.status=='participating'?'selected':''}>å‚åŠ </option>
            <option value="late" ${p.status=='late'?'selected':''}>é…åˆ»</option>
            <option value="leave" ${p.status=='leave'?'selected':''}>æ—©é€€</option>
            <option value="rest_request" ${p.status=='rest_request'?'selected':''}>ä¼‘æ†©</option>
          </select>
        </div>`).join('');

      // é›†é‡‘ãƒªã‚¹ãƒˆ
      const cBox = document.getElementById('adminCollectionList');
      cBox.innerHTML = state.participants.map(p => {
        const isPaid = p.payment_status === 'paid' || p.payment_status === 'paid_advance';
        const method = p.payment_method;
        let icon = '';
        if(method === 'advance' || method === 'day_paypay') icon = '<span class="pay-icon pp">P</span>';
        else icon = '<span class="pay-icon cash">ç¾</span>';
        
        return `<div class="admin-list-item ${isPaid?'muted':''}">
          <label style="flex:1; display:flex; align-items:center;">
            <input type="checkbox" class="col-chk" value="${p.member_id}" ${isPaid?'disabled checked':''}>
            <span style="margin-left:5px;">${icon}${p.name}</span>
          </label>
          <span class="small">${isPaid?'æ¸ˆ':p.payment_status}</span>
        </div>`;
      }).join('');
    }

    // --- Actions ---
    window.executeLottery = async () => {
      const stats = {};
      state.participants.forEach(p => {
        const val = document.getElementById(`stat-${p.participant_id}`).value;
        if(val !== p.status) stats[p.participant_id] = val;
      });
      if(!confirm('æŠ½é¸å®Ÿè¡Œï¼Ÿ')) return;
      setBusy(true);
      await callApi('run_lottery', { event_id: state.event.event_id, statuses: stats }, true);
      alert('å®Œäº†');
      loadDayData();
      setBusy(false);
    };

    window.saveCollection = async () => {
      const ids = [];
      document.querySelectorAll('.col-chk:checked:not([disabled])').forEach(e => ids.push(e.value));
      if(!ids.length) { alert('ãƒã‚§ãƒƒã‚¯ãªã—'); return; }
      if(!confirm(`${ids.length}åã®æ”¯æ‰•ã„ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      setBusy(true);
      await callApi('update_collection', { event_id: state.event.event_id, paid_ids: ids }, true);
      alert('ä¿å­˜ã—ã¾ã—ãŸ');
      loadDayData();
      setBusy(false);
    };

    window.deleteLastRound = async () => {
      if(!confirm('ç›´å‰ã®å›ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) return;
      await callApi('delete_round', { event_id: state.event.event_id });
      loadDayData();
    };

    window.manualAddUser = async () => {
      const name = prompt('åå‰:');
      if(name) await callApi('manual_add_participant', { event_id: state.event.event_id, name: name });
      loadDayData();
    };

    // --- Registration ---
    function renderRegStatus() {
      const badge = document.getElementById('regStatusBadge');
      const btnReg = document.getElementById('btnRegister');
      const btnCancel = document.getElementById('btnCancel');
      
      // å‚åŠ äººæ•°è¡¨ç¤º
      document.getElementById('currentParticipantsCount').innerText = state.reg && state.reg.guest_count ? 1 + state.reg.guest_count : 0; // ç°¡æ˜“

      if(state.reg && state.reg.status === 'reserved') {
        badge.innerText = 'å‚åŠ ç™»éŒ²æ¸ˆ';
        badge.className = 'badge bg-green';
        btnReg.innerText = 'ç™»éŒ²æ›´æ–°';
        btnCancel.style.display = 'inline-block';
        
        // æ”¯æ‰•ã„æ–¹æ³•å¾©å…ƒ
        const method = state.reg.payment_method;
        if(method) {
          const radio = document.querySelector(`input[name="payMethod"][value="${method}"]`);
          if(radio) radio.checked = true;
          if(method === 'advance' && state.reg.payment_status === 'paid_advance') {
            document.getElementById('chkPaidAdvance').checked = true;
            document.getElementById('chkPaidAdvance').disabled = true;
          }
        }
      } else {
        badge.innerText = 'æœªç™»éŒ²';
        badge.className = 'badge bg-gray';
        btnReg.innerText = 'å‚åŠ ç™»éŒ²';
        btnCancel.style.display = 'none';
      }
      togglePayMethod();
      calcTotal();
    }

    window.togglePayMethod = () => {
      const val = document.querySelector('input[name="payMethod"]:checked')?.value;
      document.getElementById('payDetail-advance').style.display = (val === 'advance') ? 'block' : 'none';
    };

    window.submitRegistration = async () => {
      const method = document.querySelector('input[name="payMethod"]:checked')?.value;
      if(!method) { alert('æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      
      let isPaid = false;
      if(method === 'advance') {
        if(!document.getElementById('chkPaidAdvance').checked) { alert('é€é‡‘å®Œäº†ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„'); return; }
        isPaid = true;
      }
      if(!confirm('ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ')) return;
      setBusy(true);
      await callApi('register', {
        event_id: state.event.event_id, member_id: state.me.member_id, status: 'reserved',
        guests: [], // ã‚²ã‚¹ãƒˆå®Ÿè£…çœç•¥(UIã¯ã‚ã‚‹ãŒ)
        is_paid: isPaid, pay_method: method
      }, true);
      alert('ç™»éŒ²ã—ã¾ã—ãŸ');
      location.reload();
    };

    // ä»–é–¢æ•°(toggleGuests, calcTotalç­‰)ã¯çœç•¥ã›ãšå®Ÿè£…æ¸ˆã¿ã¨ä»®å®š
    window.toggleGuests = () => {
        const on = document.getElementById('friendToggle').checked;
        document.getElementById('guestSection').style.display = on ? 'block' : 'none';
        if(on && document.getElementById('guestCount').value==0) {
            document.getElementById('guestCount').value = 1;
            renderGuestInputs();
        }
        calcTotal();
    };
    window.renderGuestInputs = () => {
        const cnt = document.getElementById('guestCount').value;
        const box = document.getElementById('guestInputs');
        box.innerHTML = '';
        // ç°¡æ˜“å®Ÿè£…
        for(let i=0; i<cnt; i++) {
            box.innerHTML += `<div class="guest-row"><input type="text" placeholder="åå‰"></div>`;
        }
        calcTotal();
    };
    window.calcTotal = () => {}; // æ–™é‡‘è¨ˆç®—
    window.saveProfile = async () => {}; // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜
    window.loadRankings = async () => {}; // ãƒ©ãƒ³ã‚­ãƒ³ã‚°
    window.copyText = (id) => {
        const t = document.getElementById(id) ? (document.getElementById(id).value || document.getElementById(id).innerText) : document.querySelector('.'+id).innerText;
        navigator.clipboard.writeText(t).then(()=>alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
    };
  </script>
</body>
</html>